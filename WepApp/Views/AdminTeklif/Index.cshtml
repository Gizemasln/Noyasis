@using WepApp.Models
@model dynamic
@{
    ViewData["Title"] = "Teklif Listesi";
    Layout = "~/Views/Shared/_LayoutWebAdmin.cshtml";
    var durumlar = ViewBag.TeklifDurumlari as List<TeklifDurum>;
    var teklifler = ViewBag.Teklifler as List<Teklif>;
}
<link href="https://cdnjs.cloudflare.com/ajax/libs/toastr.js/latest/toastr.min.css" rel="stylesheet" />

<style>
    /* CSS kodunuz aynı kalacak, sadece media query düzeltmesi yapıyorum */
    @@media (max-width: 768px) {
        .bilgilendirme-tercihleri, .musteri-bilgileri-grid {
            grid-template-columns: 1fr;
        }

        .aksiyon-btn {
            display: block;
            margin: 3px 0;
            width: 100%;
        }

        .table td, .table th {
            padding: 8px 5px;
            font-size: 0.75rem;
        }

        .durum-select {
            min-width: 110px;
            font-size: 0.7rem;
        }

        .card-header {
            flex-direction: column;
            gap: 10px;
        }

        .search-box {
            max-width: 100%;
        }
    }

    /* Diğer CSS kurallarınız aynı kalacak */
    .sozlesme-section {
        background: #fff;
        border-radius: 12px;
        padding: 20px;
        box-shadow: 0 1px 8px rgba(0,0,0,0.08);
        border: 1px solid #e0e0e0;
    }

        .sozlesme-section h6 {
            color: #2c3e50 !important;
            font-weight: 600;
            font-size: 1.05rem;
        }

        .sozlesme-section label {
            font-weight: 500;
            font-size: 0.85rem;
            margin-bottom: 5px;
            color: #495057;
        }

        .sozlesme-section .form-control,
        .sozlesme-section .form-select {
            font-size: 0.85rem;
            padding: 8px 12px;
            border-radius: 6px;
        }

            .sozlesme-section .form-control:disabled,
            .sozlesme-section .form-select:disabled {
                background-color: #e9ecef;
                opacity: 0.8;
            }

        .sozlesme-section .form-check {
            margin-bottom: 10px;
        }

        .sozlesme-section .form-check-input {
            width: 18px;
            height: 18px;
            margin-top: 0.2rem;
        }

        .sozlesme-section .form-check-label {
            font-size: 0.85rem;
            cursor: pointer;
        }

    .bilgilendirme-tercihleri {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
        gap: 10px;
    }

    .musteri-bilgileri-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
        gap: 15px;
    }

    .teklif-container {
        font-family: 'Segoe UI', Arial, sans-serif;
        background: #f8f9fa;
        min-height: calc(100vh - 80px);
        padding: 20px;
    }

    .card {
        border: none;
        border-radius: 10px;
        box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        margin-bottom: 20px;
        overflow: hidden;
    }

    .card-header {
        background: linear-gradient(135deg, #2e2e5d, #4a4a8a);
        color: white;
        padding: 15px 20px;
    }

    .table th {
        background: #f8f9fa;
        border-bottom: 2px solid #dee2e6;
        font-weight: 600;
        color: #2e2e5d;
        padding: 12px 8px;
        font-size: 0.85rem;
    }

    .table td {
        padding: 10px 8px;
        vertical-align: middle;
        font-size: 0.8rem;
        transition: all 0.3s ease;
    }

    .teklif-no {
        font-weight: 600;
        color: #2e2e5d;
    }

    .musteri-adi {
        font-weight: 500;
        color: #495057;
    }

    .tutar {
        font-weight: 600;
        color: #28a745;
    }

    .durum-select {
        font-size: 0.75rem;
        padding: 5px 8px;
        border-radius: 6px;
        min-width: 130px;
        cursor: pointer;
        border: 1px solid #ced4da;
        transition: all 0.2s;
        font-weight: 500;
    }

        .durum-select:disabled {
            opacity: 0.7;
            cursor: not-allowed;
        }

        .durum-select:focus {
            border-color: #86b7fe;
            box-shadow: 0 0 0 0.25rem rgba(13, 110, 253, 0.25);
            outline: none;
        }

    /* Durum 6: Kaybedildi - Gri */
    .satir-kaybedildi {
        background-color: #f8f9fa !important;
        border-left: 4px solid #6c757d;
    }

    /* Durum 7: Ertelendi - Turuncu */
    .satir-ertelendi {
        background-color: #fff3cd !important;
        border-left: 4px solid #ffc107;
    }

    /* Durum 2,3: Onaylandı/Muhasebelendi - Yeşil */
    .satir-onayli {
        background-color: #d4edda !important;
        border-left: 4px solid #28a745;
    }

    /* Durum 8: Muhasebelendi - Mavi */
    .satir-muhasebelendi {
        background-color: #d1ecf1 !important;
        border-left: 4px solid #17a2b8;
    }

    /* Durum 9: Sözleşmede - Mor */
    .satir-sozlesmede {
        background-color: #e6e6ff !important;
        border-left: 4px solid #6f42c1;
    }

    /* Durum 12: Arşiv - Koyu Gri */
    .satir-arsiv {
        background-color: #f1f3f4 !important;
        border-left: 4px solid #5f6368;
    }

    /* Durum stilleri */
    .durum-beklemede {
        background-color: #fff3cd !important;
        color: #856404 !important;
        border-color: #ffeaa7 !important;
    }

    .durum-onaylandi {
        background-color: #d4edda !important;
        color: #155724 !important;
        border-color: #c3e6cb !important;
    }

    .durum-muhasebelendi {
        background-color: #d1ecf1 !important;
        color: #0c5460 !important;
        border-color: #bee5eb !important;
    }

    .durum-sozlesmede {
        background-color: #e6e6ff !important;
        color: #6f42c1 !important;
        border-color: #d6d6ff !important;
    }

    .durum-ertelendi {
        background-color: #fff3cd !important;
        color: #856404 !important;
        border-color: #ffeaa7 !important;
    }

    .durum-kaybedildi {
        background-color: #f8f9fa !important;
        color: #6c757d !important;
        border-color: #e9ecef !important;
    }

    .durum-belirtilmemis {
        background-color: #f8f7da !important;
        color: #856404 !important;
        border-color: #f5f3c1 !important;
    }

    .durum-reddedildi {
        background-color: #f5c6cb !important;
        color: #721c24 !important;
        border-color: #f1b0b7 !important;
    }

    .durum-arsiv {
        background-color: #e9ecef !important;
        color: #495057 !important;
        border-color: #dee2e6 !important;
    }

    .durum-neden-bilgi {
        margin-top: 4px;
        font-size: 0.7rem;
    }

    .neden-badge {
        background-color: #e9ecef;
        color: #495057;
        padding: 2px 8px;
        border-radius: 12px;
        display: inline-block;
        max-width: 100%;
        overflow: hidden;
        text-overflow: ellipsis;
        white-space: nowrap;
        font-size: 0.7rem;
        border: 1px solid #dee2e6;
    }

    .aksiyon-btn {
        padding: 4px 8px;
        margin: 0 2px;
        font-size: 0.75rem;
        border-radius: 4px;
        transition: all 0.2s;
    }

        .aksiyon-btn:hover {
            transform: translateY(-1px);
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }

        .aksiyon-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

    .search-box {
        max-width: 300px;
    }

    .empty-state {
        text-align: center;
        padding: 40px;
        color: #6c757d;
    }

        .empty-state i {
            font-size: 3rem;
            margin-bottom: 15px;
            color: #dee2e6;
        }

    /* Loading spinner */
    .durum-loading {
        position: relative;
        opacity: 0.7;
    }

        .durum-loading::after {
            content: '';
            position: absolute;
            top: 50%;
            left: 50%;
            width: 16px;
            height: 16px;
            margin: -8px 0 0 -8px;
            border: 2px solid #007bff;
            border-top-color: transparent;
            border-radius: 50%;
            animation: spin 0.8s linear infinite;
        }

    @@keyframes spin {
        to {
            transform: rotate(360deg);
        }
    }

    /* Modal stilleri */
    .modal-neden-list {
        max-height: 300px;
        overflow-y: auto;
        border: 1px solid #dee2e6;
        border-radius: 5px;
        background-color: white;
    }

    .modal-neden-item {
        cursor: pointer;
        transition: all 0.2s;
        border-left: 4px solid transparent;
        padding: 12px 15px;
        margin: 0;
        border-bottom: 1px solid #f0f0f0;
    }

        .modal-neden-item:hover {
            background-color: #f8f9fa;
            border-left-color: #007bff;
        }

        .modal-neden-item.selected {
            background-color: #e7f3ff;
            border-left-color: #007bff;
        }

    .form-check-input {
        cursor: pointer;
        margin-top: 0.3rem;
    }

        .form-check-input:checked {
            background-color: #007bff;
            border-color: #007bff;
        }

    .form-check-label {
        font-size: 0.9rem;
        color: #444;
    }

    /* Tablo hücre stilleri */
    .durum-hucresi {
        min-width: 150px;
        max-width: 180px;
    }

    /* Durum 10: Revize - Sarı */
    .satir-revize {
        background-color: #fff8e1 !important;
        border-left: 4px solid #ffb300;
    }

    .durum-revize {
        background-color: #fff8e1 !important;
        color: #856404 !important;
        border-color: #ffeaa7 !important;
    }

    /* Yeni eklenen dosya yükleme stilleri */
    .dosya-yukleme-alani {
        display: none;
        padding: 10px;
        background-color: #f8f9fa;
        border-radius: 5px;
        margin-top: 5px;
        border: 1px dashed #dee2e6;
    }

        .dosya-yukleme-alani.active {
            display: block;
        }

    .dosya-input-group {
        margin-bottom: 10px;
    }

    .dosya-onizleme {
        max-width: 100%;
        max-height: 150px;
        margin-top: 10px;
        display: none;
    }

        .dosya-onizleme.active {
            display: block;
        }
</style>

<div class="teklif-container">
    <div class="container-fluid">
        <div class="row mb-4">
            <div class="col-12">
                <div class="d-flex justify-content-between align-items-center">
                    <h2 class="mb-0">Teklif Listesi</h2>
                    <a href="/AdminTeklifVer" class="btn btn-success">
                        <i class="fas fa-plus me-2"></i>Yeni Teklif Oluştur
                    </a>
                </div>
            </div>
        </div>

        <div class="row">
            <div class="col-12">
                <div class="card">
                    <div class="card-header d-flex justify-content-between align-items-center">
                        <h5 class="mb-0">Tüm Teklifler</h5>
                        <div class="search-box">
                            <div class="input-group input-group-sm">
                                <span class="input-group-text"><i class="fas fa-search"></i></span>
                                <input type="text" id="teklifArama" class="form-control" placeholder="Teklif no veya müşteri ara...">
                            </div>
                        </div>
                    </div>
                    <div class="card-body p-0">
                        <div class="table-responsive">
                            <table class="table table-hover mb-0">
                                <thead>
                                    <tr>
                                        <th width="150">Teklif No</th>
                                        <th width="180">Müşteri</th>
                                        <th width="150">Bayi</th>
                                        <th width="120">Lisans Tipi</th>
                                        <th width="110">Net Toplam</th>
                                        <th width="110">Oluşturulma Tarihi</th>
                                        <th width="110">Geçerlilik Tarihi</th>
                                        <th width="90" class="durum-hucresi">Durum</th>
                                        <th width="270" class="text-center">İşlemler</th>
                                    </tr>
                                </thead>
                                <tbody id="teklifTablosu">
                                    @if (teklifler != null && teklifler.Count > 0)
                                    {
                                        foreach (var teklif in teklifler)
                                        {
                                            var durumId = teklif.TeklifDurumId ?? 0;
                                            var satirCss = "";
                                            var durumCss = "";
                                            var durumAdi = teklif.TeklifDurum?.Adi ?? "Belirtilmemiş";

                                            // Satır CSS sınıfını belirle
                                            switch (durumId)
                                            {
                                                case 1: // Beklemede
                                                    satirCss = "";
                                                    durumCss = "durum-beklemede";
                                                    break;
                                                case 2: // Onaylandı
                                                case 3: // Onaylandı (varsayım)
                                                    satirCss = "satir-onayli";
                                                    durumCss = "durum-onaylandi";
                                                    break;
                                                case 4: // Reddedildi
                                                    satirCss = "";
                                                    durumCss = "durum-reddedildi";
                                                    break;
                                                case 5: // Kaybedildi
                                                    satirCss = "satir-kaybedildi";
                                                    durumCss = "durum-kaybedildi";
                                                    break;
                                                case 6: // Müşteri Onaylandı
                                                    satirCss = "satir-onayli";
                                                    durumCss = "durum-onaylandi";
                                                    break;
                                                case 7: // Ertelendi
                                                    satirCss = "satir-ertelendi";
                                                    durumCss = "durum-ertelendi";
                                                    break;
                                                case 8: // Muhasebelendi
                                                    satirCss = "satir-muhasebelendi";
                                                    durumCss = "durum-muhasebelendi";
                                                    break;
                                                case 9: // Sözleşmede
                                                    satirCss = "satir-sozlesmede";
                                                    durumCss = "durum-sozlesmede";
                                                    break;
                                                case 10: // Revize
                                                    satirCss = "satir-revize";
                                                    durumCss = "durum-revize";
                                                    break;
                                                case 12: // Arşiv
                                                    satirCss = "satir-arsiv";
                                                    durumCss = "durum-arsiv";
                                                    break;
                                                default:
                                                    satirCss = "";
                                                    durumCss = "durum-belirtilmemis";
                                                    break;
                                            }

                                            <tr data-teklif-id="@teklif.Id" class="@satirCss" data-durum-id="@durumId">
                                                <td><span class="teklif-no">@teklif.TeklifNo</span></td>
                                                <td>
                                                    @if (teklif.Musteri != null && teklif.Musteri.Id > 0)
                                                    {
                                                        <div class="musteri-adi">
                                                            <a href="javascript:void(0)"
                                                               onclick="musteriDuzenleAc(@teklif.Musteri.Id)"
                                                               class="text-primary text-decoration-none fw-medium"
                                                               style="cursor:pointer;">
                                                                @(teklif.Musteri.Ad + " " + (teklif.Musteri.Soyad ?? ""))
                                                            </a>
                                                        </div>
                                                        <small class="text-muted">@teklif.Musteri.Email</small>
                                                    }
                                                    else
                                                    {
                                                        <span class="text-muted">-</span>
                                                    }
                                                </td>
                                                <td>
                                                    <div class="musteri-adi">@(teklif.Musteri?.Bayi?.Unvan ?? "-")</div>
                                                    <small class="text-muted">@teklif.Musteri?.Bayi?.Telefon</small>
                                                </td>
                                                <td>@teklif.LisansTip?.Adi</td>
                                                <td class="tutar">@teklif.NetToplam.ToString("N2") ₺</td>
                                                <td><small>@teklif.EklenmeTarihi?.ToString("dd.MM.yyyy")</small></td>
                                                <td><small>@teklif.GecerlilikTarihi?.ToString("dd.MM.yyyy")</small></td>
                                                <td class="durum-hucresi">
                                                    @{
                                                        // DÜZELTME: Kaybedildi (5) hariç tutalım, diğerleri kilitli
                                                        var kilitliDurumlar = new List<int> { 8, 9, 10, 12 };
                                                    }

                                                    @if (kilitliDurumlar.Contains(durumId))
                                                    {
                                                        <!-- KİLİTLİ DURUMLAR (8, 9, 10, 12) -->
                                                        <select class="form-select form-select-sm durum-select @durumCss"
                                                                data-teklif-id="@teklif.Id"
                                                                data-current-durum="@durumId"
                                                                disabled
                                                                title="@durumAdi">
                                                            <option value="@durumId" selected>@durumAdi</option>
                                                        </select>
                                                    }
                                                    else if (durumId == 5)
                                                    {
                                                        <!-- KAYBEDİLDİ DURUMUNDA: GÖSTER AMA KİLİTLİ -->
                                                        <select class="form-select form-select-sm durum-select @durumCss"
                                                                data-teklif-id="@teklif.Id"
                                                                data-current-durum="@durumId"
                                                                disabled
                                                                title="@durumAdi">
                                                            <option value="@durumId" selected>@durumAdi</option>
                                                        </select>
                                                    }
                                                    else
                                                    {
                                                        <!-- DİĞER DURUMLARI GÖSTER -->
                                                        <!-- Sadece Muhasebelendi (8), Sözleşmede (9), Revize (10), Arşiv (12) hariç -->
                                                        <!-- KAYBEDİLDİ (5) ARTIK LİSTEDE GÖZÜKECEK -->
                                                        <select class="form-select form-select-sm durum-select @durumCss"
                                                                data-teklif-id="@teklif.Id"
                                                                data-current-durum="@durumId"
                                                                data-current-neden="@(teklif.NedenlerId ?? 0)"
                                                                title="@durumAdi">
                                                            @foreach (var d in durumlar.Where(d => !kilitliDurumlar.Contains(d.Id)))
                                                            {
                                                                <option value="@d.Id"
                                                                        data-durum-adi="@d.Adi"
                                                                @(durumId == d.Id ? "selected" : "")>
                                                                    @d.Adi
                                                                </option>
                                                            }
                                                        </select>
                                                    }

                                                    <!-- Neden bilgisi -->
                                                    @if (teklif.NedenlerId.HasValue && teklif.NedenlerId > 0 && teklif.Nedenler != null)
                                                    {
                                                        <div class="durum-neden-bilgi">
                                                            <span class="neden-badge" title="@teklif.Nedenler.Adi">@teklif.Nedenler.Adi</span>
                                                        </div>
                                                    }
                                                    @if (!string.IsNullOrEmpty(teklif.ErtelenmeNedeni))
                                                    {
                                                        <div class="durum-neden-bilgi">
                                                            <span class="neden-badge" title="@teklif.ErtelenmeNedeni">@teklif.ErtelenmeNedeni</span>
                                                        </div>
                                                    }
                                                </td>
                                                <td class="text-center">
                                                    @{
                                                        var kilitliDurumlarTabloda = new List<int> { 5, 8, 9, 10, 12 };
                                                    }

                                                    @if (kilitliDurumlarTabloda.Contains(durumId))
                                                    {
                                                        <!-- KİLİTLİ DURUMLARDA (5, 8, 9, 10, 12) -->
                                                        <!-- Kaybedildi durumunda -->
                                                        @if (durumId == 5)
                                                        {
                                                            <!-- Kaybedildi durumunda: PDF, Detay ve Sil butonları -->
                                                            <button class="btn btn-info btn-sm aksiyon-btn detay-goster"
                                                                    data-teklif-id="@teklif.Id"
                                                                    title="Detayları Gör">
                                                                <i class="fas fa-eye"></i>
                                                            </button>
                                                            <a href="/AdminTeklifVer/TeklifPdf?teklifId=@teklif.Id"
                                                               target="_blank"
                                                               class="btn btn-secondary btn-sm aksiyon-btn"
                                                               title="PDF İndir">
                                                                <i class="fas fa-file-pdf"></i>
                                                            </a>
                                                            <button class="btn btn-danger btn-sm aksiyon-btn sil-teklif"
                                                                    data-teklif-id="@teklif.Id"
                                                                    data-teklif-no="@teklif.TeklifNo"
                                                                    title="Sil">
                                                                <i class="fas fa-trash"></i>
                                                            </button>
                                                        }
                                                        else
                                                        {
                                                            <!-- Diğer kilitli durumlarda (8, 9, 10, 12): Sadece PDF ve Detay -->
                                                            <button class="btn btn-info btn-sm aksiyon-btn detay-goster"
                                                                    data-teklif-id="@teklif.Id"
                                                                    title="Detayları Gör">
                                                                <i class="fas fa-eye"></i>
                                                            </button>
                                                            <a href="/AdminTeklifVer/TeklifPdf?teklifId=@teklif.Id"
                                                               target="_blank"
                                                               class="btn btn-secondary btn-sm aksiyon-btn"
                                                               title="PDF İndir">
                                                                <i class="fas fa-file-pdf"></i>
                                                            </a>
                                                        }
                                                    }
                                                    else if (durumId == 6) // Müşteri Onaylandı durumunda
                                                    {
                                                        var aktifSozlesmeVarMi = ViewBag.TeklifIdAktifSozlesmeVar != null &&
                                                        ((HashSet<int>)ViewBag.TeklifIdAktifSozlesmeVar).Contains(teklif.Id);

                                                        <button class="btn btn-info btn-sm aksiyon-btn detay-goster"
                                                                data-teklif-id="@teklif.Id"
                                                                title="Detayları Gör">
                                                            <i class="fas fa-eye"></i>
                                                        </button>

                                                        @if (!aktifSozlesmeVarMi)
                                                        {
                                                            <!-- AKTİF SÖZLEŞME YOKSA SÖZLEŞME BUTONUNU GÖSTER -->
                                                            <button class="btn btn-success btn-sm aksiyon-btn sozlesme-btn"
                                                                    data-teklif-id="@teklif.Id"
                                                                    title="Sözleşme Oluştur">
                                                                <i class="fas fa-file-contract"></i>
                                                            </button>
                                                        }
                                                        else
                                                        {
                                                            <!-- AKTİF SÖZLEŞME VARSA SÖZLEŞME BUTONUNU GİZLE veya DISABLED YAP -->
                                                            <button class="btn btn-success btn-sm aksiyon-btn" disabled
                                                                    title="Bu teklif için aktif sözleşme mevcut">
                                                                <i class="fas fa-file-contract"></i>
                                                            </button>
                                                        }

                                                        <a href="/AdminTeklifVer/TeklifPdf?teklifId=@teklif.Id"
                                                           target="_blank"
                                                           class="btn btn-secondary btn-sm aksiyon-btn"
                                                           title="PDF İndir">
                                                            <i class="fas fa-file-pdf"></i>
                                                        </a>
                                                        <a href="/AdminTeklifVer?teklifId=@teklif.Id"
                                                           target="_blank"
                                                           class="btn btn-light btn-sm aksiyon-btn">
                                                            <i class="fas fa-edit"></i>
                                                        </a>

                                                        <button class="btn btn-danger btn-sm aksiyon-btn sil-teklif"
                                                                data-teklif-id="@teklif.Id"
                                                                data-teklif-no="@teklif.TeklifNo"
                                                                title="Sil">
                                                            <i class="fas fa-trash"></i>
                                                        </button>
                                                    }
                                                    else
                                                    {
                                                        <!-- NORMAL DURUMLARDA TÜM BUTONLAR (SÖZLEŞME BUTONU GİZLİ) -->
                                                        <button class="btn btn-info btn-sm aksiyon-btn detay-goster"
                                                                data-teklif-id="@teklif.Id"
                                                                title="Detayları Gör">
                                                            <i class="fas fa-eye"></i>
                                                        </button>
                                                        <a href="/AdminTeklifVer/TeklifPdf?teklifId=@teklif.Id"
                                                           target="_blank"
                                                           class="btn btn-secondary btn-sm aksiyon-btn"
                                                           title="PDF İndir">
                                                            <i class="fas fa-file-pdf"></i>
                                                        </a>
                                                        <a href="/AdminTeklifVer?teklifId=@teklif.Id"
                                                           target="_blank"
                                                           class="btn btn-light btn-sm aksiyon-btn">
                                                            <i class="fas fa-edit"></i>
                                                        </a>
                                                        <button class="btn btn-danger btn-sm aksiyon-btn sil-teklif"
                                                                data-teklif-id="@teklif.Id"
                                                                data-teklif-no="@teklif.TeklifNo"
                                                                title="Sil">
                                                            <i class="fas fa-trash"></i>
                                                        </button>
                                                    }
                                                </td>
                                            </tr>
                                        }
                                    }
                                    else
                                    {
                                        <tr>
                                            <td colspan="9" class="empty-state">
                                                <i class="fas fa-file-invoice"></i>
                                                <h5>Henüz teklif bulunmuyor</h5>
                                                <p>Yeni bir teklif oluşturmak için "Yeni Teklif Oluştur" butonuna tıklayın.</p>
                                            </td>
                                        </tr>
                                    }
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Teklif Detay Modal -->
<div class="modal fade" id="teklifDetayModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-fullscreen">
        <div class="modal-content">
            <div class="modal-header bg-primary text-white">
                <h5 class="modal-title">
                    <i class="fas fa-file-invoice-dollar me-2"></i>
                    Teklif Detayları
                </h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body" id="teklifDetayIcerik">
                <div class="text-center py-5">
                    <div class="spinner-border text-primary" role="status">
                        <span class="visually-hidden">Yükleniyor...</span>
                    </div>
                    <p class="mt-3">Teklif detayları yükleniyor...</p>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                    <i class="fas fa-times me-2"></i>Kapat
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Silme Onay Modal -->
<div class="modal fade" id="silModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header bg-danger text-white">
                <h5 class="modal-title">
                    <i class="fas fa-exclamation-triangle me-2"></i>
                    Teklif Silme
                </h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <p class="mb-2"><strong id="silinecekTeklifNo"></strong> numaralı teklifi silmek istediğinizden emin misiniz?</p>
                <p class="text-danger mb-0">
                    <small><i class="fas fa-info-circle me-1"></i> Bu işlem geri alınamaz.</small>
                </p>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                    <i class="fas fa-times me-2"></i>İptal
                </button>
                <button type="button" class="btn btn-danger" id="silBtn">
                    <i class="fas fa-trash me-2"></i>Sil
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Neden Seçim Modal -->
<div class="modal fade" id="nedenSecimModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-md">
        <div class="modal-content">
            <div class="modal-header bg-warning">
                <h5 class="modal-title">
                    <i class="fas fa-exclamation-circle me-2"></i>
                    Reddetme Nedenini Seçin
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <p class="mb-3">Lütfen teklifi reddetme nedenini seçin:</p>
                <div class="modal-neden-list" id="nedenListesi">
                    <!-- Nedenler buraya yüklenecek -->
                </div>
                <div class="alert alert-warning mt-3 mb-0">
                    <i class="fas fa-exclamation-triangle me-2"></i>
                    <small>Neden seçilmezse işlem iptal edilecektir.</small>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" id="nedenIptalBtn" data-bs-dismiss="modal">
                    <i class="fas fa-times me-2"></i>İptal
                </button>
                <button type="button" class="btn btn-primary" id="nedenKaydetBtn" disabled>
                    <i class="fas fa-check me-2"></i>Kaydet
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Ertelenme Nedeni Modal -->
<div class="modal fade" id="ertelenmeNedeniModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-md">
        <div class="modal-content">
            <div class="modal-header bg-warning">
                <h5 class="modal-title">
                    <i class="fas fa-clock me-2"></i>
                    Ertelenme Nedeni
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <p class="mb-3">Lütfen teklifi ertelenme nedenini girin:</p>
                <div class="form-group">
                    <textarea class="form-control" id="ertelenmeNedeniText" rows="4"
                              placeholder="Ertelenme nedenini detaylı şekilde açıklayın..."></textarea>
                    <small class="text-muted">Minimum 10 karakter girmelisiniz.</small>
                </div>
                <div class="alert alert-warning mt-3 mb-0">
                    <i class="fas fa-exclamation-triangle me-2"></i>
                    <small>Neden girilmezse işlem iptal edilecektir.</small>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" id="ertelenmeIptalBtn" data-bs-dismiss="modal">
                    <i class="fas fa-times me-2"></i>İptal
                </button>
                <button type="button" class="btn btn-primary" id="ertelenmeKaydetBtn" disabled>
                    <i class="fas fa-check me-2"></i>Kaydet
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Sözleşme Modal -->
<div class="modal fade" id="sozlesmeModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-fullscreen" style="padding: 50px;">
        <div class="modal-content">
            <div class="modal-header bg-primary text-white">
                <h5 class="modal-title">
                    <i class="fas fa-file-contract me-2"></i>
                    Sözleşme Oluştur
                </h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body" id="sozlesmeIcerik">
                <div class="text-center py-5">
                    <div class="spinner-border text-primary" role="status">
                        <span class="visually-hidden">Yükleniyor...</span>
                    </div>
                    <p class="mt-3">Sözleşme bilgileri yükleniyor...</p>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-success" id="sozlesmeKaydetBtn">
                    <i class="fas fa-save me-2"></i>Sözleşmeyi Gönder
                </button>
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                    <i class="fas fa-times me-2"></i>İptal
                </button>
            </div>

        </div>
    </div>
</div>

@section Script {
    <script src="https://cdnjs.cloudflare.com/ajax/libs/toastr.js/latest/toastr.min.js"></script>

    <script>
        let currentSozlesmeData = null;
        let isProcessing = false;
        let nedenlerCache = null;
        let currentSelect = null;
        let currentTeklifId = null;
        let currentEskiDurumId = null;

        $(document).ready(function () {
            // Sayfa yüklendiğinde kaybedildi durumundaki dropdown'ları kilitle
            $('.durum-select').each(function() {
                const durumId = parseInt($(this).data('current-durum'));

                // Kilitli durumlar listesi (5, 8, 9, 10, 12)
                const kilitliDurumlar = [5, 8, 9, 10, 12];

                if (kilitliDurumlar.includes(durumId)) {
                    // Kilitli durumda ise kilitle
                    $(this).prop('disabled', true)
                           .addClass('bg-light text-muted')
                           .css('cursor', 'not-allowed')
                           .attr('title', 'Bu durum kilitli');

                    // Sadece mevcut durumu göster
                    const durumAdi = $(this).find('option:selected').text();
                    $(this).html(`<option value="${durumId}" selected disabled>${durumAdi}</option>`);
                }
            });

            // Sözleşme butonu event'i
            $(document).on('click', '.sozlesme-btn', function() {
                const teklifId = $(this).data('teklif-id');
                sozlesmeModalAc(teklifId);
            });

            // Arama
            $('#teklifArama').on('input', function () {
                const term = $(this).val().toLowerCase().trim();
                $('#teklifTablosu tr').each(function () {
                    const $row = $(this);
                    if ($row.find('.teklif-no').length === 0 && !$row.hasClass('empty-state')) return;
                    const text = $row.text().toLowerCase();
                    $row.toggle(text.includes(term));
                });
            });

            // Durum değişikliği event'i
            $(document).on('change', '.durum-select', async function () {
                const $select = $(this);
                const teklifId = $select.data('teklif-id');
                const yeniDurumId = parseInt($select.val());
                const eskiDurumId = parseInt($select.data('current-durum'));

                // Kilitli durum kontrolü (5 hariç, çünkü 5 seçilebilmeli)
                const kilitliDurumlar = [8, 9, 10, 12];
                if (kilitliDurumlar.includes(eskiDurumId)) {
                    toastr.warning('Bu teklif kilitli durumda olduğu için durumu değiştirilemez.');
                    // Dropdown'u eski haline getir
                    setTimeout(() => {
                        $select.val(eskiDurumId);
                    }, 100);
                    return;
                }

                // Aynı durumu seçtiyse işlem yapma
                if (yeniDurumId === eskiDurumId) {
                    return;
                }

                // Durum değişikliği işlemi
                if (yeniDurumId === 5) { // Kaybedildi durumu
                    await handleKaybedildi($select, teklifId, eskiDurumId);
                } else if (yeniDurumId === 7) { // Ertelendi durumu
                    await handleErtelendi($select, teklifId, eskiDurumId);
                } else {
                    // Diğer durumlar için direkt güncelle
                    updateDurum($select, teklifId, yeniDurumId, null, eskiDurumId, '', '');
                }
            });

            // DETAY GÖSTER EVENT'İ
            $(document).on('click', '.detay-goster', function () {
                detaylariGetir($(this).data('teklif-id'));
            });

            // Silme butonu
            $(document).on('click', '.sil-teklif', function () {
                window.seciliTeklifId = $(this).data('teklif-id');
                $('#silinecekTeklifNo').text($(this).data('teklif-no'));
                new bootstrap.Modal('#silModal').show();
            });

            $('#silBtn').click(() => {
                if (window.seciliTeklifId) teklifSil(window.seciliTeklifId);
            });

            // Ertelenme nedeni textarea kontrolü
            $('#ertelenmeNedeniText').on('input', function() {
                const text = $(this).val().trim();
                $('#ertelenmeKaydetBtn').prop('disabled', text.length < 10);
            });

            // Nedenleri önbelleğe al
            loadNedenler();
        });

        // Sözleşme butonu tıklanmadan önce kontrol
        $(document).on('click', '.sozlesme-btn', async function() {
            const teklifId = $(this).data('teklif-id');
            const $btn = $(this);

            // Önce aktif sözleşme var mı kontrol et
            try {
                $btn.prop('disabled', true).html('<i class="fas fa-spinner fa-spin"></i>');

                const response = await $.get('/AdminTeklif/CheckAktifSozlesme', { teklifId: teklifId });

                if (response.success) {
                    if (response.aktifSozlesmeVar) {
                        // Aktif sözleşme varsa uyarı göster ve butonu kapat
                        toastr.warning('Bu teklife ait aktif bir sözleşme zaten mevcut. Yeni sözleşme oluşturamazsınız.');
                        $btn.hide();
                    } else {
                        // Aktif sözleşme yoksa modal aç
                        sozlesmeModalAc(teklifId);
                    }
                } else {
                    toastr.error(response.message || 'Kontrol sırasında hata oluştu.');
                }
            } catch (err) {
                console.error(err);
                toastr.error('Sunucu ile bağlantı kurulamadı.');
            } finally {
                $btn.prop('disabled', false).html('<i class="fas fa-file-contract"></i>');
            }
        });

        // Kaybedildi durumu için özel işlem
        async function handleKaybedildi($select, teklifId, eskiDurumId) {
            const nedenler = await loadNedenler();
            if (!nedenler || nedenler.length === 0) {
                toastr.error('Reddetme nedenleri yüklenemedi.');
                $select.val(eskiDurumId);
                return;
            }

            let selectedNedenId = 0;
            let selectedNedenAdi = '';

            const html = nedenler.map(n => `
                <div class="modal-neden-item p-3 border-bottom hover-bg-light" style="cursor:pointer" data-id="${n.id}">
                    <div class="form-check">
                        <input class="form-check-input" type="radio" name="neden" id="n${n.id}">
                        <label class="form-check-label fw-medium" for="n${n.id}">
                            ${n.adi}
                            <small class="text-muted d-block">Eklenme: ${n.eklenmeTarihi}</small>
                        </label>
                    </div>
                </div>
            `).join('');

            $('#nedenListesi').html(html);

            // Modal kapatıldığında eski duruma geri dön
            $('#nedenSecimModal').off('hidden.bs.modal').on('hidden.bs.modal', function () {
                $select.val(eskiDurumId);
                $('#nedenKaydetBtn').prop('disabled', true);
                $('.modal-neden-item').removeClass('selected bg-light');
            });

            $(document).off('click', '.modal-neden-item').on('click', '.modal-neden-item', function () {
                $('.modal-neden-item').removeClass('selected bg-light');
                $(this).addClass('selected bg-light');
                selectedNedenId = $(this).data('id');
                selectedNedenAdi = $(this).find('label').text().trim().split('\n')[0];
                $('#nedenKaydetBtn').prop('disabled', false);
            });

            $('#nedenKaydetBtn').off('click').on('click', () => {
                if (selectedNedenId === 0) {
                    toastr.warning('Lütfen bir neden seçin.');
                    return;
                }
                bootstrap.Modal.getInstance('#nedenSecimModal').hide();
                updateDurum($select, teklifId, 5, selectedNedenId, eskiDurumId, selectedNedenAdi, '');
            });

            // İptal butonuna tıklanınca eski duruma geri dön
            $('#nedenIptalBtn').off('click').on('click', function() {
                $select.val(eskiDurumId);
            });

            new bootstrap.Modal('#nedenSecimModal').show();
        }

        // Ertelendi durumu için özel işlem
        async function handleErtelendi($select, teklifId, eskiDurumId) {
            $('#ertelenmeNedeniText').val('');
            $('#ertelenmeKaydetBtn').prop('disabled', true);

            let iptalEdildi = true;

            $('#ertelenmeNedeniModal').off('hidden.bs.modal');

            $('#ertelenmeKaydetBtn').off('click').on('click', () => {
                const ertelenmeNedeni = $('#ertelenmeNedeniText').val().trim();
                if (ertelenmeNedeni.length < 10) {
                    toastr.warning('Lütfen en az 10 karakterlik bir neden girin.');
                    return;
                }

                iptalEdildi = false;
                bootstrap.Modal.getInstance('#ertelenmeNedeniModal').hide();
                updateDurum($select, teklifId, 7, null, eskiDurumId, '', ertelenmeNedeni);
            });

            $('#ertelenmeIptalBtn').off('click').on('click', () => {
                $select.val(eskiDurumId);
            });

            $('#ertelenmeNedeniModal').on('hidden.bs.modal', () => {
                if (iptalEdildi) {
                    $select.val(eskiDurumId);
                }
            });

            new bootstrap.Modal('#ertelenmeNedeniModal').show();
        }

        // Ana durum güncelleme fonksiyonu
        // Ana durum güncelleme fonksiyonu
        async function updateDurum($select, teklifId, yeniDurumId, nedenId = null, eskiDurumId, nedenAdi = '', ertelenmeNedeni = '') {
            try {
                const response = await $.ajax({
                    url: '/AdminTeklif/DurumDegistir',
                    type: 'POST',
                    data: {
                        id: teklifId,
                        durumId: yeniDurumId,
                        nedenId: nedenId || 0,
                        ertelenmeNedeni: ertelenmeNedeni || ''
                    },
                    dataType: 'json'
                });

                if (response.success) {
                    $select.val(yeniDurumId);
                    $select.data('current-durum', yeniDurumId);
                    $select.attr('title', response.yeniDurum || '');

                    const $row = $select.closest('tr');
                    $row.attr('data-durum-id', yeniDurumId);

                    // Tüm renk sınıflarını temizle
                    $row.removeClass('satir-onayli satir-muhasebelendi satir-sozlesmede satir-ertelendi satir-kaybedildi satir-arsiv satir-revize');
                    $select.removeClass('durum-beklemede durum-onaylandi durum-muhasebelendi durum-sozlesmede durum-ertelendi durum-kaybedildi durum-reddedildi durum-belirtilmemis durum-arsiv durum-revize');

                    // Yeni sınıfları ekle
                    const cssMap = {
                        1: { select: 'durum-beklemede' },
                        2: { row: 'satir-onayli', select: 'durum-onaylandi' },
                        3: { row: 'satir-onayli', select: 'durum-onaylandi' },
                        4: { select: 'durum-reddedildi' },
                        5: { row: 'satir-kaybedildi', select: 'durum-kaybedildi' },
                        6: { row: 'satir-onayli', select: 'durum-onaylandi' },
                        7: { row: 'satir-ertelendi', select: 'durum-ertelendi' },
                        8: { row: 'satir-muhasebelendi', select: 'durum-muhasebelendi' },
                        9: { row: 'satir-sozlesmede', select: 'durum-sozlesmede' },
                        10: { row: 'satir-revize', select: 'durum-revize' },
                        12: { row: 'satir-arsiv', select: 'durum-arsiv' }
                    };

                    const css = cssMap[yeniDurumId] || { select: 'durum-belirtilmemis' };
                    if (css.row) $row.addClass(css.row);
                    if (css.select) $select.addClass(css.select);

                    // Duruma göre butonları güncelle
                    updateActionButtons($row, yeniDurumId);

                    // Durum 5 (Kaybedildi) ise dropdown'u hemen kilitle
                    if (yeniDurumId === 5) {
                        // 1. Dropdown'u kilitle
                        $select.prop('disabled', true).addClass('bg-light text-muted').css('cursor', 'not-allowed');

                        // 2. Sadece "Kaybedildi" seçeneğini göster, diğerlerini kaldır
                        $select.html(`<option value="5" selected disabled>Kaybedildi</option>`);

                        // 3. Satırı güncelle
                        $row.addClass('satir-kaybedildi');

                        // 4. Mevcut durum adını bul ve göster
                        const durumAdi = $select.find('option:selected').text() || 'Kaybedildi';
                        $select.attr('title', durumAdi);

                        // 5. Güncellenen dropdown'u tabloda görmek için satırı yeniden oluştur
                        $row.find('.durum-select').replaceWith($select);
                    } else if (yeniDurumId === 8 || yeniDurumId === 9 || yeniDurumId === 10 || yeniDurumId === 12) {
                        // Diğer kilitli durumlar
                        $select.prop('disabled', true).addClass('bg-light text-muted').css('cursor', 'not-allowed');
                        $select.html(`<option value="${yeniDurumId}" selected disabled>${response.yeniDurum || 'Kilitli'}</option>`);
                    } else {
                        $select.prop('disabled', false).removeClass('bg-light text-muted').css('cursor', 'pointer');
                    }

                    // Neden/ertelenme nedeni göster
                    const $nedenDiv = $select.siblings('.durum-neden-bilgi');
                    $nedenDiv.remove(); // Önceki nedenleri temizle

                    if (yeniDurumId === 5 && nedenAdi) {
                        $select.after(`<div class="durum-neden-bilgi mt-2">
                            <span class="neden-badge" title="${nedenAdi}">${nedenAdi}</span>
                        </div>`);
                    } else if (yeniDurumId === 7 && ertelenmeNedeni) {
                        $select.after(`<div class="durum-neden-bilgi mt-2">
                            <span class="neden-badge" title="${ertelenmeNedeni}">${ertelenmeNedeni}</span>
                        </div>`);
                    }

                    toastr.success(response.message || `Durum "${response.yeniDurum}" olarak güncellendi.`);

                    // TÜM DURUM DEĞİŞİKLİKLERİNDEN SONRA SAYFAYI YENİLE
                    setTimeout(() => {
                        location.reload();
                    }, 1500); // 1.5 saniye gecikmeli sayfa yenileme (kullanıcı mesajı görebilsin)

                    // Durum 9 (Sözleşmede) ise 1 ay sonra Arşiv'e çekme zamanlayıcısı
                    if (yeniDurumId === 9) {
                        scheduleArchiveAfterOneMonth(teklifId);
                    }
                } else {
                    toastr.error(response.message || 'Durum güncellenemedi.');
                    $select.val(eskiDurumId);
                }
            } catch (err) {
                console.error('Hata:', err);
                toastr.error('Sunucu ile bağlantı kurulamadı.');
                $select.val(eskiDurumId);
            }
        }

        // Butonları duruma göre güncelle
        function updateActionButtons($row, durumId) {
           const $buttonsCell = $row.find('td:last-child');
           const teklifId = $row.data('teklif-id');
           const teklifNo = $row.find('.teklif-no').text();

           // Kilitli durumlar
           const kilitliDurumlar = [5, 8, 9, 10, 12];

           let buttonsHtml = '';

           // KİLİTLİ DURUMLAR (5, 8, 9, 10, 12)
           if (kilitliDurumlar.includes(durumId)) {
               // Kaybedildi durumunda
               if (durumId === 5) {
                   buttonsHtml = `
                       <!-- Kaybedildi durumunda: PDF, Detay ve Sil butonları -->
                       <button class="btn btn-info btn-sm aksiyon-btn detay-goster"
                               data-teklif-id="${teklifId}"
                               title="Detayları Gör">
                           <i class="fas fa-eye"></i>
                       </button>
                       <a href="/AdminTeklifVer/TeklifPdf?teklifId=${teklifId}"
                          target="_blank"
                          class="btn btn-secondary btn-sm aksiyon-btn"
                          title="PDF İndir">
                           <i class="fas fa-file-pdf"></i>
                       </a>
                       <button class="btn btn-danger btn-sm aksiyon-btn sil-teklif"
                               data-teklif-id="${teklifId}"
                               data-teklif-no="${teklifNo}"
                               title="Sil">
                           <i class="fas fa-trash"></i>
                       </button>`;
               } else {
                   // Diğer kilitli durumlarda (8, 9, 10, 12): Sadece PDF ve Detay
                   buttonsHtml = `
                       <!-- Sadece PDF ve detay butonları -->
                       <button class="btn btn-info btn-sm aksiyon-btn detay-goster"
                               data-teklif-id="${teklifId}"
                               title="Detayları Gör">
                           <i class="fas fa-eye"></i>
                       </button>
                       <a href="/AdminTeklifVer/TeklifPdf?teklifId=${teklifId}"
                          target="_blank"
                          class="btn btn-secondary btn-sm aksiyon-btn"
                          title="PDF İndir">
                           <i class="fas fa-file-pdf"></i>
                       </a>`;
               }
           } else if (durumId === 6) { // Müşteri Onaylandı
                buttonsHtml = `
                    <button class="btn btn-info btn-sm aksiyon-btn detay-goster"
                            data-teklif-id="${teklifId}"
                            title="Detayları Gör">
                        <i class="fas fa-eye"></i>
                    </button>
                    <button class="btn btn-success btn-sm aksiyon-btn sozlesme-btn"
                            data-teklif-id="${teklifId}"
                            title="Sözleşme Oluştur">
                        <i class="fas fa-file-contract"></i>
                    </button>
                    <a href="/AdminTeklifVer/TeklifPdf?teklifId=${teklifId}"
                       target="_blank"
                       class="btn btn-secondary btn-sm aksiyon-btn"
                       title="PDF İndir">
                        <i class="fas fa-file-pdf"></i>
                    </a>
                    <a href="/AdminTeklifVer?teklifId=${teklifId}"
                       target="_blank"
                       class="btn btn-light btn-sm aksiyon-btn">
                        <i class="fas fa-edit"></i>
                    </a>
                    <button class="btn btn-danger btn-sm aksiyon-btn sil-teklif"
                            data-teklif-id="${teklifId}"
                            data-teklif-no="${teklifNo}"
                            title="Sil">
                        <i class="fas fa-trash"></i>
                    </button>`;
            } else { // Diğer durumlar
                buttonsHtml = `
                    <button class="btn btn-info btn-sm aksiyon-btn detay-goster"
                            data-teklif-id="${teklifId}"
                            title="Detayları Gör">
                        <i class="fas fa-eye"></i>
                    </button>
                    <a href="/AdminTeklifVer/TeklifPdf?teklifId=${teklifId}"
                       target="_blank"
                       class="btn btn-secondary btn-sm aksiyon-btn"
                       title="PDF İndir">
                        <i class="fas fa-file-pdf"></i>
                    </a>
                    <a href="/AdminTeklifVer?teklifId=${teklifId}"
                       target="_blank"
                       class="btn btn-light btn-sm aksiyon-btn">
                        <i class="fas fa-edit"></i>
                    </a>
                    <button class="btn btn-danger btn-sm aksiyon-btn sil-teklif"
                            data-teklif-id="${teklifId}"
                            data-teklif-no="${teklifNo}"
                            title="Sil">
                        <i class="fas fa-trash"></i>
                    </button>`;
            }

            $buttonsCell.html(buttonsHtml);
        }

        // Sözleşmeden 1 ay sonra Arşiv'e çekme fonksiyonu
        function scheduleArchiveAfterOneMonth(teklifId) {
            console.log(`Teklif ${teklifId} için 1 ay sonra Arşiv kontrolü yapılacak`);
        }

        // Nedenleri yükle (önbellekli)
        async function loadNedenler() {
            if (nedenlerCache) return nedenlerCache;

            try {
                const res = await fetch('/AdminTeklif/GetirNedenler');
                const data = await res.json();
                if (data.success && data.nedenler) {
                    nedenlerCache = data.nedenler;
                    return data.nedenler;
                }
            } catch (e) {
                console.error('Nedenler yüklenemedi:', e);
            }
            return [];
        }

        // Teklif detaylarını getir
        async function detaylariGetir(id) {
            try {
                $('#teklifDetayIcerik').html(`
                    <div class="text-center py-5">
                        <div class="spinner-border text-primary" role="status"></div>
                        <p class="mt-3">Teklif detayları yükleniyor...</p>
                    </div>
                `);
                new bootstrap.Modal('#teklifDetayModal').show();

                const response = await $.get('/AdminTeklif/GetirTeklifDetay', { id: id });

                if (response.success) {
                    const t = response.teklif;
                    let html = `
                        <div class="row mb-4">
                            <div class="col-md-6">
                                <div class="card border-0 shadow-sm mb-3">
                                    <div class="card-header bg-light"><h6 class="mb-0">Teklif Bilgileri</h6></div>
                                    <div class="card-body">
                                        <table class="table table-sm table-borderless mb-0">
                                            <tr><td class="text-muted">Teklif No:</td><td><strong>${t.teklifNo}</strong></td></tr>
                                            <tr><td class="text-muted">Müşteri:</td><td>${t.musteriAdi || '-'}</td></tr>
                                            <tr><td class="text-muted">Telefon:</td><td>${t.musteriTelefon || '-'}</td></tr>
                                            <tr><td class="text-muted">E-posta:</td><td>${t.musteriEmail || '-'}</td></tr>
                                            <tr><td class="text-muted">Lisans Tipi:</td><td>${t.lisansTipi || '-'}</td></tr>
                                            <tr><td class="text-muted">Durum:</td><td><span class="badge ${getDurumBadgeCss(t.durumId)}">${t.durumAdi}</span></td></tr>
                                            ${t.nedenAdi ? `<tr><td class="text-muted">Kaybedilme Nedeni:</td><td><span class="badge bg-secondary">${t.nedenAdi}</span></td></tr>` : ''}
                                            ${t.ertelenmeNedeni ? `<tr><td class="text-muted">Ertelenme Nedeni:</td><td><span class="badge bg-warning">${t.ertelenmeNedeni}</span></td></tr>` : ''}
                                        </table>
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="card border-0 shadow-sm">
                                    <div class="card-header bg-light"><h6 class="mb-0">Fiyat Bilgileri</h6></div>
                                    <div class="card-body">
                                        <table class="table table-sm table-borderless mb-0">
                                            <tr><td class="text-muted">Net Toplam:</td><td><strong class="text-success">${formatTutar(t.netToplam)} ₺</strong></td></tr>
                                            <tr><td class="text-muted">KDV Tutarı:</td><td>${formatTutar(t.kdvTutari)} ₺</td></tr>
                                            <tr><td class="text-muted">Ara Toplam:</td><td>${formatTutar(t.araToplam)} ₺</td></tr>
                                            <tr><td class="text-muted">Toplam İndirim:</td><td class="text-danger">${formatTutar(t.toplamIndirim)} ₺</td></tr>
                                        </table>
                                    </div>
                                </div>
                            </div>
                        </div>`;

                    if (response.detaylar && response.detaylar.length > 0) {
                        html += `<div class="card border-0 shadow-sm mt-3">
                            <div class="card-header bg-light"><h6 class="mb-0">Teklif Kalemleri (${response.detaylar.length})</h6></div>
                            <div class="card-body p-0">
                                <div class="table-responsive">
                                    <table class="table table-sm table-hover mb-0">
                                        <thead class="table-light">
                                            <tr>
                                                <th>#</th><th>Tip</th><th>Paket/Grup</th><th>Modül</th>
                                                <th>Miktar</th><th>Liste</th><th>Kampanya</th><th>Net</th><th>Toplam</th>
                                            </tr>
                                        </thead>
                                        <tbody>`;
                        response.detaylar.forEach((d, i) => {
                            const kampanya = d.kampanyaFiyati ? `${formatTutar(d.kampanyaFiyati)} ₺ (${d.kampanyaIndirimYuzdesi}%)` : '-';
                            html += `<tr>
                                <td>${i + 1}</td>
                                <td><span class="badge bg-secondary">${d.tip || '-'}</span></td>
                                <td>${d.paketGrupAdi || '-'}</td>
                                <td>${d.itemAdi || '-'} ${d.bagimsizModulMu ? '<span class="badge bg-info ms-1">Bağımsız</span>' : ''}</td>
                                <td class="text-center">${d.miktar || 1}</td>
                                <td class="text-end">${formatTutar(d.listeFiyati)} ₺</td>
                                <td class="text-end">${kampanya}</td>
                                <td class="text-end">${formatTutar(d.birimFiyatNet)} ₺</td>
                                <td class="text-end"><strong>${formatTutar(d.satirToplamNet)} ₺</strong></td>
                            </tr>`;
                        });
                        html += `</tbody></table></div></div></div>`;
                    }

                    if (t.aciklama) {
                        html += `<div class="card border-0 shadow-sm mt-3">
                            <div class="card-header bg-light"><h6 class="mb-0">Açıklama</h6></div>
                            <div class="card-body"><p class="mb-0">${t.aciklama}</p></div>
                        </div>`;
                    }

                    html += `<div class="row mt-3 text-muted small">
                        <div class="col-6">Oluşturulma: ${t.olusturmaTarihi || '-'}</div>
                        <div class="col-6 text-end">Geçerlilik: ${t.gecerlilikTarihi || '-'}</div>
                    </div>`;

                    $('#teklifDetayIcerik').html(html);
                } else {
                    $('#teklifDetayIcerik').html(`<div class="alert alert-danger">${response.message}</div>`);
                }
            } catch (err) {
                $('#teklifDetayIcerik').html('<div class="alert alert-danger">Teklif detayları yüklenirken hata oluştu.</div>');
            }
        }

        async function teklifSil(id) {
            try {
                // Butonu kilitle ve yükleniyor durumuna getir
                $('#silBtn').prop('disabled', true).html('<i class="fas fa-spinner fa-spin me-2"></i>Siliniyor...');

                // AJAX çağrısı
                const response = await $.ajax({
                    url: '/AdminTeklif/SilTeklif',
                    type: 'POST',
                    data: { id: id },
                    dataType: 'json'
                });

                if (response.success) {
                    // Başarılı mesaj göster
                    toastr.success(response.message);

                    // Modal'ı kapat
                    const modal = bootstrap.Modal.getInstance(document.getElementById('silModal'));
                    if (modal) {
                        modal.hide();
                    }

                    // Kısa bir gecikme ile sayfayı yenile (kullanıcı mesajı görsün diye)
                    setTimeout(() => {
                        location.reload();
                    }, 1500);
                } else {
                    toastr.error(response.message);
                    // Butonu tekrar aktif et
                    $('#silBtn').prop('disabled', false).html('<i class="fas fa-trash me-2"></i>Sil');
                }
            } catch (error) {
                console.error('Silme hatası:', error);
                if (error.status === 401) {
                    toastr.error('Oturum süresi doldu. Lütfen tekrar giriş yapın.');
                } else if (error.status === 404) {
                    toastr.error('Teklif bulunamadı.');
                } else {
                    toastr.error('Sunucu ile bağlantı kurulamadı.');
                }
                // Hata durumunda butonu tekrar aktif et
                $('#silBtn').prop('disabled', false).html('<i class="fas fa-trash me-2"></i>Sil');
            }
        }

        async function sozlesmeModalAc(teklifId) {
            try {
                const modal = new bootstrap.Modal('#sozlesmeModal');
                modal.show();

                $('#sozlesmeIcerik').html(`
                    <div class="text-center py-5">
                        <div class="spinner-border text-primary" role="status"></div>
                        <p class="mt-3">Sözleşme bilgileri yükleniyor...</p>
                    </div>
                `);

                const response = await $.get('/AdminTeklif/GetirSozlesmeBilgileri', { teklifId: teklifId });

                if (response.success) {
                    currentSozlesmeData = response.data;
                    const html = sozlesmeFormHTML(response.data);
                    $('#sozlesmeIcerik').html(html);

                    // UYB bilgilerini güncelle
                    if (response.data.uybTutari && response.data.uybOrani && response.data.tutarKdvsiz) {
                        updateUYBBilgi(
                            response.data.tutarKdvsiz,
                            response.data.uybOrani,
                            response.data.uybTutari
                        );
                    }

                    // Yeni dosya checkbox event'leri
                    $('.dokuman-checkbox').on('change', function() {
                        const $checkbox = $(this);
                        const $dosyaAlani = $checkbox.closest('.dosya-check-group').find('.dosya-yukleme-alani');

                        if ($checkbox.is(':checked')) {
                            $dosyaAlani.addClass('active');
                        } else {
                            $dosyaAlani.removeClass('active');
                            $dosyaAlani.find('input[type="file"]').val('');
                            $dosyaAlani.find('.dosya-onizleme').removeClass('active').attr('src', '');
                        }
                    });

                    // Dosya önizleme
                    $('.dosya-yukleme-alani').on('change', 'input[type="file"]', function(e) {
                        const input = e.target;
                        const $preview = $(this).closest('.dosya-input-group').find('.dosya-onizleme');

                        if (input.files && input.files[0]) {
                            const reader = new FileReader();
                            reader.onload = function(e) {
                                $preview.attr('src', e.target.result).addClass('active');
                            }
                            reader.readAsDataURL(input.files[0]);
                        }
                    });

                    // Datepicker'ları başlat
                    initDatePickers();
                    setupDateCalculations();

                    $('#sozlesmeKaydetBtn').off('click').on('click', function () {
                        sozlesmeKaydet(teklifId);
                    });
                }
                else
                {
                    // Sözleşme zaten varsa uyarı göster ve modalı kapat
                    if (response.sozlesmeVar) {
                        $('#sozlesmeIcerik').html(`
                            <div class="alert alert-warning text-center py-5">
                                <i class="fas fa-exclamation-triangle fa-3x mb-3"></i>
                                <h5>${response.message}</h5>
                                <p class="mt-3">
                                    Mevcut sözleşmeyi görüntülemek için:
                                    <a href="/AdminTeklif/SozlesmePdf?sozlesmeId=${response.sozlesmeId}" target="_blank" class="btn btn-primary btn-sm mt-2">
                                        <i class="fas fa-file-pdf"></i> Sözleşme PDF'sini Aç
                                    </a>
                                </p>
                            </div>
                        `);
                        // Kaydet butonunu gizle
                        $('#sozlesmeKaydetBtn').hide();
                    } else {
                        $('#sozlesmeIcerik').html(`
                            <div class="alert alert-danger">
                                ${response.message || 'Sözleşme bilgileri yüklenemedi.'}
                            </div>
                        `);
                        $('#sozlesmeKaydetBtn').hide();
                    }
                }
            } catch (err) {
                console.error(err);
                $('#sozlesmeIcerik').html(`
                    <div class="alert alert-danger">Sunucu hatası oluştu.</div>
                `);
                $('#sozlesmeKaydetBtn').hide();
            }
        }

        // Sözleşme form HTML'i
        function sozlesmeFormHTML(data) {
            // Bugünün tarihini al
            const now = new Date();
            const oneYearLater = new Date(now);
            oneYearLater.setFullYear(now.getFullYear() + 1);

            // Tarih formatı: dd.MM.yyyy
            const formatDate = (date) => {
                const day = String(date.getDate()).padStart(2, '0');
                const month = String(date.getMonth() + 1).padStart(2, '0');
                const year = date.getFullYear();
                return `${day}.${month}.${year}`;
            };

            const defaultYayinTarihi = formatDate(now);
            const defaultUYBSuresi = formatDate(oneYearLater);

            // UYB hesaplama
            const uybTutariFromServer = data.uybTutari || "0";
            const uybOraniFromServer = data.uybOrani || "20";
            const tutarKdvsizFromServer = data.tutarKdvsiz || "0";

            // Değerleri güvenli bir şekilde parse et
            const parsedUYBTutari = parseTutar(uybTutariFromServer);
            const parsedTutarKdvsiz = parseTutar(tutarKdvsizFromServer);
            let parsedOrani = 20; // Varsayılan %20

            // Oranı parse et
            if (uybOraniFromServer) {
                const oranStr = uybOraniFromServer.toString().replace('%', '').trim();
                parsedOrani = parseFloat(oranStr) || 20;
            }

            // Oranı yüzde cinsinden hesapla
            const oranYuzde = (parsedOrani <= 1) ? parsedOrani * 100 : parsedOrani;

            // Hesaplama formülünü göster
            const uybHesaplamaDetay = `${formatTutar(parsedTutarKdvsiz)} ₺ × %${oranYuzde} = ${formatTutar(parsedUYBTutari)} ₺`;

            return `
                <form id="sozlesmeForm">
                    <div class="row g-4">
                        <!-- SOL TARAFTA: Lisans + Sözleşme Bilgileri -->
                        <div class="col-lg-7">
                            <!-- Lisans Bilgileri -->
                            <div class="sozlesme-section mb-4">
                                <h6 class="border-bottom pb-2 mb-3 text-primary">
                                    <i class="fas fa-key me-2"></i>Lisans Bilgileri
                                </h6>
                                <div class="row g-3">
                                    <!-- Yayın Tarihi Alanı -->
                                    <div class="col-md-2">
                                        <label class="form-label fw-medium">Sözleşme Tarihi<span class="text-danger">*</span></label>
                                        <input type="text"
                                               class="form-control datepicker"
                                               name="YayinTarihi"
                                               value="${defaultYayinTarihi}"
                                               data-date-format="dd.mm.yyyy"
                                               placeholder="gg.aa.yyyy"
                                               required>
                                    </div>

                                    <!-- UYB Süresi Alanı -->
                                    <div class="col-md-4">
                                        <label class="form-label fw-medium">Ürün/Lisans Yenileme (ÜYB) Bitiş Süresi<span class="text-danger">*</span></label>
                                        <input type="text"
                                               class="form-control datepicker"
                                               name="UYBSuresi"
                                               value="${defaultUYBSuresi}"
                                               data-date-format="dd.mm.yyyy"
                                               placeholder="gg.aa.yyyy"
                                               required>
                                    </div>

                                    <!-- Otomatik Hesapla Butonu -->
                                    <div class="col-md-1" style="margin-top: 42px;">
                                        <button type="button"
                                                class="btn btn-outline-secondary btn-sm w-100"
                                                id="autoCalculateDates"
                                                title="Tarihleri Otomatik Hesapla">
                                            <i class="fas fa-calculator me-1"></i>
                                        </button>
                                    </div>

                                    <div class="col-md-5">
                                        <label class="form-label fw-medium">Lisans No</label>
                                        <input type="text" class="form-control" name="LisansNo" value="">
                                        <small class="text-muted">Zorunlu değil</small>
                                    </div>

                                    <div class="col-md-4">
                                        <label class="form-label fw-medium">Lisans Türü</label>
                                        <input type="text" class="form-control" value="${data.lisansTipi || 'Professional Lisans'}" disabled>
                                    </div>

                                    <div class="col-md-4">
                                        <label class="form-label fw-medium">Program Adı</label>
                                        <input type="text" class="form-control" value="${data.paketAdi || 'AKINSOFT Wolvox'}" disabled>
                                    </div>

                                    <div class="col-md-4">
                                        <label class="form-label fw-medium">Müşteri Şifre</label>
                                        <input type="text" class="form-control" value="${data.teklifId || ''}" disabled>
                                    </div>

                                    <div class="col-md-4">
                                        <label class="form-label fw-medium">Kampanya</label>
                                        <div class="input-group">
                                            <input type="text" class="form-control" disabled name="Kampanya" value="${data.kampanyaBilgisi || ''}">
                                        </div>
                                    </div>

                                    <div class="col-md-4">
                                        <label class="form-label fw-medium">Tutar (KDV'siz) </label>
                                        <div class="input-group">
                                            <input type="text"
                                                   class="form-control text-success fw-bold bg-light"
                                                   value="${formatTutar(parsedTutarKdvsiz)} ₺"
                                                   disabled
                                                   id="kdvsizTutarInput">
                                            <span class="input-group-text">₺</span>
                                        </div>
                                    </div>

                                    <div class="col-md-4">
                                        <label class="form-label fw-medium">
                                            Ürün/Lisans Yenileme Bedeli (ÜYB)
                                            <span class="text-danger">*</span>
                                        </label>
                                        <div class="input-group">
                                            <input type="text"
                                                   class="form-control fw-bold text-success bg-light"
                                                   id="uybTutariInput"
                                                   name="YillikBakim"
                                                   value="${formatTutar(parsedUYBTutari)}"
                                                   readonly
                                                   style="cursor: not-allowed;"
                                                   title="Bu alan otomatik hesaplanır ve değiştirilemez">
                                            <span class="input-group-text">₺</span>
                                        </div>

                                    </div>
                                </div>
                            </div>

                            <!-- Doküman Yükleme Bölümü -->
                            <div class="sozlesme-section mb-4">
                                <h6 class="border-bottom pb-2 mb-3 text-primary">
                                    <i class="fas fa-file-upload me-2"></i>Gerekli Dokümanlar
                                </h6>
                                <div class="row g-3">
                                    <div class="col-md-6">
                                        <div class="dosya-check-group">
                                            <div class="form-check">
                                                <input class="form-check-input dokuman-checkbox" type="checkbox" name="VergiKimlikLevhasıVar" id="vergiLevha">
                                                <label class="form-check-label" for="vergiLevha">Vergi Kimlik Levhası</label>
                                            </div>
                                            <div class="dosya-yukleme-alani">
                                                <div class="dosya-input-group">
                                                    <input type="file" class="form-control form-control-sm" name="VergiKimlikLevhasıDosya" accept=".pdf,.jpg,.jpeg,.png,.doc,.docx">
                                                    <div class="mt-2">
                                                        <small class="text-muted">PDF, JPG, PNG, DOC formatları</small>
                                                    </div>
                                                    <img class="dosya-onizleme" alt="Önizleme">
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="col-md-6">
                                        <div class="dosya-check-group">
                                            <div class="form-check">
                                                <input class="form-check-input dokuman-checkbox" type="checkbox" name="TicariSicilGazetesiVar" id="ticariSicil">
                                                <label class="form-check-label" for="ticariSicil">Ticari Sicil Gazetesi</label>
                                            </div>
                                            <div class="dosya-yukleme-alani">
                                                <div class="dosya-input-group">
                                                    <input type="file" class="form-control form-control-sm" name="TicariSicilGazetesiDosya" accept=".pdf,.jpg,.jpeg,.png,.doc,.docx">
                                                    <div class="mt-2">
                                                        <small class="text-muted">PDF, JPG, PNG, DOC formatları</small>
                                                    </div>
                                                    <img class="dosya-onizleme" alt="Önizleme">
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="col-md-6">
                                        <div class="dosya-check-group">
                                            <div class="form-check">
                                                <input class="form-check-input dokuman-checkbox" type="checkbox" name="KimlikOnYuzuVar" id="kimlikOn">
                                                <label class="form-check-label" for="kimlikOn">Kimlik Ön Yüzü</label>
                                            </div>
                                            <div class="dosya-yukleme-alani">
                                                <div class="dosya-input-group">
                                                    <input type="file" class="form-control form-control-sm" name="KimlikOnYuzuDosya" accept=".pdf,.jpg,.jpeg,.png">
                                                    <div class="mt-2">
                                                        <small class="text-muted">PDF, JPG, PNG formatları</small>
                                                    </div>
                                                    <img class="dosya-onizleme" alt="Önizleme">
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="col-md-6">
                                        <div class="dosya-check-group">
                                            <div class="form-check">
                                                <input class="form-check-input dokuman-checkbox" type="checkbox" name="ImzaSirkusuVar" id="imzaSirkusu">
                                                <label class="form-check-label" for="imzaSirkusu">İmza Sirküsü veya İmza Beyanı</label>
                                            </div>
                                            <div class="dosya-yukleme-alani">
                                                <div class="dosya-input-group">
                                                    <input type="file" class="form-control form-control-sm" name="ImzaSirkusuDosya" accept=".pdf,.jpg,.jpeg,.png,.doc,.docx">
                                                    <div class="mt-2">
                                                        <small class="text-muted">PDF, JPG, PNG, DOC formatları</small>
                                                    </div>
                                                    <img class="dosya-onizleme" alt="Önizleme">
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                <div class="alert alert-info mt-3">
                                    <i class="fas fa-info-circle me-2"></i>
                                    <small>Dosyalar "WebAdminTheme/MusteriSozlesme" klasörüne kaydedilecektir. İşaretlenen dokümanları yükleyebilirsiniz.</small>
                                </div>
                            </div>

                            <!-- Sözleşme Tipi ve Durumu -->
                            <div class="sozlesme-section">
                                <h6 class="border-bottom pb-2 mb-3 text-primary">
                                    <i class="fas fa-key me-2"></i>Bilgilendirme (KVKK. Onayı)
                                </h6>
                                <div class="row g-3 align-items-end">
                                    <div class="d-flex flex-wrap gap-4">
                                        <div class="form-check">
                                            <input class="form-check-input" type="checkbox" name="SmsBilgilendirme" id="smsBilgi">
                                            <label class="form-check-label small" for="smsBilgi">SMS ile Bilgilendir</label>
                                        </div>
                                        <div class="form-check">
                                            <input class="form-check-input" type="checkbox" name="EmailBilgilendirme" id="emailBilgi" checked>
                                            <label class="form-check-label small" for="emailBilgi">E-posta Gönder</label>
                                        </div>
                                        <div class="form-check">
                                            <input class="form-check-input" type="checkbox" name="TelefonBilgilendirme" id="telBilgi">
                                            <label class="form-check-label small" for="telBilgi">Telefonla Bilgilendir</label>
                                        </div>
                                        <div class="form-check">
                                            <input class="form-check-input" type="checkbox" name="HaberPaylasimi" id="haberPaylasim">
                                            <label class="form-check-label small" for="haberPaylasim">Haber Paylaşılsın</label>
                                        </div>
                                    </div>
                                    <div class="col-md-4">
                                        <label class="form-label fw-medium">Sözleşme Durumu</label>
                                        <div class="d-flex gap-3">
                                            <div class="form-check">
                                                <input class="form-check-input" type="radio" name="SozlesmeTipi" value="YeniKayit" id="durum1" checked>
                                                <label class="form-check-label">Yeni Kayıt</label>
                                            </div>
                                            <div class="form-check">
                                                <input class="form-check-input" type="radio" name="SozlesmeTipi" value="OdemeBeklemede" id="durum2">
                                                <label class="form-check-label">Ödemeden Beklemede</label>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- SAĞ TARAFTA: Müşteri Bilgileri -->
                        <div class="col-lg-5">
                            <div class="sozlesme-section h-100">
                                <h6 class="border-bottom pb-2 mb-3 text-primary">
                                    <i class="fas fa-user-tie me-2"></i>Müşteri Bilgileri
                                </h6>

                                <div class="row g-3">
                                    <div class="col-md-12">
                                        <div class="row g-2">
                                            <div class="col-md-6">
                                                <label class="form-label small fw-medium">Ticari Ünvan <span class="text-danger">*</span></label>
                                                <input type="text" class="form-control form-control-sm" disabled name="TicariUnvan" value="${data.musteri?.ticariUnvan || ''}">
                                            </div>
                                            <div class="col-md-3">
                                                <label class="form-label small fw-medium">Adı <span class="text-danger">*</span></label>
                                                <input type="text" class="form-control form-control-sm" disabled name="Adi" value="${data.musteri?.adi || ''}" required>
                                            </div>
                                            <div class="col-md-3">
                                                <label class="form-label small fw-medium">Soyadı <span class="text-danger">*</span></label>
                                                <input type="text" class="form-control form-control-sm" disabled name="Soyadi" value="${data.musteri?.soyadi || ''}" required>
                                            </div>
                                            <div class="col-md-6">
                                                <label class="form-label small fw-medium">Telefon <span class="text-danger">*</span></label>
                                                <input type="tel" class="form-control form-control-sm" disabled name="Telefon" value="${data.musteri?.telefon || ''}" required>
                                            </div>
                                            <div class="col-md-6">
                                                <label class="form-label small fw-medium">Cep Tel.</label>
                                                <input type="tel" class="form-control form-control-sm" name="CepTelefon" value="">
                                            </div>
                                            <div class="col-md-12">
                                                <label class="form-label small fw-medium">Adres - 1 <span class="text-danger">*</span></label>
                                                <input type="text" class="form-control form-control-sm" disabled name="Adres1" value="${data.musteri?.adres1 || ''}" required>
                                            </div>
                                            <div class="col-md-12">
                                                <label class="form-label small fw-medium">Adres - 2</label>
                                                <input type="text" class="form-control form-control-sm" name="Adres2" value="${data.musteri?.adres2 || ''}">
                                            </div>
                                            <div class="col-md-4">
                                                <label class="form-label small fw-medium">Ülke <span class="text-danger">*</span></label>
                                                <input type="text" class="form-control form-control-sm" value="Türkiye" disabled>
                                            </div>
                                            <div class="col-md-4">
                                                <label class="form-label small fw-medium">İl <span class="text-danger">*</span></label>
                                                <input type="text" class="form-control form-control-sm" disabled name="Il" value="${data.musteri?.il || ''}" required>
                                            </div>
                                            <div class="col-md-4">
                                                <label class="form-label small fw-medium">İlçe <span class="text-danger">*</span></label>
                                                <input type="text" class="form-control form-control-sm" disabled name="Ilce" value="${data.musteri?.ilce || ''}" required>
                                            </div>
                                            <div class="col-md-6">
                                                <label class="form-label small fw-medium">Vergi Dairesi <span class="text-danger">*</span></label>
                                                <input type="text" class="form-control form-control-sm" disabled name="VergiDairesi" value="${data.musteri?.vergiDairesi || ''}">
                                            </div>
                                            <div class="col-md-3">
                                                <label class="form-label small fw-medium">Vergi No <span class="text-danger">*</span></label>
                                                <input type="text" class="form-control form-control-sm" disabled name="VergiNo" value="${data.musteri?.vergiNo || ''}">
                                            </div>
                                            <div class="col-md-3">
                                                <label class="form-label small fw-medium">E-mail <span class="text-danger">*</span></label>
                                                <input type="email" disabled class="form-control form-control-sm" name="Email" value="${data.musteri?.email || ''}" required>
                                            </div>
                                            <div class="col-md-6">
                                                <label class="form-label small fw-medium">Web</label>
                                                <input type="url" class="form-control form-control-sm" name="WebSitesi" value="${data.musteri?.webAdresi || ''}">
                                            </div>
                                            <div class="col-md-6">
                                                <label class="form-label small fw-medium">Referans Sektör <span class="text-danger">*</span></label>
                                                <input type="text" disabled class="form-control form-control-sm" name="Referans" value="${data.musteri?.musteriTipi || ''}">
                                            </div>
                                            <div class="col-md-6">
                                                <label class="form-label small fw-medium">Nereden Duydu</label>
                                                ${generateNeredenDuyduSelect(data.neredenDuyduList || [], data.musteri?.neredenDuyduId)}
                                            </div>
                                            <div class="col-md-6">
                                                <label class="form-label small fw-medium">Entegratör <span class="text-danger">*</span></label>
                                                ${generateEntegratorSelect(data.entegratorList || [], data.musteri?.entegratorId)}
                                            </div>
                                        </div>
                                        <div class="alert alert-info mt-4 small">
                                            <i class="fas fa-info-circle me-2"></i>
                                            <strong>Zorunlu alanlar <span class="text-danger">*</span> ile işaretlenmiştir. Lütfen eksik alanları müşteri kartından doldurunuz.</strong>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Hidden fields for security -->
                    <input type="hidden" id="calculatedUYBTutari" value="${parsedUYBTutari}">
                    <input type="hidden" id="calculatedTutarKdvsiz" value="${parsedTutarKdvsiz}">
                    <input type="hidden" id="calculatedUYBOrani" value="${oranYuzde}">
                </form>
            `;
        }

        // Nereden Duydu dropdown oluşturma
        function generateNeredenDuyduSelect(list, selectedId) {
            let options = '<option value="">Seçiniz</option>';
            list.forEach(item => {
                const selected = item.id == selectedId ? 'selected' : '';
                options += `<option value="${item.id}" ${selected}>${item.adi}</option>`;
            });
            return `<select class="form-select" name="NeredenDuyduId">${options}</select>`;
        }

        // Entegratör dropdown oluşturma
        function generateEntegratorSelect(list, selectedId) {
            let options = '<option value="">Seçiniz</option>';
            list.forEach(item => {
                const selected = item.id == selectedId ? 'selected' : '';
                options += `<option value="${item.id}" ${selected}>${item.adi} - ${item.kodu}</option>`;
            });
            return `<select class="form-select" name="EntegratorId">${options}</select>`;
        }

        async function sozlesmeKaydet(teklifId) {
            try {
                // Müşteri verisi gelmiş mi?
                if (!currentSozlesmeData || !currentSozlesmeData.musteri) {
                    toastr.error('Müşteri bilgileri yüklenemedi.');
                    return;
                }

                const m = currentSozlesmeData.musteri;

                // Formdan alınan değerler
                const lisansNo = $('[name="LisansNo"]').val()?.trim() || '';

                // UYB tutarını parse et
                const uybTutari = parseTutar($('#calculatedUYBTutari').val()) || 0;
                const tutarKdvsiz = parseTutar($('#calculatedTutarKdvsiz').val()) || 0;
                const uybOrani = parseFloat($('#calculatedUYBOrani').val()) || 20;

                // Güvenlik kontrolü: Gerçek hesaplama yap
                const calculatedUYBTutari = tutarKdvsiz * (uybOrani / 100);

                // UYB tutarını backend için formatla
                const formatUYBForBackend = (tutar) => {
                    if (typeof tutar === 'number') {
                        return tutar.toFixed(2).replace('.', ',');
                    }

                    let str = tutar.toString();
                    str = str.replace('₺', '').replace('TL', '').replace(/\s/g, '').trim();
                    str = str.replace(/\./g, '');
                    str = str.replace(',', '.');

                    const num = parseFloat(str);
                    if (isNaN(num)) return "0,00";

                    return num.toFixed(2).replace('.', ',');
                };

                const uybTutariBackendFormat = formatUYBForBackend(uybTutari);
                const entegratorId = parseInt($('[name="EntegratorId"]').val()) || 0;

                // Tarih alanlarını al
                const yayinTarihi = $('[name="YayinTarihi"]').val()?.trim() || '';
                const uybSuresi = $('[name="UYBSuresi"]').val()?.trim() || '';

                // Radio button değeri
                const sozlesmeTipi = $('[name="SozlesmeTipi"]:checked').val() || 'YeniKayit';

                // Checkbox değerleri
                const odemeBekleme = $('#durum2').is(':checked');
                const smsBilgilendirme = $('#smsBilgi').is(':checked');
                const emailBilgilendirme = $('#emailBilgi').is(':checked');
                const telefonBilgilendirme = $('#telBilgi').is(':checked');
                const haberPaylasimi = $('#haberPaylasim').is(':checked');

                // Doküman checkbox değerleri
                const vergiKimlikLevhasıVar = $('#vergiLevha').is(':checked');
                const ticariSicilGazetesiVar = $('#ticariSicil').is(':checked');
                const kimlikOnYuzuVar = $('#kimlikOn').is(':checked');
                const imzaSirkusuVar = $('#imzaSirkusu').is(':checked');

                // Doküman dosyalarını topla
                const formData = new FormData();

                // Form verilerini ekle
                formData.append('TeklifId', teklifId);
                formData.append('MusteriId', m.id);
                formData.append('LisansNo', lisansNo);
                formData.append('YillikBakim', uybTutariBackendFormat);
                formData.append('SozlesmeTipi', sozlesmeTipi);
                formData.append('EntegratorId', entegratorId);

                // Yeni tarih alanlarını ekle
                formData.append('YayinTarihi', yayinTarihi);
                formData.append('UYBSuresi', uybSuresi);

                // Checkbox'ları ekle (sadece işaretliyse)
                if (odemeBekleme) formData.append('OdemeBekleme', 'on');
                if (smsBilgilendirme) formData.append('SmsBilgilendirme', 'on');
                if (emailBilgilendirme) formData.append('EmailBilgilendirme', 'on');
                if (telefonBilgilendirme) formData.append('TelefonBilgilendirme', 'on');
                if (haberPaylasimi) formData.append('HaberPaylasimi', 'on');

                // Doküman checkbox'ları
                if (vergiKimlikLevhasıVar) formData.append('VergiKimlikLevhasıVar', 'on');
                if (ticariSicilGazetesiVar) formData.append('TicariSicilGazetesiVar', 'on');
                if (kimlikOnYuzuVar) formData.append('KimlikOnYuzuVar', 'on');
                if (imzaSirkusuVar) formData.append('ImzaSirkusuVar', 'on');

                // Müşteri bilgileri
                formData.append('TicariUnvan', m.ticariUnvan?.trim() || '');
                formData.append('Adi', m.adi?.trim() || '');
                formData.append('Soyadi', m.soyadi?.trim() || '');
                formData.append('Telefon', m.telefon?.trim() || '');
                formData.append('CepTelefon', $('[name="CepTelefon"]').val()?.trim() || '');
                formData.append('Adres1', m.adres1?.trim() || '');
                formData.append('Adres2', $('[name="Adres2"]').val()?.trim() || '');
                formData.append('Ulke', 'Türkiye');
                formData.append('Il', m.il?.trim() || '');
                formData.append('Ilce', m.ilce?.trim() || '');
                formData.append('VergiDairesi', m.vergiDairesi?.trim() || '');
                formData.append('VergiNo', m.vergiNo?.trim() || '');
                formData.append('Email', m.email?.trim() || '');
                formData.append('WebSitesi', $('[name="WebSitesi"]').val()?.trim() || '');
                formData.append('Referans', m.musteriTipi?.trim() || '');

                const neredenDuyduId = parseInt($('[name="NeredenDuyduId"]').val()) || null;
                if (neredenDuyduId) {
                    formData.append('NeredenDuyduId', neredenDuyduId);
                }

                // Dosyaları ekle
                const vergiDosya = $('[name="VergiKimlikLevhasıDosya"]')[0]?.files[0];
                if (vergiDosya) formData.append('VergiKimlikLevhasıDosya', vergiDosya);

                const ticariDosya = $('[name="TicariSicilGazetesiDosya"]')[0]?.files[0];
                if (ticariDosya) formData.append('TicariSicilGazetesiDosya', ticariDosya);

                const kimlikDosya = $('[name="KimlikOnYuzuDosya"]')[0]?.files[0];
                if (kimlikDosya) formData.append('KimlikOnYuzuDosya', kimlikDosya);

                const imzaDosya = $('[name="ImzaSirkusuDosya"]')[0]?.files[0];
                if (imzaDosya) formData.append('ImzaSirkusuDosya', imzaDosya);

                // Hata listesi
                const hatalar = [];

                // 1. Tarih alanları kontrolü
                if (!yayinTarihi) hatalar.push('Yayın Tarihi');
                if (!uybSuresi) hatalar.push('UYB Süresi Bitiş Tarihi');

                // Tarih format kontrolü
                const dateRegex = /^\d{2}\.\d{2}\.\d{4}$/;
                if (yayinTarihi && !dateRegex.test(yayinTarihi)) {
                    hatalar.push('Yayın Tarihi (gg.aa.yyyy formatında olmalı)');
                }
                if (uybSuresi && !dateRegex.test(uybSuresi)) {
                    hatalar.push('UYB Süresi (gg.aa.yyyy formatında olmalı)');
                }

                // 2. Müşteri tarafı zorunlu alanlar
                if (!m.ticariUnvan?.trim()) hatalar.push('Ticari Ünvan');
                if (!m.adi?.trim()) hatalar.push('Adı');
                if (!m.soyadi?.trim()) hatalar.push('Soyadı');
                if (!m.telefon?.trim()) hatalar.push('Telefon');
                if (!m.adres1?.trim()) hatalar.push('Adres - 1');
                if (!m.il?.trim()) hatalar.push('İl');
                if (!m.ilce?.trim()) hatalar.push('İlçe');
                if (!m.vergiDairesi?.trim()) hatalar.push('Vergi Dairesi');
                if (!m.vergiNo?.trim()) hatalar.push('Vergi No');
                if (!m.email?.trim()) hatalar.push('E-posta');
                if (!m.musteriTipi?.trim()) hatalar.push('Referans Sektör');

                // 3. Entegratör zorunlu
                if (entegratorId <= 0) hatalar.push('Entegratör');

                // Hata varsa kullanıcıyı uyar ve çık
                if (hatalar.length > 0) {
                    toastr.warning(
                        '<strong>Eksik veya hatalı zorunlu alanlar:</strong><br><ul class="mb-0"><li>' +
                        hatalar.join('</li><li>') +
                        '</li></ul>',
                        'Lütfen Doldurun',
                        { timeOut: 10000, escapeHtml: false, positionClass: 'toast-top-center' }
                    );
                    return;
                }

                // Kaydet butonunu kilitle
                const $btn = $('#sozlesmeKaydetBtn');
                $btn.prop('disabled', true).html('<i class="fas fa-spinner fa-spin"></i> Kaydediliyor...');

                const response = await $.ajax({
                    url: '/AdminTeklif/KaydetSozlesme',
                    type: 'POST',
                    data: formData,
                    processData: false,
                    contentType: false,
                    dataType: 'json'
                });

                if (response.success) {
                    toastr.success(response.message || 'Sözleşme başarıyla kaydedildi!');
                    // PDF'i yeni sekmede aç
                    if (response.sozlesmeId) {
                        window.open(`/AdminTeklif/SozlesmePdf?sozlesmeId=${response.sozlesmeId}`, '_blank');
                    }
                    bootstrap.Modal.getInstance('#sozlesmeModal').hide();
                    setTimeout(() => location.reload(), 1500);
                } else {
                    toastr.error(response.message || 'Sözleşme kaydedilemedi.');
                }

            } catch (err) {
                console.error(err);
                const msg = err.responseJSON?.message || 'Sunucu ile bağlantı kurulamadı.';
                toastr.error('Hata: ' + msg);
            } finally {
                $('#sozlesmeKaydetBtn')
                    .prop('disabled', false)
                    .html('<i class="fas fa-save me-2"></i>Sözleşmeyi Gönder');
            }
        }

        function formatTutar(val, decimals = 2) {
            if (val === null || val === undefined || val === '') return '0,00';

            let num;
            if (typeof val === 'string') {
                const cleaned = val
                    .replace(/\./g, '')
                    .replace(',', '.')
                    .trim();
                num = parseFloat(cleaned);
            } else {
                num = val;
            }

            if (isNaN(num)) return '0,00';

            return new Intl.NumberFormat('tr-TR', {
                minimumFractionDigits: decimals,
                maximumFractionDigits: decimals
            }).format(num);
        }

        function parseTutar(tutarStr) {
            if (tutarStr === null || tutarStr === undefined) return 0;

            if (typeof tutarStr === 'number') return tutarStr;
            if (typeof tutarStr === 'boolean') return tutarStr ? 1 : 0;

            if (typeof tutarStr === 'string') {
                const cleaned = tutarStr
                    .toString()
                    .replace(/\./g, '')
                    .replace(',', '.')
                    .replace(/[^\d.-]/g, '')
                    .trim();

                const num = parseFloat(cleaned);
                return isNaN(num) ? 0 : num;
            }

            return 0;
        }

        function getDurumBadgeCss(id) {
            const map = {
                1: 'bg-warning text-dark',
                2: 'bg-success',
                3: 'bg-success',
                4: 'bg-danger',
                5: 'bg-secondary',
                6: 'bg-success',
                7: 'bg-warning text-dark',
                8: 'bg-info',
                9: 'bg-purple text-white',
                10: 'bg-warning text-dark',
                12: 'bg-secondary'
            };
            return map[id] || 'bg-light text-dark';
        }

        function musteriDuzenleAc(musteriId) {
            const url = `/AdminMusteri/Index?musteriId=${musteriId}`;
            window.open(url, '_blank');
        }

        // AdminMusteri sayfasında çalışacak kısım: URL'den musteriId oku ve düzenleme modalını aç
        $(document).ready(function () {
            const urlParams = new URLSearchParams(window.location.search);
            const musteriId = urlParams.get('musteriId');

            if (musteriId && parseInt(musteriId) > 0) {
                duzenleGetir(parseInt(musteriId));
            }
        });

        // Datepicker initialization ve otomatik hesaplama fonksiyonu
        function initDatePickers() {
            // Basit tarih formatı kontrolü için input mask ekleyelim
            $('.datepicker').on('input', function() {
                let value = $(this).val().replace(/\D/g, '');
                if (value.length > 2 && value.length <= 4) {
                    value = value.substring(0, 2) + '.' + value.substring(2);
                } else if (value.length > 4 && value.length <= 8) {
                    value = value.substring(0, 2) + '.' + value.substring(2, 4) + '.' + value.substring(4, 8);
                }
                $(this).val(value);
            });

            // Focus olduğunda rehber göster
            $('.datepicker').on('focus', function() {
                if (!$(this).val()) {
                    $(this).attr('placeholder', 'gg.aa.yyyy');
                }
            });
        }

        // Otomatik tarih hesaplama fonksiyonu
        function setupDateCalculations() {
            // Otomatik hesapla butonu
            $('#autoCalculateDates').off('click').on('click', function() {
                const today = new Date();
                const oneYearLater = new Date(today);
                oneYearLater.setFullYear(today.getFullYear() + 1);

                // Format: dd.MM.yyyy
                const formatDateForInput = (date) => {
                    const day = String(date.getDate()).padStart(2, '0');
                    const month = String(date.getMonth() + 1).padStart(2, '0');
                    const year = date.getFullYear();
                    return `${day}.${month}.${year}`;
                };

                $('[name="YayinTarihi"]').val(formatDateForInput(today));
                $('[name="UYBSuresi"]').val(formatDateForInput(oneYearLater));

                toastr.info('Tarihler otomatik hesaplandı.', '', { timeOut: 2000 });
            });

            // Yayın tarihi değiştiğinde UYB süresini otomatik güncelle
            $('[name="YayinTarihi"]').off('change').on('change', function() {
                const dateStr = $(this).val().trim();
                if (dateStr && dateStr.includes('.')) {
                    try {
                        const parts = dateStr.split('.');
                        if (parts.length === 3) {
                            const day = parseInt(parts[0]);
                            const month = parseInt(parts[1]) - 1;
                            const year = parseInt(parts[2]);

                            // Geçerli tarih kontrolü
                            if (day >= 1 && day <= 31 && month >= 0 && month <= 11 && year >= 1900 && year <= 2100) {
                                const yayinTarihi = new Date(year, month, day);
                                if (!isNaN(yayinTarihi.getTime())) {
                                    const uybSuresi = new Date(yayinTarihi);
                                    uybSuresi.setFullYear(yayinTarihi.getFullYear() + 1);

                                    const formatDateForInput = (date) => {
                                        const d = String(date.getDate()).padStart(2, '0');
                                        const m = String(date.getMonth() + 1).padStart(2, '0');
                                        const y = date.getFullYear();
                                        return `${d}.${m}.${y}`;
                                    };

                                    $('[name="UYBSuresi"]').val(formatDateForInput(uybSuresi));
                                    return;
                                }
                            }
                        }
                    } catch (e) {
                        console.log('Tarih hesaplama hatası:', e);
                    }
                }

                // Tarih geçersizse varsayılan değerleri kullan
                const today = new Date();
                const oneYearLater = new Date(today);
                oneYearLater.setFullYear(today.getFullYear() + 1);

                const formatDateForInput = (date) => {
                    const d = String(date.getDate()).padStart(2, '0');
                    const m = String(date.getMonth() + 1).padStart(2, '0');
                    const y = date.getFullYear();
                    return `${d}.${m}.${y}`;
                };

                if (!dateStr || dateStr.trim() === '') {
                    $('[name="YayinTarihi"]').val(formatDateForInput(today));
                }
                $('[name="UYBSuresi"]').val(formatDateForInput(oneYearLater));
            });
        }

        function updateUYBBilgi(tutarKdvsiz, uybOrani, uybTutari) {
            try {
                // Değerleri güvenli bir şekilde parse et
                const parsedKdvsiz = parseTutar(tutarKdvsiz);
                const parsedUYBTutari = parseTutar(uybTutari);
                const parsedOrani = typeof uybOrani === 'number' ? uybOrani : parseFloat(uybOrani || 20);

                // NaN kontrolü
                if (isNaN(parsedKdvsiz) || isNaN(parsedUYBTutari) || isNaN(parsedOrani)) {
                    console.error('Geçersiz sayısal değer:', { tutarKdvsiz, uybOrani, uybTutari });
                    return;
                }

                // Formatla ve göster
                const formattedKdvsiz = formatTutar(parsedKdvsiz);
                const formattedUYB = formatTutar(parsedUYBTutari);
                const oranYuzde = parsedOrani.toFixed(0);

                // Hesaplama formülünü göster
                const uybHesaplamaDetay = `${formattedKdvsiz} ₺ × %${oranYuzde} = ${formattedUYB} ₺`;

                // Input'ları güncelle (elementlerin mevcut olup olmadığını kontrol et)
                const uybHesaplamaDetayEl = document.getElementById('uybHesaplamaDetay');
                const uybTutariInputEl = document.getElementById('uybTutariInput');
                const uybOraniInputEl = document.getElementById('uybOraniInput');
                const kdvsizTutarInputEl = document.getElementById('kdvsizTutarInput');

                if (uybHesaplamaDetayEl) uybHesaplamaDetayEl.textContent = uybHesaplamaDetay;
                if (uybTutariInputEl) uybTutariInputEl.value = formattedUYB;
                if (uybOraniInputEl) uybOraniInputEl.value = `%${oranYuzde}`;
                if (kdvsizTutarInputEl) kdvsizTutarInputEl.value = `${formattedKdvsiz} ₺`;

                // Hidden field'ları güncelle
                $('#calculatedUYBTutari').val(parsedUYBTutari);
                $('#calculatedTutarKdvsiz').val(parsedKdvsiz);
                $('#calculatedUYBOrani').val(parsedOrani);

            } catch (error) {
                console.error('UYB bilgisi güncellenirken hata:', error);
            }
        }

        // Yardımcı fonksiyonlar
        function formatTutar(val) {
            if (!val && val !== 0) return '0,00';
            const num = typeof val === 'string' ? parseFloat(val.replace(',', '.')) : val;
            return new Intl.NumberFormat('tr-TR', {
                minimumFractionDigits: 2,
                maximumFractionDigits: 2
            }).format(num);
        }
    </script>
}