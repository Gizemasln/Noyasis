@model List<WepApp.Models.ArgeHata>
@{
    ViewData["Title"] = "ARGE & Hata Bildirimleri";
    Layout = "~/Views/Shared/_LayoutWebAdmin.cshtml";
    int currentPage = ViewBag.CurrentPage ?? 1;
    int totalPages = ViewBag.TotalPages ?? 1;
    int totalCount = ViewBag.TotalCount ?? 0;
    string kullaniciTipi = ViewBag.KullaniciTipi;
    var bayiMusterileri = ViewBag.BayiMusterileri as List<WepApp.Models.Musteri>;
    var bayiBilgi = ViewBag.BayiBilgi as WepApp.Models.Bayi;
    var bayiListe = ViewBag.BayiListe as List<WepApp.Models.ArgeHata> ?? new List<WepApp.Models.ArgeHata>();
    var musteriListe = ViewBag.MusteriListe as List<WepApp.Models.ArgeHata> ?? new List<WepApp.Models.ArgeHata>();
}

<style>
    .card {
        border: none;
        border-radius: 10px;
        overflow: hidden;
        margin-bottom: 20px;
    }

    .badge {
        font-size: 0.85em;
        padding: 0.4em 0.8em;
    }

    .table th {
        background-color: #f1f3f5;
        border-bottom: 2px solid #dee2e6;
    }

    .pagination .page-item.active .page-link {
        background-color: #007bff;
        border-color: #007bff;
    }

    .form-label {
        font-weight: 600;
        margin-bottom: 0.5rem;
    }

    .readonly-input {
        background-color: #f8f9fa;
        font-weight: 500;
        border: 1px solid #dee2e6;
    }

    .modal-lg {
        max-width: 800px;
    }

    #msgContainer {
        position: fixed;
        top: 80px;
        right: 20px;
        z-index: 9999;
        max-width: 400px;
    }

    .kayit-sahibi {
        background-color: #f0f7ff;
        border-left: 4px solid #007bff;
    }

    /* Filtre Butonları */
    .filtre-butonlari {
        margin-bottom: 20px;
    }

        .filtre-butonlari .btn {
            margin-right: 5px;
        }

            .filtre-butonlari .btn.active {
                font-weight: bold;
                box-shadow: 0 2px 5px rgba(0,0,0,0.2);
            }

    /* Cevap Durum Stilleri */
    .cevap-bekliyor {
        background-color: #fff3cd;
        color: #856404;
        border: 1px solid #ffeaa7;
    }

    .cevap-verildi {
        background-color: #d4edda;
        color: #155724;
        border: 1px solid #c3e6cb;
    }

    .cevap-badge {
        font-size: 0.75rem;
        padding: 0.25rem 0.5rem;
        border-radius: 4px;
        font-weight: 600;
    }

    .cevap-icerik {
        background-color: #f8f9fa;
        border: 1px solid #e9ecef;
        border-radius: 6px;
        padding: 8px;
        margin-top: 5px;
        font-size: 0.8rem;
        line-height: 1.4;
        max-height: 60px;
        overflow: hidden;
        cursor: pointer;
        transition: all 0.3s ease;
    }

        .cevap-icerik:hover {
            background-color: #e9ecef;
        }

    .cevap-tarihi {
        font-size: 0.75rem;
        color: #6c757d;
        margin-top: 5px;
    }

    .durum-bilgi {
        font-size: 0.8rem;
        color: #495057;
        margin-top: 3px;
    }

    /* Cevap Modal */
    .cevap-modal-content {
        background-color: #f8f9fa;
        border-left: 4px solid #28a745;
    }

    /* Kayıt Sahibi Badge */
    .sahibi-badge-bayi {
        background-color: #cce5ff;
        color: #004085;
        font-size: 0.7rem;
        padding: 2px 6px;
        border-radius: 4px;
        display: inline-block;
        margin-bottom: 3px;
    }

    .sahibi-badge-musteri {
        background-color: #d4edda;
        color: #155724;
        font-size: 0.7rem;
        padding: 2px 6px;
        border-radius: 4px;
        display: inline-block;
        margin-bottom: 3px;
    }
</style>

<div class="container-fluid py-4">
    <!-- Mesaj Alanı -->
    <div id="msgContainer"></div>

    <!-- Yeni Kayıt Ekleme Formu -->
    <div class="card shadow mb-5">
        <div class="card-header bg-gradient-success text-white">
            <h4 class="mb-0"><i class="fas fa-plus-circle me-2"></i> Yeni ARGE / Hata Bildirimi</h4>
        </div>
        <div class="card-body">
            <form id="ekleForm" enctype="multipart/form-data">
                @Html.AntiForgeryToken()
                <!-- Kullanıcı Bilgileri -->
                <div class="row mb-4">
                    <div class="col-md-4">
                        <label class="form-label">Kullanıcı Tipi</label>
                        <input type="text" class="form-control readonly-input"
                               value="@(kullaniciTipi == "Musteri" ? "Müşteri" : kullaniciTipi == "Bayi" ? "Bayi" : "Kurumsal")" readonly />
                    </div>
                    @if (kullaniciTipi == "Bayi")
                    {
                        <div class="col-md-4">
                            <label class="form-label">Bildirim Sahibi</label>
                            <div class="form-check">
                                <input class="form-check-input" type="radio" name="bildirimSahibi" id="bayiKendisi" value="bayi" checked>
                                <label class="form-check-label" for="bayiKendisi">
                                    @(bayiBilgi?.Unvan ?? "Bayi Adına")
                                </label>
                            </div>
                            <div class="form-check">
                                <input class="form-check-input" type="radio" name="bildirimSahibi" id="musteriAdina" value="musteri">
                                <label class="form-check-label" for="musteriAdina">
                                    Müşteri Adına
                                </label>
                            </div>
                        </div>
                        <div class="col-md-4" id="musteriSecimDiv" style="display: none;">
                            <label class="form-label">Müşteri Seçiniz <span class="text-danger">*</span></label>
                            <select name="SecilenMusteriId" id="secilenMusteriId" class="form-select">
                                <option value="">-- Müşteri Seçin --</option>
                                @if (bayiMusterileri != null && bayiMusterileri.Any())
                                {
                                    foreach (var musteri in bayiMusterileri)
                                    {
                                        <option value="@musteri.Id">@musteri.Ad @musteri.Soyad (@musteri.KullaniciAdi)</option>
                                    }
                                }
                            </select>
                        </div>
                    }
                </div>
                <hr class="my-4" />
                <!-- Form Alanları -->
                <div class="row mb-3">
                    <div class="col-md-3">
                        <label class="form-label">Bildirim Tipi <span class="text-danger">*</span></label>
                        <select name="Tipi" class="form-select" required>
                            <option value="">-- Seçiniz --</option>
                            <option value="ARGE">ARGE (Geliştirme Önerisi)</option>
                            <option value="Hata">Hata Bildirimi</option>
                        </select>
                    </div>
                    <div class="col-md-3">
                        <label class="form-label">Ad <span class="text-danger">*</span></label>
                        <input type="text" name="Adi" class="form-control" required maxlength="50" />
                    </div>
                    <div class="col-md-3">
                        <label class="form-label">Soyad <span class="text-danger">*</span></label>
                        <input type="text" name="Soyadi" class="form-control" required maxlength="50" />
                    </div>
                    <div class="col-md-3">
                        <label class="form-label">Lisans Tipi</label>
                        <select name="LisansTipId" id="lisansTipSelect" class="form-select">
                            <option value="">-- Seçiniz --</option>
                            @foreach (var tip in ViewBag.LisansTipleri as List<WepApp.Models.LisansTip>)
                            {
                                <option value="@tip.Id">@tip.Adi</option>
                            }
                        </select>
                    </div>
                </div>
                <div class="row mb-4">
                    <div class="col-md-12">
                        <label class="form-label">Açıklama / Detay <span class="text-danger">*</span></label>
                        <textarea name="Metni" class="form-control" rows="6" required
                                  placeholder="Lütfen detaylı açıklama giriniz..."></textarea>
                    </div>
                </div>
                <div class="row mb-4">
                    <div class="col-md-12">
                        <label class="form-label">Dosya Eki (Opsiyonel)</label>
                        <input type="file" name="Dosya" class="form-control"
                               accept=".pdf,.doc,.docx,.xls,.xlsx,.jpg,.jpeg,.png" />
                        <small class="text-muted">Max 10MB - PDF, Word, Excel, JPG, PNG</small>
                    </div>
                </div>
                <div class="text-end">
                    <button type="reset" class="btn btn-secondary me-2" id="formTemizle">Temizle</button>
                    <button type="submit" class="btn btn-success px-5">
                        <i class="fas fa-paper-plane me-2"></i> Gönder
                    </button>
                </div>
            </form>
        </div>
    </div>

    @if (kullaniciTipi == "Bayi")
    {
        <!-- Filtre Butonları -->
        <div class="filtre-butonlari">
            <a href="@Url.Action("Index", new { filtre = "tumu", tip = ViewBag.SelectedTip, durum = ViewBag.SelectedDurum })"
               class="btn @(ViewBag.SeciliFiltre == "tumu" ? "btn-primary active" : "btn-outline-primary")">
                <i class="fas fa-layer-group me-1"></i> Tümü
            </a>
            <a href="@Url.Action("Index", new { filtre = "bayi", tip = ViewBag.SelectedTip, durum = ViewBag.SelectedDurum })"
               class="btn @(ViewBag.SeciliFiltre == "bayi" ? "btn-info active" : "btn-outline-info")">
                <i class="fas fa-store me-1"></i> Kendi Bayim Adına
            </a>
            <a href="@Url.Action("Index", new { filtre = "musteri", tip = ViewBag.SelectedTip, durum = ViewBag.SelectedDurum })"
               class="btn @(ViewBag.SeciliFiltre == "musteri" ? "btn-success active" : "btn-outline-success")">
                <i class="fas fa-users me-1"></i> Bağlı Müşterilerim Adına
            </a>
        </div>
    }

    @if (kullaniciTipi == "Bayi" && ViewBag.SeciliFiltre == "tumu")
    {
        <!-- Bayi Adına Kayıtlar -->
        <div class="card shadow mb-4">
            <div class="card-header bg-info text-white">
                <h5 class="mb-0"><i class="fas fa-store me-2"></i> Kendi Bayim Adına Bildirimler</h5>
            </div>
            <div class="card-body">
                @if (bayiListe.Any())
                {
                    <div class="table-responsive">
                        <table class="table table-hover table-striped">
                            <thead>
                                <tr>
                                    <th>Tarih</th>
                                    <th>Tip</th>
                                    <th>Ad Soyad</th>
                                    <th>Lisans Tipi</th>
                                    <th>Açıklama</th>
                                    <th>Dosya</th>
                                    <th>Cevap Durumu</th>
                                    <th>İşlemler</th>
                                </tr>
                            </thead>
                            <tbody>
                                @foreach (var item in bayiListe)
                                {
                                    var lisansAdi = item.LisansTip?.Adi ?? "-";
                                    var cevapTarihi = "";
                                    var kisaCevap = "";
                                    var durumBilgi = "";

                                    if (item.DistributorCevapVerdiMi && !string.IsNullOrEmpty(item.DistributorCevap))
                                    {
                                        cevapTarihi = item.DistributorCevapTarihi?.ToString("dd.MM.yyyy HH:mm") ?? "";
                                        kisaCevap = item.DistributorCevap.Length > 50
                                        ? item.DistributorCevap.Substring(0, 50) + "..."
                                        : item.DistributorCevap;
                                        durumBilgi = item.ARGEDurum?.Adi ?? "Cevap Verildi";
                                    }
                                    else
                                    {
                                        cevapTarihi = "Henüz cevap verilmedi";
                                        durumBilgi = item.ARGEDurum?.Adi ?? "Beklemede";
                                    }

                                    <tr data-id="@item.Id">
                                        <td>@item.EklenmeTarihi.ToString("dd.MM.yyyy HH:mm")</td>
                                        <td>
                                            <span class="badge @(item.Tipi == "ARGE" ? "bg-info" : "bg-danger")">
                                                @item.Tipi
                                            </span>
                                        </td>
                                        <td>@item.Adi @item.Soyadi</td>
                                        <td>@lisansAdi</td>
                                        <td>
                                            <div class="text-truncate" style="max-width: 200px;"
                                                 title="@item.Metni">
                                                @(item.Metni.Length > 80 ? item.Metni.Substring(0, 80) + "..." : item.Metni)
                                            </div>
                                        </td>
                                        <td>
                                            @if (!string.IsNullOrEmpty(item.DosyaYolu))
                                            {
                                                <a href="@item.DosyaYolu" target="_blank"
                                                   class="btn btn-sm btn-outline-primary" title="Dosyayı İndir">
                                                    <i class="fas fa-download"></i>
                                                </a>
                                            }
                                            else
                                            {
                                                <span class="text-muted">-</span>
                                            }
                                        </td>
                                        <td>
                                            <div class="d-flex flex-column">
                                                @if (item.DistributorCevapVerdiMi && !string.IsNullOrEmpty(item.DistributorCevap))
                                                {
                                                    <div class="cevap-icerik" data-cevap="@item.DistributorCevap"
                                                         data-id="@item.Id" title="Cevabı görmek için tıklayın">
                                                        @kisaCevap
                                                    </div>
                                                }
                                                <small class="cevap-tarihi">@cevapTarihi</small>
                                                <div class="durum-bilgi">
                                                    <i class="fas fa-info-circle me-1"></i>
                                                    Durum: @durumBilgi
                                                </div>
                                            </div>
                                        </td>
                                        <td>
                                            @if (item.ARGEDurumId == 1 && !item.DistributorCevapVerdiMi)
                                            {
                                                <button class="btn btn-sm btn-warning text-white btn-duzenle"
                                                        data-id="@item.Id" title="Düzenle">
                                                    <i class="fas fa-edit"></i>
                                                </button>
                                                <button class="btn btn-sm btn-danger btn-sil"
                                                        data-id="@item.Id" title="Sil">
                                                    <i class="fas fa-trash"></i>
                                                </button>
                                            }
                                            else
                                            {
                                                <span class="text-muted">Düzenlenemez</span>
                                            }
                                        </td>
                                    </tr>
                                }
                            </tbody>
                        </table>
                    </div>
                }
                else
                {
                    <div class="text-center py-3">
                        <p class="text-muted mb-0">Bayi adına henüz bildirim gönderilmemiş.</p>
                    </div>
                }
            </div>
        </div>

        <!-- Müşteri Adına Kayıtlar -->
        <div class="card shadow mb-4">
            <div class="card-header bg-success text-white">
                <h5 class="mb-0"><i class="fas fa-users me-2"></i> Bağlı Müşterilerim Adına Bildirimler (Son 10 Kayıt)</h5>
            </div>
            <div class="card-body">
                @if (musteriListe.Any())
                {
                    <div class="table-responsive">
                        <table class="table table-hover table-striped">
                            <thead>
                                <tr>
                                    <th>Tarih</th>
                                    <th>Tip</th>
                                    <th>Ad Soyad</th>
                                    <th>Müşteri</th>
                                    <th>Lisans Tipi</th>
                                    <th>Açıklama</th>
                                    <th>Dosya</th>
                                    <th>Cevap Durumu</th>
                                    <th>İşlemler</th>
                                </tr>
                            </thead>
                            <tbody>
                                @foreach (var item in musteriListe)
                                {
                                    var lisansAdi = item.LisansTip?.Adi ?? "-";
                                    var cevapTarihi = "";
                                    var kisaCevap = "";
                                    var durumBilgi = "";
                                    var musteriAdi = item.Musteri != null ? item.Musteri.Ad + " " + item.Musteri.Soyad : "Belirtilmemiş";

                                    if (item.DistributorCevapVerdiMi && !string.IsNullOrEmpty(item.DistributorCevap))
                                    {
                                        cevapTarihi = item.DistributorCevapTarihi?.ToString("dd.MM.yyyy HH:mm") ?? "";
                                        kisaCevap = item.DistributorCevap.Length > 50
                                        ? item.DistributorCevap.Substring(0, 50) + "..."
                                        : item.DistributorCevap;
                                        durumBilgi = item.ARGEDurum?.Adi ?? "Cevap Verildi";
                                    }
                                    else
                                    {
                                        cevapTarihi = "Henüz cevap verilmedi";
                                        durumBilgi = item.ARGEDurum?.Adi ?? "Beklemede";
                                    }

                                    <tr data-id="@item.Id">
                                        <td>@item.EklenmeTarihi.ToString("dd.MM.yyyy HH:mm")</td>
                                        <td>
                                            <span class="badge @(item.Tipi == "ARGE" ? "bg-info" : "bg-danger")">
                                                @item.Tipi
                                            </span>
                                        </td>
                                        <td>@item.Adi @item.Soyadi</td>
                                        <td>
                                            <span class="sahibi-badge-musteri">
                                                <i class="fas fa-user me-1"></i>@musteriAdi
                                            </span>
                                        </td>
                                        <td>@lisansAdi</td>
                                        <td>
                                            <div class="text-truncate" style="max-width: 200px;"
                                                 title="@item.Metni">
                                                @(item.Metni.Length > 80 ? item.Metni.Substring(0, 80) + "..." : item.Metni)
                                            </div>
                                        </td>
                                        <td>
                                            @if (!string.IsNullOrEmpty(item.DosyaYolu))
                                            {
                                                <a href="@item.DosyaYolu" target="_blank"
                                                   class="btn btn-sm btn-outline-primary" title="Dosyayı İndir">
                                                    <i class="fas fa-download"></i>
                                                </a>
                                            }
                                            else
                                            {
                                                <span class="text-muted">-</span>
                                            }
                                        </td>
                                        <td>
                                            <div class="d-flex flex-column">
                                                @if (item.DistributorCevapVerdiMi && !string.IsNullOrEmpty(item.DistributorCevap))
                                                {
                                                    <div class="cevap-icerik" data-cevap="@item.DistributorCevap"
                                                         data-id="@item.Id" title="Cevabı görmek için tıklayın">
                                                        @kisaCevap
                                                    </div>
                                                }
                                                <small class="cevap-tarihi">@cevapTarihi</small>
                                                <div class="durum-bilgi">
                                                    <i class="fas fa-info-circle me-1"></i>
                                                    Durum: @durumBilgi
                                                </div>
                                            </div>
                                        </td>
                                        <td>
                                            @if (item.ARGEDurumId == 1 && !item.DistributorCevapVerdiMi)
                                            {
                                                <button class="btn btn-sm btn-warning text-white btn-duzenle"
                                                        data-id="@item.Id" title="Düzenle">
                                                    <i class="fas fa-edit"></i>
                                                </button>
                                                <button class="btn btn-sm btn-danger btn-sil"
                                                        data-id="@item.Id" title="Sil">
                                                    <i class="fas fa-trash"></i>
                                                </button>
                                            }
                                            else
                                            {
                                                <span class="text-muted">Düzenlenemez</span>
                                            }
                                        </td>
                                    </tr>
                                }
                            </tbody>
                        </table>
                    </div>
                }
                else
                {
                    <div class="text-center py-3">
                        <p class="text-muted mb-0">Bağlı müşteriler adına henüz bildirim gönderilmemiş.</p>
                    </div>
                }
            </div>
        </div>
    }
    else
    {
        <!-- Müşteri Listesi (Tek Kart) veya Bayi filtrelenmiş liste -->
        <div class="card shadow">
            <div class="card-header bg-gradient-primary text-white d-flex justify-content-between align-items-center">
                <h4 class="mb-0"><i class="fas fa-list-alt me-2"></i> Bildirimlerim (@totalCount kayıt)</h4>
                <div>
                    <a href="@Url.Action("Index", new { page = currentPage, tip = ViewBag.SelectedTip, durum = ViewBag.SelectedDurum, filtre = ViewBag.SeciliFiltre })" class="btn btn-light btn-sm">
                        <i class="fas fa-sync-alt me-1"></i> Yenile
                    </a>
                </div>
            </div>
            <div class="card-body">
                @if (Model != null && Model.Any())
                {
                    <div class="table-responsive">
                        <table class="table table-hover table-striped" id="argeTablo">
                            <thead>
                                <tr>
                                    <th>Tarih</th>
                                    <th>Tip</th>
                                    <th>Ad Soyad</th>
                                    <th>Kayıt Sahibi</th>
                                    <th>Lisans Tipi</th>
                                    <th>Açıklama</th>
                                    <th>Dosya</th>
                                    <th>Cevap Durumu</th>
                                    <th>İşlemler</th>
                                </tr>
                            </thead>
                            <tbody>
                                @foreach (var item in Model)
                                {
                                    var lisansAdi = item.LisansTip?.Adi ?? "-";
                                    var kayitSahibi = "";
                                    var cevapTarihi = "";
                                    var kisaCevap = "";
                                    var durumBilgi = "";

                                    if (item.Musteri != null)
                                    {
                                        kayitSahibi = $"Müşteri: {item.Musteri.Ad} {item.Musteri.Soyad}";
                                    }
                                    else if (item.Bayi != null)
                                    {
                                        kayitSahibi = $"Bayi: {item.Bayi.Unvan}";
                                    }

                                    if (item.DistributorCevapVerdiMi && !string.IsNullOrEmpty(item.DistributorCevap))
                                    {
                                        cevapTarihi = item.DistributorCevapTarihi?.ToString("dd.MM.yyyy HH:mm") ?? "";
                                        kisaCevap = item.DistributorCevap.Length > 50
                                        ? item.DistributorCevap.Substring(0, 50) + "..."
                                        : item.DistributorCevap;
                                        durumBilgi = item.ARGEDurum?.Adi ?? "Cevap Verildi";
                                    }
                                    else
                                    {
                                        cevapTarihi = "Henüz cevap verilmedi";
                                        durumBilgi = item.ARGEDurum?.Adi ?? "Beklemede";
                                    }

                                    <tr data-id="@item.Id" class="@(kullaniciTipi == "Bayi" && item.BayiId == ViewBag.KullaniciId ? "kayit-sahibi" : "")">
                                        <td>@item.EklenmeTarihi.ToString("dd.MM.yyyy HH:mm")</td>
                                        <td>
                                            <span class="badge @(item.Tipi == "ARGE" ? "bg-info" : "bg-danger")">
                                                @item.Tipi
                                            </span>
                                        </td>
                                        <td>@item.Adi @item.Soyadi</td>
                                        <td>
                                            <small class="text-muted">@kayitSahibi</small>
                                        </td>
                                        <td>@lisansAdi</td>
                                        <td>
                                            <div class="text-truncate" style="max-width: 250px;"
                                                 title="@item.Metni">
                                                @(item.Metni.Length > 80 ? item.Metni.Substring(0, 80) + "..." : item.Metni)
                                            </div>
                                        </td>
                                        <td>
                                            @if (!string.IsNullOrEmpty(item.DosyaYolu))
                                            {
                                                <a href="@item.DosyaYolu" target="_blank"
                                                   class="btn btn-sm btn-outline-primary" title="Dosyayı İndir">
                                                    <i class="fas fa-download"></i>
                                                </a>
                                            }
                                            else
                                            {
                                                <span class="text-muted">-</span>
                                            }
                                        </td>
                                        <td>
                                            <div class="d-flex flex-column">
                                                @if (item.DistributorCevapVerdiMi && !string.IsNullOrEmpty(item.DistributorCevap))
                                                {
                                                    <div class="cevap-icerik" data-cevap="@item.DistributorCevap"
                                                         data-id="@item.Id" title="Cevabı görmek için tıklayın">
                                                        @kisaCevap
                                                    </div>
                                                }
                                                <small class="cevap-tarihi">@cevapTarihi</small>
                                                <div class="durum-bilgi">
                                                    <i class="fas fa-info-circle me-1"></i>
                                                    Durum: @durumBilgi
                                                </div>
                                            </div>
                                        </td>
                                        <td>
                                            @if ((kullaniciTipi == "Bayi" && (item.BayiId == ViewBag.KullaniciId || (item.Musteri != null && item.Musteri.BayiId == ViewBag.KullaniciId))) ||
                                           (kullaniciTipi == "Musteri" && item.MusteriId == ViewBag.KullaniciId))
                                            {
                                                @if (item.ARGEDurumId == 1 && !item.DistributorCevapVerdiMi)
                                                {
                                                    <button class="btn btn-sm btn-warning text-white btn-duzenle"
                                                            data-id="@item.Id" title="Düzenle">
                                                        <i class="fas fa-edit"></i>
                                                    </button>
                                                    <button class="btn btn-sm btn-danger btn-sil"
                                                            data-id="@item.Id" title="Sil">
                                                        <i class="fas fa-trash"></i>
                                                    </button>
                                                }
                                                else
                                                {
                                                    <span class="text-muted">Düzenlenemez</span>
                                                }
                                            }
                                            else
                                            {
                                                <span class="text-muted">-</span>
                                            }
                                        </td>
                                    </tr>
                                }
                            </tbody>
                        </table>
                    </div>

                    @if (totalPages > 1)
                    {
                        <nav aria-label="Sayfa navigasyonu">
                            <ul class="pagination justify-content-center mt-4">
                                @if (currentPage > 1)
                                {
                                    <li class="page-item">
                                        <a class="page-link" asp-action="Index"
                                           asp-route-page="1"
                                           asp-route-tip="@ViewBag.SelectedTip"
                                           asp-route-durum="@ViewBag.SelectedDurum"
                                           asp-route-filtre="@ViewBag.SeciliFiltre">
                                            <i class="fas fa-angle-double-left"></i>
                                        </a>
                                    </li>
                                    <li class="page-item">
                                        <a class="page-link" asp-action="Index"
                                           asp-route-page="@(currentPage-1)"
                                           asp-route-tip="@ViewBag.SelectedTip"
                                           asp-route-durum="@ViewBag.SelectedDurum"
                                           asp-route-filtre="@ViewBag.SeciliFiltre">
                                            <i class="fas fa-angle-left"></i>
                                        </a>
                                    </li>
                                }

                                @{
                                    int start = Math.Max(1, currentPage - 2);
                                    int end = Math.Min(totalPages, currentPage + 2);
                                }

                                @for (int i = start; i <= end; i++)
                                {
                                    <li class="page-item @(i == currentPage ? "active" : "")">
                                        <a class="page-link" asp-action="Index"
                                           asp-route-page="@i"
                                           asp-route-tip="@ViewBag.SelectedTip"
                                           asp-route-durum="@ViewBag.SelectedDurum"
                                           asp-route-filtre="@ViewBag.SeciliFiltre">@i</a>
                                    </li>
                                }

                                @if (currentPage < totalPages)
                                {
                                    <li class="page-item">
                                        <a class="page-link" asp-action="Index"
                                           asp-route-page="@(currentPage+1)"
                                           asp-route-tip="@ViewBag.SelectedTip"
                                           asp-route-durum="@ViewBag.SelectedDurum"
                                           asp-route-filtre="@ViewBag.SeciliFiltre">
                                            <i class="fas fa-angle-right"></i>
                                        </a>
                                    </li>
                                    <li class="page-item">
                                        <a class="page-link" asp-action="Index"
                                           asp-route-page="@totalPages"
                                           asp-route-tip="@ViewBag.SelectedTip"
                                           asp-route-durum="@ViewBag.SelectedDurum"
                                           asp-route-filtre="@ViewBag.SeciliFiltre">
                                            <i class="fas fa-angle-double-right"></i>
                                        </a>
                                    </li>
                                }
                            </ul>
                        </nav>
                    }
                }
                else
                {
                    <div class="text-center py-5">
                        <i class="fas fa-inbox fa-4x text-muted mb-3"></i>
                        <p class="text-muted fs-5">Henüz bildirim göndermediniz.</p>
                    </div>
                }
            </div>
        </div>
    }
</div>

<!-- Düzenleme Modal -->
<div class="modal fade" id="duzenleModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <form id="duzenleForm" enctype="multipart/form-data">
                <div class="modal-header bg-warning text-white">
                    <h5 class="modal-title"><i class="fas fa-edit me-2"></i> Bildirim Düzenle</h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    @Html.AntiForgeryToken()
                    <input type="hidden" name="Id" id="duzenleId" />
                    <div class="alert alert-info mb-3" id="kayitSahibiBilgi">
                        <i class="fas fa-info-circle me-2"></i>
                        <span id="kayitSahibiText"></span>
                    </div>
                    @if (kullaniciTipi == "Bayi")
                    {
                        <div class="row mb-3" id="duzenleMusteriSecimDiv">
                            <div class="col-md-12">
                                <label class="form-label">Kayıt Sahibi Değiştir</label>
                                <div class="form-check">
                                    <input class="form-check-input" type="radio" name="duzenleBildirimSahibi" id="duzenleBayiKendisi" value="bayi">
                                    <label class="form-check-label" for="duzenleBayiKendisi">
                                        @(bayiBilgi?.Unvan ?? "Bayi Adına")
                                    </label>
                                </div>
                                <div class="form-check">
                                    <input class="form-check-input" type="radio" name="duzenleBildirimSahibi" id="duzenleMusteriAdina" value="musteri">
                                    <label class="form-check-label" for="duzenleMusteriAdina">
                                        Müşteri Adına
                                    </label>
                                </div>
                                <div class="mt-2" id="duzenleMusteriSelectDiv" style="display: none;">
                                    <select name="SecilenMusteriId" id="duzenleSecilenMusteriId" class="form-select">
                                        <option value="">-- Müşteri Seçin --</option>
                                        @if (bayiMusterileri != null && bayiMusterileri.Any())
                                        {
                                            foreach (var musteri in bayiMusterileri)
                                            {
                                                <option value="@musteri.Id">@musteri.Ad @musteri.Soyad (@musteri.KullaniciAdi)</option>
                                            }
                                        }
                                    </select>
                                </div>
                            </div>
                        </div>
                    }
                    <div class="row mb-3">
                        <div class="col-md-6">
                            <label class="form-label">Bildirim Tipi <span class="text-danger">*</span></label>
                            <select name="Tipi" id="duzenleTipi" class="form-select" required>
                                <option value="">-- Seçiniz --</option>
                                <option value="ARGE">ARGE</option>
                                <option value="Hata">Hata</option>
                            </select>
                        </div>
                        <div class="col-md-6">
                            <label class="form-label">Lisans Tipi</label>
                            <select name="LisansTipId" id="duzenleLisansTipId" class="form-select">
                                <option value="">-- Seçiniz --</option>
                                @foreach (var tip in ViewBag.LisansTipleri as List<WepApp.Models.LisansTip>)
                                {
                                    <option value="@tip.Id">@tip.Adi</option>
                                }
                            </select>
                        </div>
                    </div>
                    <div class="row mb-3">
                        <div class="col-md-6">
                            <label class="form-label">Ad <span class="text-danger">*</span></label>
                            <input type="text" name="Adi" id="duzenleAdi" class="form-control" required maxlength="50" />
                        </div>
                        <div class="col-md-6">
                            <label class="form-label">Soyad <span class="text-danger">*</span></label>
                            <input type="text" name="Soyadi" id="duzenleSoyadi" class="form-control" required maxlength="50" />
                        </div>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Açıklama / Detay <span class="text-danger">*</span></label>
                        <textarea name="Metni" id="duzenleMetni" class="form-control" rows="6" required></textarea>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Dosya Eki (Mevcut: <span id="mevcutDosya">Yok</span>)</label>
                        <input type="file" name="Dosya" class="form-control"
                               accept=".pdf,.doc,.docx,.xls,.xlsx,.jpg,.jpeg,.png" />
                        <small class="text-muted">Boş bırakılırsa mevcut dosya korunur</small>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">İptal</button>
                    <button type="submit" class="btn btn-warning">Kaydet</button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Cevap Görüntüleme Modal -->
<div class="modal fade" id="cevapModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content cevap-modal-content">
            <div class="modal-header bg-success text-white">
                <h5 class="modal-title">
                    <i class="fas fa-comment-dots me-2"></i> Distributor Cevabı
                </h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div class="row mb-3">
                    <div class="col-md-6">
                        <div class="alert alert-info">
                            <i class="fas fa-calendar-alt me-2"></i>
                            <strong>Cevap Tarihi:</strong> <span id="modalCevapTarihi"></span>
                        </div>
                    </div>
                    <div class="col-md-6">
                        <div class="alert alert-warning">
                            <i class="fas fa-info-circle me-2"></i>
                            <strong>Güncel Durum:</strong> <span id="modalDurumAdi"></span>
                        </div>
                    </div>
                </div>
                <div class="mb-3">
                    <label class="form-label fw-bold">Distributor Cevabı:</label>
                    <div class="border rounded p-4 bg-white" style="min-height: 200px; white-space: pre-line;" id="modalCevapMetni">
                        <div class="text-center py-5">
                            <div class="spinner-border text-success" role="status"></div>
                            <p class="mt-3">Cevap bilgileri yükleniyor...</p>
                        </div>
                    </div>
                </div>
                <div class="alert alert-light border">
                    <i class="fas fa-lightbulb me-2 text-warning"></i>
                    <small>
                        Bu cevap firma yetkilisi tarafından gönderilmiştir. Ek bilgi veya sorularınız için
                        bayi/distributor yetkilinizle iletişime geçebilirsiniz.
                    </small>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                    <i class="fas fa-times me-2"></i> Kapat
                </button>
            </div>
        </div>
    </div>
</div>

@section Script {
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <script>
        function showMessage(type, text) {
            const container = document.getElementById('msgContainer');
            container.innerHTML = `
                <div class="alert alert-${type} alert-dismissible fade show shadow" role="alert">
                    <div class="d-flex align-items-center">
                        <i class="fas ${type === 'success' ? 'fa-check-circle' : 'fa-exclamation-triangle'} me-2"></i>
                        <div>${text}</div>
                    </div>
                    <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
                </div>
            `;
            setTimeout(() => {
                const alert = container.querySelector('.alert');
                if (alert) {
                    alert.classList.remove('show');
                    setTimeout(() => container.innerHTML = '', 300);
                }
            }, 5000);
        }

        function submitForm(url, formData, successCallback) {
            $.ajax({
                url: url,
                type: 'POST',
                data: formData,
                processData: false,
                contentType: false,
                success: function(res) {
                    if (res.success) {
                        successCallback(res);
                    } else {
                        showMessage('danger', res.message || 'İşlem başarısız!');
                    }
                },
                error: function(xhr) {
                    showMessage('danger', 'Sunucu hatası: ' + xhr.statusText);
                }
            });
        }

        $(document).on('click', '.cevap-icerik', function() {
            const bildirimId = $(this).data('id');
            const tamCevap = $(this).data('cevap');
            if (tamCevap) {
                $('#modalCevapMetni').text(tamCevap);
                $('#modalCevapTarihi').text($(this).closest('td').find('.cevap-tarihi').text());
                $('#modalDurumAdi').text($(this).closest('td').find('.durum-bilgi').text().replace('Durum: ', ''));
                $('#cevapModal').modal('show');
                return;
            }
            $('#modalCevapMetni').html(
                '<div class="text-center py-5">' +
                '<div class="spinner-border text-success" role="status"></div>' +
                '<p class="mt-3">Cevap bilgileri yükleniyor...</p>' +
                '</div>'
            );
            $.ajax({
                url: '@Url.Action("CevapDetayGetir")',
                type: 'GET',
                data: { id: bildirimId },
                dataType: 'json',
                success: function(response) {
                    if (response.success) {
                        $('#modalCevapMetni').text(response.distributorCevap || 'Cevap bulunamadı.');
                        $('#modalCevapTarihi').text(response.distributorCevapTarihi || 'Belirtilmemiş');
                        $('#modalDurumAdi').text(response.argeDurumAdi || 'Bilinmiyor');
                        $('#cevapModal').modal('show');
                    } else {
                        showMessage('warning', response.message || 'Cevap bilgileri alınamadı.');
                    }
                },
                error: function() {
                    $('#modalCevapMetni').html(
                        '<div class="alert alert-danger">' +
                        '<i class="fas fa-exclamation-triangle me-2"></i>' +
                        'Cevap bilgileri alınırken bir hata oluştu.' +
                        '</div>'
                    );
                }
            });
        });

        function yukleLisansTipleri(musteriId = null) {
            var select = $('#lisansTipSelect');
            select.empty();
            select.append('<option value="">-- Seçiniz --</option>');

            if (musteriId) {
                $.get('@Url.Action("GetLisansTipleriByMusteri")', { musteriId: musteriId }, function(data) {
                    if (data && data.length > 0) {
                        $.each(data, function(i, tip) {
                            select.append('<option value="' + tip.id + '">' + tip.adi + '</option>');
                        });
                    } else {
                        select.append('<option value="" disabled>Lisans tipi bulunamadı</option>');
                    }
                }).fail(function() {
                    showMessage('danger', 'Lisans tipleri yüklenemedi.');
                });
            } else {
                select.append('<option value="" disabled>Lütfen müşteri seçin</option>');
            }
        }

        $(document).ready(function() {
        @if (kullaniciTipi == "Bayi")
        {
            <text>
                            $('input[name="bildirimSahibi"]').change(function() {
                                var secili = $(this).val();
                                if (secili === 'musteri') {
                                    $('#musteriSecimDiv').show();
                                    var musteriId = $('#secilenMusteriId').val();
                                    if (musteriId) {
                                        yukleLisansTipleri(musteriId);
                                    } else {
                                        yukleLisansTipleri();
                                    }
                                } else {
                                    $('#musteriSecimDiv').hide();
                                    $('#lisansTipSelect').empty();
                                    $('#lisansTipSelect').append('<option value="">-- Seçiniz --</option>');
                @foreach (var tip in ViewBag.LisansTipleri as List<WepApp.Models.LisansTip>)
                {
                    <text>
                                                    $('#lisansTipSelect').append('<option value="@tip.Id">@tip.Adi</option>');
                    </text>
                }
                                }
                            });

                            $('#secilenMusteriId').change(function() {
                                var musteriId = $(this).val();
                                if ($('input[name="bildirimSahibi"]:checked').val() === 'musteri') {
                                    yukleLisansTipleri(musteriId);
                                }
                            });

                            // Sayfa yüklendiğinde başlangıç kontrolü
                            if ($('input[name="bildirimSahibi"]:checked').val() === 'musteri') {
                                var musteriId = $('#secilenMusteriId').val();
                                yukleLisansTipleri(musteriId);
                            }
            </text>
        }

            $('#formTemizle').click(function() {
                $('input[name="bildirimSahibi"][value="bayi"]').prop('checked', true);
                $('#musteriSecimDiv').hide();
                $('#secilenMusteriId').val('');
        @if (kullaniciTipi == "Bayi")
        {
            <text>
                                $('#lisansTipSelect').empty().append('<option value="">-- Seçiniz --</option>');
                @foreach (var tip in ViewBag.LisansTipleri as List<WepApp.Models.LisansTip>)
                {
                    <text>
                                                $('#lisansTipSelect').append('<option value="@tip.Id">@tip.Adi</option>');
                    </text>
                }
            </text>
        }
            });

            $('#ekleForm').submit(function(e) {
                e.preventDefault();
        @if (kullaniciTipi == "Bayi")
        {
            <text>
                                var bildirimSahibi = $('input[name="bildirimSahibi"]:checked').val();
                                if (bildirimSahibi === 'musteri' && !$('#secilenMusteriId').val()) {
                                    showMessage('danger', 'Lütfen bir müşteri seçiniz.');
                                    return false;
                                }
            </text>
        }
                const formData = new FormData(this);
                submitForm('@Url.Action("Ekle")', formData, function(res) {
                    showMessage('success', res.message);
                    $('#ekleForm')[0].reset();
        @if (kullaniciTipi == "Bayi")
        {
            <text>
                                    $('input[name="bildirimSahibi"][value="bayi"]').prop('checked', true);
                                    $('#musteriSecimDiv').hide();
                                    $('#secilenMusteriId').val('');
                                    $('#lisansTipSelect').empty().append('<option value="">-- Seçiniz --</option>');
                @foreach (var tip in ViewBag.LisansTipleri as List<WepApp.Models.LisansTip>)
                {
                    <text>
                                                    $('#lisansTipSelect').append('<option value="@tip.Id">@tip.Adi</option>');
                    </text>
                }
            </text>
        }
                    setTimeout(() => location.reload(), 1500);
                });
            });

            $(document).on('click', '.btn-duzenle', function() {
                const id = $(this).data('id');
                $.get('@Url.Action("GetirDuzenle")', { id: id }, function(data) {
                    if (data) {
                        $('#duzenleId').val(data.id);
                        $('#duzenleTipi').val(data.tipi);
                        $('#duzenleAdi').val(data.adi);
                        $('#duzenleSoyadi').val(data.soyadi);
                        $('#duzenleMetni').val(data.metni);
                        $('#duzenleLisansTipId').val(data.lisansTipId || '');
                        var sahipText = '';
                        if (data.musteriId) {
                            sahipText = 'Müşteri: ' + (data.musteriAdi || 'Bilinmiyor');
                        } else if (data.bayiId) {
                            sahipText = 'Bayi: ' + (data.bayiAdi || 'Bilinmiyor');
                        }
                        $('#kayitSahibiText').text('Bu kayıt ' + sahipText + ' adına oluşturulmuştur.');
        @if (kullaniciTipi == "Bayi")
        {
            <text>
                                        $('#duzenleMusteriSecimDiv').show();
                                        if (data.musteriId) {
                                            $('input[name="duzenleBildirimSahibi"][value="musteri"]').prop('checked', true);
                                            $('#duzenleMusteriSelectDiv').show();
                                            $('#duzenleSecilenMusteriId').val(data.musteriId);
                                        } else {
                                            $('input[name="duzenleBildirimSahibi"][value="bayi"]').prop('checked', true);
                                            $('#duzenleMusteriSelectDiv').hide();
                                            $('#duzenleSecilenMusteriId').val('');
                                        }
            </text>
        }
        else
        {
            <text>
                                        $('#duzenleMusteriSecimDiv').hide();
            </text>
        }
                        $('#mevcutDosya').text(data.dosyaYolu ? 'Var' : 'Yok');
                        if (data.dosyaYolu) {
                            $('#mevcutDosya').html(`<a href="${data.dosyaYolu}" target="_blank">Dosyayı Gör</a>`);
                        }
                        $('#duzenleModal').modal('show');
                    }
                }).fail(function() {
                    showMessage('danger', 'Kayıt bilgileri alınamadı.');
                });
            });

            $('#duzenleForm').submit(function(e) {
                e.preventDefault();
        @if (kullaniciTipi == "Bayi")
        {
            <text>
                                if ($('input[name="duzenleBildirimSahibi"]:checked').val() === 'musteri') {
                                    if (!$('#duzenleSecilenMusteriId').val()) {
                                        showMessage('danger', 'Lütfen bir müşteri seçiniz.');
                                        return false;
                                    }
                                }
            </text>
        }
                const formData = new FormData(this);
                submitForm('@Url.Action("Duzenle")', formData, function(res) {
                    showMessage('success', res.message);
                    $('#duzenleModal').modal('hide');
                    setTimeout(() => location.reload(), 1500);
                });
            });

            $(document).on('click', '.btn-sil', function() {
                const id = $(this).data('id');
                Swal.fire({
                    title: 'Emin misiniz?',
                    text: "Bu kayıt silinecek!",
                    icon: 'warning',
                    showCancelButton: true,
                    confirmButtonColor: '#d33',
                    confirmButtonText: 'Evet, Sil',
                    cancelButtonText: 'İptal',
                    reverseButtons: true
                }).then((result) => {
                    if (result.isConfirmed) {
                        $.post('@Url.Action("Sil")', {
                            id: id,
                            __RequestVerificationToken: $('input[name="__RequestVerificationToken"]').val()
                        })
                        .done(function(res) {
                            if (res.success) {
                                showMessage('success', res.message);
                                location.reload();
                            } else {
                                showMessage('danger', res.message);
                            }
                        })
                        .fail(function() {
                            showMessage('danger', 'Sunucuyla iletişim kurulamadı.');
                        });
                    }
                });
            });

            setTimeout(() => {
                $('#msgContainer').empty();
            }, 10000);
        });
    </script>
}