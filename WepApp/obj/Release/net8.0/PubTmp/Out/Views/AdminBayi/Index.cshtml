@using WebApp.Models
@using WepApp.Models
@model List<WepApp.Controllers.BayiViewModel>
@{
    ViewData["Title"] = "Bayi Yönetimi";
    Layout = "~/Views/Shared/_LayoutWebAdmin.cshtml";
    bool isHiyerarsiSayfasi = ViewContext.RouteData.Values["action"]?.ToString() == "BayiSemasi"
                              || ViewContext.RouteData.Values["action"]?.ToString() == "TumHiyerarsi";
}
<style>
    .hover-lift {
        transition: all 0.3s ease;
    }

        .hover-lift:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 20px rgba(0,0,0,0.15) !important;
        }
    /* Sözleşme Dosyaları Stilleri */
    .sozlesme-dosya-container {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(250px, 1fr));
        gap: 15px;
        margin-top: 15px;
    }

    .sozlesme-dosya-item {
        border: 1px solid #dee2e6;
        border-radius: 8px;
        padding: 15px;
        background: white;
        transition: all 0.3s ease;
        position: relative;
    }

        .sozlesme-dosya-item:hover {
            transform: translateY(-3px);
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
        }

    .sozlesme-dosya-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 10px;
        padding-bottom: 10px;
        border-bottom: 1px solid #eee;
    }

    .sozlesme-dosya-no {
        font-weight: bold;
        color: #2c3e50;
        font-size: 0.9rem;
    }

    .sozlesme-dosya-badge {
        font-size: 0.7rem;
        padding: 3px 8px;
    }

    .sozlesme-dosya-bilgi {
        font-size: 0.8rem;
        color: #6c757d;
        margin-bottom: 10px;
    }

    .sozlesme-dosyalar-grid {
        display: grid;
        grid-template-columns: repeat(2, 1fr);
        gap: 10px;
        margin-top: 10px;
    }

    .sozlesme-dosya-tipi {
        text-align: center;
        padding: 8px;
        border-radius: 6px;
        background: #f8f9fa;
        transition: all 0.2s;
    }

        .sozlesme-dosya-tipi:hover {
            background: #e9ecef;
        }

    .sozlesme-dosya-icon {
        font-size: 20px;
        margin-bottom: 5px;
        display: block;
    }

    .sozlesme-dosya-adi {
        font-size: 0.7rem;
        font-weight: 500;
        margin-bottom: 5px;
    }

    .sozlesme-dosya-actions {
        display: flex;
        gap: 5px;
        justify-content: center;
    }

    .sozlesme-dosya-btn {
        padding: 3px 8px;
        font-size: 0.7rem;
        border-radius: 4px;
        transition: all 0.2s;
    }

        .sozlesme-dosya-btn:hover {
            transform: translateY(-1px);
        }

    .sozlesme-dosya-btn-goster {
        background: #007bff;
        color: white;
        border: none;
    }

    .sozlesme-dosya-btn-indir {
        background: #28a745;
        color: white;
        border: none;
    }

    .sozlesme-dosya-btn-goster:hover {
        background: #0056b3;
    }

    .sozlesme-dosya-btn-indir:hover {
        background: #1e7e34;
    }

    .sozlesme-dosya-yok {
        text-align: center;
        padding: 20px;
        color: #6c757d;
        font-style: italic;
        background: #f8f9fa;
        border-radius: 6px;
        grid-column: 1 / -1;
    }

    /* Büyük Göster Modal için */
    .sozlesme-dosya-modal-img {
        max-width: 100%;
        max-height: 80vh;
        object-fit: contain;
        border-radius: 8px;
        box-shadow: 0 3px 10px rgba(0,0,0,0.2);
    }

    .sozlesme-dosya-modal-actions {
        display: flex;
        gap: 10px;
        justify-content: center;
        margin-top: 20px;
    }

    /* Sözleşme Dosyaları Tablosu */
    .sozlesme-dosya-tablosu {
        font-size: 0.85rem;
    }

        .sozlesme-dosya-tablosu th {
            background-color: #f8f9fa;
            font-weight: 600;
        }

    .sozlesme-dosya-btn {
        min-width: 36px;
        height: 36px;
        display: inline-flex;
        align-items: center;
        justify-content: center;
        margin: 2px;
    }

        .sozlesme-dosya-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
        }

    /* Dosya tipi renkleri */
    .btn-outline-primary {
        border-color: #007bff;
        color: #007bff;
    }

    .btn-outline-success {
        border-color: #28a745;
        color: #28a745;
    }

    .btn-outline-warning {
        border-color: #ffc107;
        color: #ffc107;
    }

    .btn-outline-danger {
        border-color: #dc3545;
        color: #dc3545;
    }

    .btn-outline-primary:hover {
        background-color: #007bff;
        color: white;
    }

    .btn-outline-success:hover {
        background-color: #28a745;
        color: white;
    }

    .btn-outline-warning:hover {
        background-color: #ffc107;
        color: black;
    }

    .btn-outline-danger:hover {
        background-color: #dc3545;
        color: white;
    }

    /* Responsive */
    @@media (max-width: 768px) {
        .sozlesme-dosya-container {
            grid-template-columns: 1fr;
        }

        .sozlesme-dosyalar-grid {
            grid-template-columns: 1fr;
        }

        .sozlesme-dosya-tablosu {
            font-size: 0.75rem;
        }

        .sozlesme-dosya-btn {
            min-width: 32px;
            height: 32px;
            font-size: 0.75rem;
        }
    }

    /* Temel Stiller */
    .yetkili-item {
        background: #f8f9fa;
        border-left: 4px solid #007bff;
        transition: all 0.3s ease;
    }

        .yetkili-item:hover {
            background: #e9ecef;
            border-left-color: #0056b3;
        }

    .remove-yetkili {
        opacity: 0.7;
        transition: opacity 0.3s ease;
    }

        .remove-yetkili:hover {
            opacity: 1;
            background: #dc3545 !important;
            color: white !important;
        }

    /* Aktif/Pasif switch */
    .form-check-input:checked {
        background-color: #198754;
        border-color: #198754;
    }

    .aktif-badge {
        padding: 4px 8px;
        border-radius: 12px;
        font-size: 12px;
        font-weight: bold;
    }

    .aktif-1 {
        background-color: #d1e7dd;
        color: #0f5132;
    }

    .aktif-0 {
        background-color: #f8d7da;
        color: #842029;
    }

    .aktif-switch {
        display: inline-flex;
        align-items: center;
        gap: 8px;
    }

    /* Dosya Yükleme Stilleri */
    .file-upload-container {
        border: 2px dashed #dee2e6;
        border-radius: 10px;
        padding: 20px;
        text-align: center;
        transition: all 0.3s ease;
        background-color: #f8f9fa;
        cursor: pointer;
        position: relative;
        min-height: 200px;
        display: flex;
        flex-direction: column;
        justify-content: center;
        align-items: center;
    }

        .file-upload-container:hover {
            border-color: #007bff;
            background-color: #e9f7fe;
        }

        .file-upload-container.dragover {
            border-color: #28a745;
            background-color: #e8f5e9;
        }

    .upload-prompt i {
        font-size: 48px;
        margin-bottom: 15px;
        color: #6c757d;
    }

    .upload-prompt p {
        margin: 0;
        color: #6c757d;
    }

    .file-preview {
        margin-top: 15px;
        max-width: 100%;
        text-align: center;
    }

        .file-preview img {
            max-width: 200px;
            max-height: 200px;
            object-fit: contain;
            border: 1px solid #ddd;
            border-radius: 5px;
            padding: 5px;
            background: white;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
        }

    .file-info {
        font-size: 12px;
        color: #6c757d;
        margin-top: 5px;
    }

    .remove-file-btn {
        position: absolute;
        top: 10px;
        right: 10px;
        width: 30px;
        height: 30px;
        border-radius: 50%;
        background: #dc3545;
        color: white;
        border: none;
        display: flex;
        align-items: center;
        justify-content: center;
        cursor: pointer;
        opacity: 0.8;
        transition: opacity 0.3s;
        z-index: 10;
        font-size: 14px;
    }

        .remove-file-btn:hover {
            opacity: 1;
            background: #c82333;
        }

    .file-upload-progress {
        height: 6px;
        background-color: #e9ecef;
        border-radius: 3px;
        margin-top: 15px;
        overflow: hidden;
        display: none;
        width: 100%;
    }

    .file-upload-progress-bar {
        height: 100%;
        background-color: #007bff;
        width: 0%;
        transition: width 0.3s ease;
        border-radius: 3px;
    }

    /* Büyük Göster Modal */
    .file-preview-modal img {
        max-width: 100%;
        max-height: 70vh;
        object-fit: contain;
    }

    /* Dosya Grid */
    .file-grid {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(150px, 1fr));
        gap: 15px;
        margin-top: 15px;
    }

    .file-item {
        position: relative;
        border: 1px solid #dee2e6;
        border-radius: 8px;
        padding: 10px;
        text-align: center;
        background: white;
        transition: transform 0.2s;
    }

        .file-item:hover {
            transform: translateY(-3px);
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
        }

    .file-icon {
        font-size: 40px;
        color: #007bff;
        margin-bottom: 10px;
    }

    .file-name {
        font-size: 12px;
        word-break: break-all;
        margin-bottom: 5px;
        font-weight: 500;
    }

    .file-size {
        font-size: 11px;
        color: #6c757d;
    }

    /* Responsive Tablo */
    @@media (max-width: 768px) {
        .table-responsive {
            font-size: 14px;
        }

        .btn-sm {
            padding: 0.25rem 0.5rem;
            font-size: 0.75rem;
        }

        .modal-dialog {
            margin: 0.5rem;
        }
    }

    /* Arama Sonuçları */
    .arama-bos-mesaj {
        background-color: #f8f9fa;
    }

        .arama-bos-mesaj td {
            padding: 50px !important;
        }

    /* Bayi Hiyerarşi Stilleri */
    .bayi-semasi {
        font-family: Arial, sans-serif;
    }

    .hiyerarsi-container {
        padding: 20px;
        background: #f8f9fa;
        border-radius: 8px;
    }

    .tree-container {
        overflow-x: auto;
        padding: 20px;
        background: #f8f9fa;
        border-radius: 8px;
        min-height: 400px;
    }

    .tree {
        display: flex;
        flex-direction: column;
        align-items: center;
    }

    .tree-node {
        background: white;
        border: 2px solid #007bff;
        border-radius: 12px;
        padding: 12px 20px;
        margin: 8px;
        text-align: center;
        box-shadow: 0 3px 10px rgba(0,0,0,0.1);
        min-width: 160px;
        position: relative;
        font-size: 14px;
        transition: all .2s;
        cursor: pointer;
    }

        .tree-node:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 16px rgba(0,0,0,0.15);
        }

        .tree-node.seviye-0 {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border-color: #5568d3;
        }

        .tree-node.seviye-1 {
            background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
            color: white;
        }

        .tree-node.seviye-2 {
            background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
            color: white;
        }

        .tree-node.seviye-3 {
            background: linear-gradient(135deg, #43e97b 0%, #38f9d7 100%);
            color: white;
        }

        .tree-node.seviye-4 {
            background: linear-gradient(135deg, #fa709a 0%, #fee140 100%);
            color: white;
        }

        .tree-node.default {
            background: linear-gradient(135deg, #a8edea 0%, #fed6e3 100%);
            color: #333;
        }

    .tree-children {
        display: flex;
        justify-content: center;
        flex-wrap: wrap;
        position: relative;
        margin-top: 20px;
        padding-top: 20px;
    }

    .tree-line {
        position: absolute;
        top: 0;
        left: 50%;
        width: 2px;
        height: 20px;
        background: #ccc;
        transform: translateX(-50%);
    }

    .tree-item {
        position: relative;
        display: flex;
        flex-direction: column;
        align-items: center;
    }

    .tree-children::before {
        content: '';
        position: absolute;
        top: 0;
        left: 50%;
        right: 50%;
        height: 2px;
        background: #ccc;
        transform: translateX(-50%);
        width: 80%;
    }

    .seviye-badge {
        position: absolute;
        top: -8px;
        right: -8px;
        background: #ff6b6b;
        color: white;
        border-radius: 50%;
        width: 24px;
        height: 24px;
        display: flex;
        align-items: center;
        justify-content: center;
        font-weight: bold;
        font-size: 10px;
        box-shadow: 0 2px 4px rgba(0,0,0,0.2);
    }

    .table-seviye-badge {
        display: inline-block;
        padding: 3px 10px;
        border-radius: 12px;
        font-size: 11px;
        font-weight: bold;
        color: white;
    }

    .table-seviye-0 {
        background: #667eea;
    }

    .table-seviye-1 {
        background: #f5576c;
    }

    .table-seviye-2 {
        background: #00f2fe;
        color: #333;
    }

    .table-seviye-3 {
        background: #38f9d7;
        color: #333;
    }

    .table-seviye-4 {
        background: #fee140;
        color: #333;
    }

    .hiyerarsi-level {
        margin: 30px 0;
        display: flex;
        justify-content: center;
        flex-wrap: wrap;
        align-items: flex-start;
    }

    .bayi-node {
        background: white;
        border: 2px solid #007bff;
        border-radius: 8px;
        padding: 12px 20px;
        margin: 10px;
        text-align: center;
        box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        min-width: 150px;
        position: relative;
        display: inline-block;
    }

    .nav-tabs .nav-link.active {
        font-weight: bold;
        border-bottom: 3px solid #007bff;
    }

    .form-section {
        border: 1px solid #dee2e6;
        border-radius: 8px;
        padding: 20px;
        margin-bottom: 20px;
        background: #f8f9fa;
    }

    .section-title {
        font-size: 1.1rem;
        font-weight: bold;
        margin-bottom: 15px;
        color: #495057;
        border-bottom: 2px solid #007bff;
        padding-bottom: 8px;
    }

    /* Detay Modal için ek stiller */
    .detail-row {
        margin-bottom: 10px;
        padding-bottom: 10px;
        border-bottom: 1px solid #eee;
    }

    .detail-label {
        font-weight: bold;
        color: #495057;
    }

    .detail-value {
        color: #6c757d;
    }

    .loading-spinner {
        display: none;
        text-align: center;
        padding: 20px;
    }
</style>

@if (!isHiyerarsiSayfasi)
{
    <!-- ANA LİSTE SAYFASI -->
    <div class="row">
        <div class="col-md-12">
            @if (TempData["Success"] != null)
            {
                <div class="alert alert-success alert-dismissible fade show" role="alert">
                    @TempData["Success"]
                    <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
                </div>
            }
            @if (TempData["Error"] != null)
            {
                <div class="alert alert-danger alert-dismissible fade show" role="alert">
                    @TempData["Error"]
                    <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
                </div>
            }
            <div class="card" style="margin-top: 70px;">
                <div class="card-header">
                    <div class="card-title d-flex justify-content-between align-items-center">
                        <span>Bayiler</span>
                        <div>
                            <a href="@Url.Action("TumHiyerarsi", "AdminBayi")" class="btn btn-info me-2">
                                <i class="fas fa-sitemap"></i> Tüm Hiyerarşi
                            </a>
                            <button type="button" class="btn btn-secondary" data-bs-toggle="modal" data-bs-target="#ekleModal">
                                <i class="fas fa-plus"></i> Yeni Bayi Ekle
                            </button>
                        </div>
                    </div>
                </div>
                <div class="mb-3">
                    <div class="input-group">
                        <span class="input-group-text"><i class="fas fa-search"></i></span>
                        <input type="text" id="bayiAramaInput" class="form-control" placeholder="Bayi adı, kullanıcı adı, kod, telefon vb. ara...">
                        <button class="btn btn-outline-secondary" type="button" id="bayiAramaTemizle" style="display:none;">
                            <i class="fas fa-times"></i>
                        </button>
                    </div>
                </div>
                <div class="card-body">
                    <div class="table-responsive">
                        <table class="table table-bordered table-hover" id="bayiTablosu">
                            <thead class="table-head-bg-primary">
                                <tr>
                                    <th style="width:3%;">#</th>
                                    <th style="width:6%;">Seviye</th>
                                    <th style="width:14%;">Bayi Adı</th>
                                    <th style="width:12%;">Kullanıcı Adı</th>
                                    <th style="width:8%;">Kodu</th>
                                    <th style="width:7%;">Distribütör</th> <!-- YENİ SÜTUN -->

                                    <th style="width:17%;">Üst Bayi</th>
                                    <th style="width:7%;">Alt Bayi</th>
                                    <th style="width:7%;">Müşteri</th>
                                    <th style="width:8%;">Hiyerarşi</th>
                                    <th style="width:25%;">İşlemler</th>
                                </tr>
                            </thead>
                            <tbody>
                                @if (ViewBag.BayiList != null && ((List<WepApp.Controllers.BayiViewModel>)ViewBag.BayiList).Count > 0)
                                {
                                    var counter = 1;
                                    foreach (var item in (List<WepApp.Controllers.BayiViewModel>)ViewBag.BayiList)
                                    {
                                        <tr>
                                            <td>@counter</td>
                                            <td>
                                                <span class="table-seviye-badge table-seviye-@(item.Seviye > 4 ? "4" : item.Seviye)">
                                                    Seviye @item.Seviye
                                                </span>
                                            </td>
                                            <td>
                                                @for (int i = 0; i < item.Seviye; i++)
                                                {
                                                    <span>└─</span>
                                                }
                                                @item.Unvan
                                            </td>
                                            <td>@item.KullaniciAdi</td>
                                            <td>@item.Kodu</td>
                                            <td>
                                                @if (item.Distributor)
                                                {
                                                    <span class="badge bg-success">Evet</span>
                                                }
                                                else
                                                {
                                                    <span class="badge bg-secondary">Hayır</span>
                                                }
                                            </td>
                                            <td>@item.UstBayiAd</td>
                                            <td>
                                                @if (item.AltBayiSayisi > 0)
                                                {
                                                    <span class="badge bg-info">@item.AltBayiSayisi Alt Bayi</span>
                                                }
                                                else
                                                {
                                                    <span class="text-muted">-</span>
                                                }
                                            </td>
                                            <td>
                                                @if (item.MusteriSayisi > 0)
                                                {
                                                    <span class="badge bg-success">@item.MusteriSayisi Müşteri</span>
                                                }
                                                else
                                                {
                                                    <span class="text-muted">-</span>
                                                }
                                            </td>
                                            <td>
                                                <a href="@Url.Action("BayiSemasi", "AdminBayi", new { bayiId = item.Id })" class="btn btn-info btn-sm">
                                                    <i class="fas fa-sitemap"></i>
                                                </a>
                                            </td>
                                            <td>
                                                <button type="button" class="btn btn-info btn-sm" onclick="detayGetir(@item.Id)" title="Detay">
                                                    <i class="fas fa-eye"></i>
                                                </button>
                                                <button type="button" class="btn btn-warning btn-sm" onclick="duzenleGetir(@item.Id)" title="Düzenle">
                                                    <i class="fas fa-edit"></i>
                                                </button>
                                                <button type="button" class="btn btn-danger btn-sm" onclick="silOnay(@item.Id, '@item.Unvan')" title="Sil">
                                                    <i class="fas fa-trash"></i>
                                                </button>
                                                <button type="button" class="btn btn-success btn-sm" onclick="bayiTeklifleriGetir(@item.Id)" title="Teklifler">
                                                    <i class="fas fa-file-alt"></i>
                                                </button>
                                                <button type="button" class="btn btn-primary btn-sm" onclick="bayiSozlesmeleriGetir(@item.Id)" title="Sözleşmeler">
                                                    <i class="fas fa-file-contract"></i>
                                                </button>
                                            </td>
                                        </tr>
                                        counter++;
                                    }
                                }
                                else
                                {
                                    <tr>
                                        <td colspan="12" class="text-center">
                                            Henüz bayi eklenmemiş.
                                            <a href="#" data-bs-toggle="modal" data-bs-target="#ekleModal" class="btn btn-primary btn-sm">Yeni Bayi Ekle</a>
                                        </td>
                                    </tr>
                                }
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- DETAY MODAL -->
    <div class="modal fade" id="detayModal" tabindex="-1" aria-labelledby="detayModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-xl">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="detayModalLabel">Bayi Detayları</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <div class="loading-spinner" id="detayLoading">
                        <div class="spinner-border text-primary" role="status">
                            <span class="visually-hidden">Yükleniyor...</span>
                        </div>
                    </div>
                    <div id="detayContent" style="display: none;">
                        <ul class="nav nav-tabs" id="detayTab" role="tablist">
                            <li class="nav-item"><button class="nav-link active" data-bs-toggle="tab" data-bs-target="#detayTemel">Temel Bilgiler</button></li>
                            <li class="nav-item"><button class="nav-link" data-bs-toggle="tab" data-bs-target="#detayIletisim">İletişim & Adres</button></li>
                            <li class="nav-item"><button class="nav-link" data-bs-toggle="tab" data-bs-target="#detayVergi">Vergi & Resmi</button></li>
                            <li class="nav-item"><button class="nav-link" data-bs-toggle="tab" data-bs-target="#detayAlpemix">Alpemix</button></li>
                            <li class="nav-item"><button class="nav-link" data-bs-toggle="tab" data-bs-target="#detayDosyalar">Dosyalar</button></li>
                            <!-- SÖZLEŞME DOKÜMANLARI SEKMESİ -->
                            <li class="nav-item"><button class="nav-link" data-bs-toggle="tab" data-bs-target="#detaySozlesmeler">Sözleşme Dokümanları</button></li>
                            <li class="nav-item"><button class="nav-link" data-bs-toggle="tab" data-bs-target="#detayMusteriler">Müşteriler</button></li>
                            <li class="nav-item"><button class="nav-link" data-bs-toggle="tab" data-bs-target="#detayYetkililer">Yetkililer</button></li>
                        </ul>
                        <div class="tab-content p-3">
                            <div class="tab-pane fade show active" id="detayTemel">
                                <div class="row" id="detayTemelContent"></div>
                            </div>
                            <div class="tab-pane fade" id="detayIletisim">
                                <div class="row" id="detayIletisimContent"></div>
                            </div>
                            <div class="tab-pane fade" id="detayVergi">
                                <div class="row" id="detayVergiContent"></div>
                            </div>
                            <div class="tab-pane fade" id="detayAlpemix">
                                <div class="row" id="detayAlpemixContent"></div>
                            </div>
                            <div class="tab-pane fade" id="detayDosyalar">
                                <div class="row" id="detayDosyalarContent">
                                    <!-- JS ile doldurulacak -->
                                </div>
                            </div>
                            <!-- SÖZLEŞME DOKÜMANLARI TAB -->
                            <div class="tab-pane fade" id="detaySozlesmeler">
                                <div class="row" id="detaySozlesmelerContent">
                                    <!-- JS ile doldurulacak -->
                                </div>
                            </div>
                            <div class="tab-pane fade" id="detayMusteriler">
                                <div class="table-responsive">
                                    <table class="table table-sm table-bordered table-hover" id="detayMusterilerTablosu">
                                        <thead class="table-light">
                                            <tr>
                                                <th>#</th>
                                                <th>Adı Soyadı</th>
                                                <th>Ticari Unvan</th>
                                                <th>Kullanıcı Adı</th>
                                                <th>Email</th>
                                                <th>Telefon</th>
                                                <th>TC/Vergi No</th>
                                                <th>Tip</th>
                                                <th>Bayi</th>
                                                <th>Ekleme Tarihi</th>
                                            </tr>
                                        </thead>
                                        <tbody>
                                            <!-- JS ile doldurulacak -->
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                            <div class="tab-pane fade" id="detayYetkililer">
                                <div class="table-responsive">
                                    <table class="table table-sm table-bordered table-hover" id="detayYetkililerTablosu">
                                        <thead class="table-light">
                                            <tr>
                                                <th>Kod</th>
                                                <th>Adı</th>
                                                <th>Soyadı</th>
                                                <th>Görevi</th>
                                                <th>Departman</th>
                                                <th>Email</th>
                                                <th>Cep</th>
                                                <th>Durumu</th>
                                            </tr>
                                        </thead>
                                        <tbody>
                                            <!-- JS ile doldurulacak -->
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Kapat</button>
                </div>
            </div>
        </div>
    </div>

    <!-- EKLE MODAL -->
    <div class="modal fade" id="ekleModal" tabindex="-1" aria-labelledby="ekleModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-xl modal-xxl-custom">
            <div class="modal-content">
                <form id="ekleForm" method="post" action="@Url.Action("Ekle", "AdminBayi")" enctype="multipart/form-data">
                    @Html.AntiForgeryToken()
                    <div class="modal-header">
                        <h5 class="modal-title" id="ekleModalLabel">Yeni Bayi Ekle</h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                    </div>
                    <div class="modal-body">
                        <ul class="nav nav-tabs" id="ekleTab" role="tablist">
                            <li class="nav-item" role="presentation">
                                <button class="nav-link active" id="temel-tab" data-bs-toggle="tab" data-bs-target="#temel" type="button">Temel Bilgiler</button>
                            </li>
                            <li class="nav-item" role="presentation">
                                <button class="nav-link" id="iletisim-tab" data-bs-toggle="tab" data-bs-target="#iletisim" type="button">İletişim & Adres</button>
                            </li>
                            <li class="nav-item" role="presentation">
                                <button class="nav-link" id="vergi-tab" data-bs-toggle="tab" data-bs-target="#vergi" type="button">Vergi & Resmi</button>
                            </li>
                            <li class="nav-item" role="presentation">
                                <button class="nav-link" id="alpemix-tab" data-bs-toggle="tab" data-bs-target="#alpemix" type="button">Alpemix</button>
                            </li>
                            <li class="nav-item" role="presentation">
                                <button class="nav-link" id="dosyalar-tab" data-bs-toggle="tab" data-bs-target="#dosyalar" type="button">Dosyalar</button>
                            </li>
                            <li class="nav-item" role="presentation">
                                <button class="nav-link" id="yetkililer-tab" data-bs-toggle="tab" data-bs-target="#yetkililer" type="button">Yetkililer</button>
                            </li>
                        </ul>
                        <div class="tab-content p-3" id="ekleTabContent">
                            <!-- TEMEL BİLGİLER -->
                            <div class="tab-pane fade show active" id="temel" role="tabpanel">
                                <div class="row">
                                    <div class="col-md-6 mb-3">
                                        <div class="form-floating">
                                            <input type="text" class="form-control" id="Unvan" name="Unvan" placeholder="Ünvan">
                                            <label for="Unvan">Ünvan</label>
                                        </div>
                                    </div>
                                    <div class="col-md-6 mb-3">
                                        <div class="form-floating">
                                            <input type="text" class="form-control" id="KullaniciAdi" name="KullaniciAdi" placeholder="Kullanıcı Adı" required>
                                            <label for="KullaniciAdi">Kullanıcı Adı *</label>
                                        </div>
                                    </div>
                                    <div class="col-md-6 mb-3">
                                        <div class="form-floating">
                                            <input type="password" class="form-control" id="Sifre" name="Sifre" placeholder="Şifre" required>
                                            <label for="Sifre">Şifre *</label>
                                        </div>
                                    </div>
                                    <div class="col-md-6 mb-3">
                                        <div class="form-floating">
                                            <input type="text" class="form-control" id="Kodu" name="Kodu" placeholder="Bayi Kodu">
                                            <label for="Kodu">Bayi Kodu</label>
                                        </div>
                                    </div>
                                    <div class="col-md-6 mb-3">
                                        <div class="form-floating">
                                            <select class="form-select" id="UstBayiId" name="UstBayiId">
                                                <option value="">Ana Bayi (Üst Bayi Yok)</option>
                                                @if (ViewBag.TumBayiler != null)
                                                {
                                                    foreach (var bayi in (List<Bayi>)ViewBag.TumBayiler)
                                                    {
                                                        var prefix = string.Concat(Enumerable.Repeat("└─ ", bayi.Seviye ?? 0));
                                                        <option value="@bayi.Id">@prefix @bayi.Unvan (Seviye @(bayi.Seviye ?? 0))</option>
                                                    }
                                                }
                                            </select>
                                            <label for="UstBayiId">Üst Bayi</label>
                                        </div>
                                    </div>
                                    <div class="col-md-6 mb-3">
                                        <div class="form-check form-switch">
                                            <input class="form-check-input" type="checkbox"
                                                   id="Distributor" name="Distributor" value="true">
                                            <label class="form-check-label" for="Distributor">
                                                Distribütör
                                            </label>
                                        </div>
                                        <div class="form-text">
                                            <i class="fas fa-info-circle"></i> Bu bayi bir distribütör ise işaretleyin.
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <!-- İLETİŞİM & ADRES -->
                            <div class="tab-pane fade" id="iletisim" role="tabpanel">
                                <div class="row">
                                    <div class="col-md-6 mb-3">
                                        <div class="form-floating">
                                            <input type="email" class="form-control" id="Email" name="Email" placeholder="Email">
                                            <label for="Email">Email</label>
                                        </div>
                                    </div>
                                    <div class="col-md-6 mb-3">
                                        <div class="form-floating">
                                            <input type="text" class="form-control" id="Telefon" name="Telefon" placeholder="Telefon">
                                            <label for="Telefon">Telefon</label>
                                        </div>
                                    </div>
                                    <div class="col-md-6 mb-3">
                                        <div class="form-floating">
                                            <input type="text" class="form-control" id="Bolge" name="Bolge" placeholder="Bölge">
                                            <label for="Bolge">Bölge</label>
                                        </div>
                                    </div>
                                    <div class="col-md-6 mb-3">
                                        <div class="form-floating">
                                            <input type="text" class="form-control" id="Il" name="Il" placeholder="İl">
                                            <label for="Il">İl</label>
                                        </div>
                                    </div>
                                    <div class="col-md-6 mb-3">
                                        <div class="form-floating">
                                            <input type="text" class="form-control" id="Ilce" name="Ilce" placeholder="İlçe">
                                            <label for="Ilce">İlçe</label>
                                        </div>
                                    </div>
                                    <div class="col-md-6 mb-3">
                                        <div class="form-floating">
                                            <input type="text" class="form-control" id="Belde" name="Belde" placeholder="Belde">
                                            <label for="Belde">Belde</label>
                                        </div>
                                    </div>
                                    <div class="col-12 mb-3">
                                        <div class="form-floating">
                                            <textarea class="form-control" id="Adres" name="Adres" placeholder="Adres" style="height: 100px"></textarea>
                                            <label for="Adres">Adres</label>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <!-- VERGİ & RESMİ -->
                            <div class="tab-pane fade" id="vergi" role="tabpanel">
                                <div class="row">
                                    <div class="col-md-6 mb-3">
                                        <div class="form-floating">
                                            <input type="text" class="form-control" id="TCVNo" name="TCVNo" placeholder="TC/Vergi No">
                                            <label for="TCVNo">TC/Vergi No</label>
                                        </div>
                                    </div>
                                    <div class="col-md-6 mb-3">
                                        <div class="form-floating">
                                            <input type="text" class="form-control" id="VergiDairesi" name="VergiDairesi" placeholder="Vergi Dairesi">
                                            <label for="VergiDairesi">Vergi Dairesi</label>
                                        </div>
                                    </div>
                                    <div class="col-md-6 mb-3">
                                        <div class="form-floating">
                                            <input type="text" class="form-control" id="KepAdresi" name="KepAdresi" placeholder="KEP Adresi">
                                            <label for="KepAdresi">KEP Adresi</label>
                                        </div>
                                    </div>
                                    <div class="col-md-6 mb-3">
                                        <div class="form-floating">
                                            <input type="text" class="form-control" id="WebAdresi" name="WebAdresi" placeholder="Web Adresi">
                                            <label for="WebAdresi">Web Adresi</label>
                                        </div>
                                    </div>
                                    <div class="col-12 mb-3">
                                        <div class="form-floating">
                                            <textarea class="form-control" id="Aciklama" name="Aciklama" placeholder="Açıklama" style="height: 100px"></textarea>
                                            <label for="Aciklama">Açıklama</label>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <!-- ALPEMIX -->
                            <div class="tab-pane fade" id="alpemix" role="tabpanel">
                                <div class="row">
                                    <div class="col-md-6 mb-3">
                                        <div class="form-floating">
                                            <input type="text" class="form-control" id="AlpemixFirmaAdi" name="AlpemixFirmaAdi" placeholder="Alpemix Firma Adı">
                                            <label for="AlpemixFirmaAdi">Alpemix Firma Adı</label>
                                        </div>
                                    </div>
                                    <div class="col-md-6 mb-3">
                                        <div class="form-floating">
                                            <input type="text" class="form-control" id="AlpemixGrupAdi" name="AlpemixGrupAdi" placeholder="Alpemix Grup Adı">
                                            <label for="AlpemixGrupAdi">Alpemix Grup Adı</label>
                                        </div>
                                    </div>
                                    <div class="col-12 mb-3">
                                        <div class="form-floating">
                                            <input type="text" class="form-control" id="AlpemixSifre" name="AlpemixSifre" placeholder="Alpemix Şifre">
                                            <label for="AlpemixSifre">Alpemix Şifre</label>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <!-- DOSYALAR -->
                            <div class="tab-pane fade" id="dosyalar" role="tabpanel">
                                <div class="row">
                                    <!-- LOGO -->
                                    <div class="col-md-6 mb-4">
                                        <div class="card">
                                            <div class="card-header bg-primary text-white">
                                                <i class="fas fa-image"></i> Logo
                                            </div>
                                            <div class="card-body">
                                                <div class="file-upload-container" onclick="document.getElementById('Logo').click()">
                                                    <input type="file" class="form-control visually-hidden"
                                                           id="Logo" name="Logo"
                                                           accept=".jpg,.jpeg,.png,.gif,.webp"
                                                           onchange="handleFileSelectEkle(event, 'logo')">
                                                    <div class="upload-prompt">
                                                        <i class="fas fa-cloud-upload-alt fa-3x"></i>
                                                        <p class="mt-2">Logo dosyasını tıklayarak seçin</p>
                                                        <p class="small text-muted">JPG, PNG, GIF, WEBP (Max: 5MB)</p>
                                                    </div>
                                                    <div class="file-preview" id="logoPreviewEkle"></div>
                                                    <div class="file-upload-progress" id="logoProgressEkle">
                                                        <div class="file-upload-progress-bar" id="logoProgressBarEkle"></div>
                                                    </div>
                                                </div>
                                                <div class="form-text mt-2">
                                                    <i class="fas fa-info-circle"></i> Bayi logosu yükleyin (isteğe bağlı)
                                                </div>
                                            </div>
                                        </div>
                                    </div>

                                    <!-- İMZA -->
                                    <div class="col-md-6 mb-4">
                                        <div class="card">
                                            <div class="card-header bg-success text-white">
                                                <i class="fas fa-signature"></i> İmza
                                            </div>
                                            <div class="card-body">
                                                <div class="file-upload-container" onclick="document.getElementById('Imza').click()">
                                                    <input type="file" class="form-control visually-hidden"
                                                           id="Imza" name="Imza"
                                                           accept=".jpg,.jpeg,.png,.gif,.webp"
                                                           onchange="handleFileSelectEkle(event, 'imza')">
                                                    <div class="upload-prompt">
                                                        <i class="fas fa-cloud-upload-alt fa-3x"></i>
                                                        <p class="mt-2">İmza dosyasını tıklayarak seçin</p>
                                                        <p class="small text-muted">JPG, PNG, GIF, WEBP (Max: 5MB)</p>
                                                    </div>
                                                    <div class="file-preview" id="imzaPreviewEkle"></div>
                                                    <div class="file-upload-progress" id="imzaProgressEkle">
                                                        <div class="file-upload-progress-bar" id="imzaProgressBarEkle"></div>
                                                    </div>
                                                </div>
                                                <div class="form-text mt-2">
                                                    <i class="fas fa-info-circle"></i> Bayi imzası yükleyin (isteğe bağlı)
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <!-- YETKİLİLER SEKME -->
                            <div class="tab-pane fade" id="yetkililer" role="tabpanel">
                                <div class="d-flex justify-content-between align-items-center mb-3">
                                    <h6 class="mb-0">Bayi Yetkilileri</h6>
                                    <button type="button" class="btn btn-sm btn-primary" onclick="yeniYetkiliEkleModal()">
                                        <i class="fas fa-plus"></i> Yeni Yetkili Ekle
                                    </button>
                                </div>

                                <div class="yetkili-form-container">
                                    <div id="ekleYetkiliListesi">
                                        <div class="alert alert-info text-center">
                                            Henüz yetkili eklenmedi. Yeni yetkili eklemek için butona tıklayın.
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">İptal</button>
                        <button type="submit" class="btn btn-primary" id="ekleBtn">Kaydet</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- DÜZENLE MODAL -->
    <div class="modal fade" id="duzenleModal" tabindex="-1" aria-labelledby="duzenleModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-xl">
            <div class="modal-content">
                <form id="duzenleForm" method="post" action="@Url.Action("Guncelle", "AdminBayi")" enctype="multipart/form-data">
                    @Html.AntiForgeryToken()
                    <input type="hidden" id="editId" name="Id">
                    <div class="modal-header">
                        <h5 class="modal-title" id="duzenleModalLabel">Bayi Düzenle</h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                    </div>
                    <div class="modal-body">
                        <div class="loading-spinner" id="duzenleLoading">
                            <div class="spinner-border text-primary" role="status">
                                <span class="visually-hidden">Yükleniyor...</span>
                            </div>
                        </div>
                        <div id="duzenleContent" style="display: none;">
                            <ul class="nav nav-tabs" id="duzenleTab" role="tablist">
                                <li class="nav-item" role="presentation">
                                    <button class="nav-link active" id="editTemel-tab" data-bs-toggle="tab" data-bs-target="#editTemel" type="button">Temel Bilgiler</button>
                                </li>
                                <li class="nav-item" role="presentation">
                                    <button class="nav-link" id="editIletisim-tab" data-bs-toggle="tab" data-bs-target="#editIletisim" type="button">İletişim & Adres</button>
                                </li>
                                <li class="nav-item" role="presentation">
                                    <button class="nav-link" id="editVergi-tab" data-bs-toggle="tab" data-bs-target="#editVergi" type="button">Vergi & Resmi</button>
                                </li>
                                <li class="nav-item" role="presentation">
                                    <button class="nav-link" id="editAlpemix-tab" data-bs-toggle="tab" data-bs-target="#editAlpemix" type="button">Alpemix</button>
                                </li>
                                <li class="nav-item" role="presentation">
                                    <button class="nav-link" id="editDosyalar-tab" data-bs-toggle="tab" data-bs-target="#editDosyalar" type="button">Dosyalar</button>
                                </li>
                                <li class="nav-item" role="presentation">
                                    <button class="nav-link" id="editSozlesme-tab" data-bs-toggle="tab" data-bs-target="#editSozlesme" type="button">
                                        Sözleşmeler
                                    </button>
                                </li>
                                <li class="nav-item" role="presentation">
                                    <button class="nav-link" id="editYetkililer-tab" data-bs-toggle="tab" data-bs-target="#editYetkililer" type="button">
                                        Yetkililer
                                    </button>
                                </li>
                            </ul>
                            <div class="tab-content p-3" id="duzenleTabContent">
                                <!-- TEMEL BİLGİLER -->
                                <div class="tab-pane fade show active" id="editTemel" role="tabpanel">
                                    <div class="row">
                                        <div class="col-md-6 mb-3">
                                            <div class="form-floating">
                                                <input type="text" class="form-control" id="editUnvan" name="Unvan" placeholder="Ünvan">
                                                <label for="editUnvan">Ünvan</label>
                                            </div>
                                        </div>
                                        <div class="col-md-6 mb-3">
                                            <div class="form-floating">
                                                <input type="text" class="form-control" id="editKullaniciAdi" name="KullaniciAdi" placeholder="Kullanıcı Adı" required>
                                                <label for="editKullaniciAdi">Kullanıcı Adı *</label>
                                            </div>
                                        </div>
                                        <div class="col-md-6 mb-3">
                                            <div class="form-floating">
                                                <input type="password" class="form-control" id="editSifre" name="Sifre" placeholder="Şifre (boş bırakın değiştirmemek için)">
                                                <label for="editSifre">Şifre</label>
                                            </div>
                                        </div>
                                        <div class="col-md-6 mb-3">
                                            <div class="form-floating">
                                                <input type="text" class="form-control" id="editKodu" name="Kodu" placeholder="Bayi Kodu">
                                                <label for="editKodu">Bayi Kodu</label>
                                            </div>
                                        </div>
                                        <div class="col-md-6 mb-3">
                                            <div class="form-floating">
                                                <select class="form-select" id="editUstBayiId" name="UstBayiId">
                                                    <option value="">Ana Bayi (Üst Bayi Yok)</option>
                                                    @if (ViewBag.TumBayiler != null)
                                                    {
                                                        foreach (var bayi in (List<Bayi>)ViewBag.TumBayiler)
                                                        {
                                                            var prefix = string.Concat(Enumerable.Repeat("└─ ", bayi.Seviye ?? 0));
                                                            <option value="@bayi.Id">@prefix @bayi.Unvan (Seviye @(bayi.Seviye ?? 0))</option>
                                                        }
                                                    }
                                                </select>
                                                <label for="editUstBayiId">Üst Bayi</label>
                                            </div>
                                        </div>
                                        <div class="col-md-6 mb-3">
                                            <div class="form-check form-switch">
                                                <input class="form-check-input" type="checkbox"
                                                       id="editDistributor" name="Distributor" value="true">
                                                <label class="form-check-label" for="editDistributor">
                                                    Distribütör
                                                </label>
                                            </div>
                                            <div class="form-text">
                                                <i class="fas fa-info-circle"></i> Bu bayi bir distribütör ise işaretleyin.
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                <!-- İLETİŞİM & ADRES -->
                                <div class="tab-pane fade" id="editIletisim" role="tabpanel">
                                    <div class="row">
                                        <div class="col-md-6 mb-3">
                                            <div class="form-floating">
                                                <input type="email" class="form-control" id="editEmail" name="Email" placeholder="Email">
                                                <label for="editEmail">Email</label>
                                            </div>
                                        </div>
                                        <div class="col-md-6 mb-3">
                                            <div class="form-floating">
                                                <input type="text" class="form-control" id="editTelefon" name="Telefon" placeholder="Telefon">
                                                <label for="editTelefon">Telefon</label>
                                            </div>
                                        </div>
                                        <div class="col-md-6 mb-3">
                                            <div class="form-floating">
                                                <input type="text" class="form-control" id="editBolge" name="Bolge" placeholder="Bölge">
                                                <label for="editBolge">Bölge</label>
                                            </div>
                                        </div>
                                        <div class="col-md-6 mb-3">
                                            <div class="form-floating">
                                                <input type="text" class="form-control" id="editIl" name="Il" placeholder="İl">
                                                <label for="editIl">İl</label>
                                            </div>
                                        </div>
                                        <div class="col-md-6 mb-3">
                                            <div class="form-floating">
                                                <input type="text" class="form-control" id="editIlce" name="Ilce" placeholder="İlçe">
                                                <label for="editIlce">İlçe</label>
                                            </div>
                                        </div>
                                        <div class="col-md-6 mb-3">
                                            <div class="form-floating">
                                                <input type="text" class="form-control" id="editBelde" name="Belde" placeholder="Belde">
                                                <label for="editBelde">Belde</label>
                                            </div>
                                        </div>
                                        <div class="col-12 mb-3">
                                            <div class="form-floating">
                                                <textarea class="form-control" id="editAdres" name="Adres" placeholder="Adres" style="height: 100px"></textarea>
                                                <label for="editAdres">Adres</label>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                <!-- VERGİ & RESMİ -->
                                <div class="tab-pane fade" id="editVergi" role="tabpanel">
                                    <div class="row">
                                        <div class="col-md-6 mb-3">
                                            <div class="form-floating">
                                                <input type="text" class="form-control" id="editTCVNo" name="TCVNo" placeholder="TC/Vergi No">
                                                <label for="editTCVNo">TC/Vergi No</label>
                                            </div>
                                        </div>
                                        <div class="col-md-6 mb-3">
                                            <div class="form-floating">
                                                <input type="text" class="form-control" id="editVergiDairesi" name="VergiDairesi" placeholder="Vergi Dairesi">
                                                <label for="editVergiDairesi">Vergi Dairesi</label>
                                            </div>
                                        </div>
                                        <div class="col-md-6 mb-3">
                                            <div class="form-floating">
                                                <input type="text" class="form-control" id="editKepAdresi" name="KepAdresi" placeholder="KEP Adresi">
                                                <label for="editKepAdresi">KEP Adresi</label>
                                            </div>
                                        </div>
                                        <div class="col-md-6 mb-3">
                                            <div class="form-floating">
                                                <input type="text" class="form-control" id="editWebAdresi" name="WebAdresi" placeholder="Web Adresi">
                                                <label for="editWebAdresi">Web Adresi</label>
                                            </div>
                                        </div>
                                        <div class="col-12 mb-3">
                                            <div class="form-floating">
                                                <textarea class="form-control" id="editAciklama" name="Aciklama" placeholder="Açıklama" style="height: 100px"></textarea>
                                                <label for="editAciklama">Açıklama</label>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                <!-- ALPEMIX -->
                                <div class="tab-pane fade" id="editAlpemix" role="tabpanel">
                                    <div class="row">
                                        <div class="col-md-6 mb-3">
                                            <div class="form-floating">
                                                <input type="text" class="form-control" id="editAlpemixFirmaAdi" name="AlpemixFirmaAdi" placeholder="Alpemix Firma Adı">
                                                <label for="editAlpemixFirmaAdi">Alpemix Firma Adı</label>
                                            </div>
                                        </div>
                                        <div class="col-md-6 mb-3">
                                            <div class="form-floating">
                                                <input type="text" class="form-control" id="editAlpemixGrupAdi" name="AlpemixGrupAdi" placeholder="Alpemix Grup Adı">
                                                <label for="editAlpemixGrupAdi">Alpemix Grup Adı</label>
                                            </div>
                                        </div>
                                        <div class="col-12 mb-3">
                                            <div class="form-floating">
                                                <input type="text" class="form-control" id="editAlpemixSifre" name="AlpemixSifre" placeholder="Alpemix Şifre">
                                                <label for="editAlpemixSifre">Alpemix Şifre</label>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                <!-- DOSYALAR TAB'ı -->
                                <div class="tab-pane fade" id="editDosyalar" role="tabpanel">
                                    <div class="row">
                                        <!-- LOGO YÖNETİMİ -->
                                        <div class="col-md-6 mb-4">
                                            <div class="card">
                                                <div class="card-header bg-primary text-white d-flex justify-content-between align-items-center">
                                                    <span><i class="fas fa-image"></i> Logo Yönetimi</span>
                                                    <span id="logoDurumBadge" class="badge bg-light text-dark">Yükleniyor...</span>
                                                </div>
                                                <div class="card-body">
                                                    <!-- Mevcut Logo Görüntüleme -->
                                                    <div id="mevcutLogoContainer" style="display: none;">
                                                        <div class="mb-3 text-center">
                                                            <div class="detail-label mb-2">Mevcut Logo</div>
                                                            <img id="mevcutLogoImg" src="" class="img-fluid rounded border"
                                                                 style="max-height: 150px; object-fit: contain; cursor: pointer;"
                                                                 onclick="buyukGoster('logo')"
                                                                 alt="Mevcut Logo">
                                                            <div class="mt-2">
                                                                <button type="button" class="btn btn-sm btn-danger" onclick="silLogoOnay()">
                                                                    <i class="fas fa-trash"></i> Logoyu Sil
                                                                </button>
                                                                <button type="button" class="btn btn-sm btn-info" onclick="indirLogo()">
                                                                    <i class="fas fa-download"></i> İndir
                                                                </button>
                                                            </div>
                                                        </div>
                                                        <hr>
                                                    </div>

                                                    <!-- Yeni Logo Yükleme -->
                                                    <div class="mb-3">
                                                        <label class="form-label">Yeni Logo Yükle</label>
                                                        <div class="file-upload-container" id="logoUploadContainer"
                                                             ondragover="handleDragOver(event)"
                                                             ondragleave="handleDragLeave(event)"
                                                             ondrop="handleDrop(event, 'logo')"
                                                             onclick="document.getElementById('editLogo').click()">
                                                            <input type="file" class="form-control visually-hidden"
                                                                   id="editLogo" name="Logo"
                                                                   accept=".jpg,.jpeg,.png,.gif,.webp"
                                                                   onchange="handleLogoSelect(event)">
                                                            <div class="upload-prompt">
                                                                <i class="fas fa-cloud-upload-alt fa-3x text-muted mb-3"></i>
                                                                <p class="mb-2">Logo dosyasını sürükleyip bırakın veya tıklayarak seçin</p>
                                                                <p class="small text-muted">JPG, PNG, GIF, WEBP (Max: 5MB)</p>
                                                            </div>
                                                            <div class="file-preview" id="logoPreview"></div>
                                                            <div class="file-upload-progress" id="logoProgress">
                                                                <div class="file-upload-progress-bar" id="logoProgressBar"></div>
                                                            </div>
                                                        </div>
                                                        <div class="form-text">
                                                            <i class="fas fa-info-circle"></i> Logo yüklerseniz mevcut logo değişir.
                                                        </div>
                                                    </div>

                                                    <!-- Logo Bilgileri -->
                                                    <div class="alert alert-info mt-3" id="logoBilgiAlert" style="display: none;">
                                                        <i class="fas fa-info-circle"></i>
                                                        <span id="logoBilgiText"></span>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>

                                        <!-- İMZA YÖNETİMİ -->
                                        <div class="col-md-6 mb-4">
                                            <div class="card">
                                                <div class="card-header bg-success text-white d-flex justify-content-between align-items-center">
                                                    <span><i class="fas fa-signature"></i> İmza Yönetimi</span>
                                                    <span id="imzaDurumBadge" class="badge bg-light text-dark">Yükleniyor...</span>
                                                </div>
                                                <div class="card-body">
                                                    <!-- Mevcut İmza Görüntüleme -->
                                                    <div id="mevcutImzaContainer" style="display: none;">
                                                        <div class="mb-3 text-center">
                                                            <div class="detail-label mb-2">Mevcut İmza</div>
                                                            <img id="mevcutImzaImg" src="" class="img-fluid rounded border"
                                                                 style="max-height: 150px; object-fit: contain; cursor: pointer;"
                                                                 onclick="buyukGoster('imza')"
                                                                 alt="Mevcut İmza">
                                                            <div class="mt-2">
                                                                <button type="button" class="btn btn-sm btn-danger" onclick="silImzaOnay()">
                                                                    <i class="fas fa-trash"></i> İmzayı Sil
                                                                </button>
                                                                <button type="button" class="btn btn-sm btn-info" onclick="indirImza()">
                                                                    <i class="fas fa-download"></i> İndir
                                                                </button>
                                                            </div>
                                                        </div>
                                                        <hr>
                                                    </div>

                                                    <!-- Yeni İmza Yükleme -->
                                                    <div class="mb-3">
                                                        <label class="form-label">Yeni İmza Yükle</label>
                                                        <div class="file-upload-container" id="imzaUploadContainer"
                                                             ondragover="handleDragOver(event)"
                                                             ondragleave="handleDragLeave(event)"
                                                             ondrop="handleDrop(event, 'imza')"
                                                             onclick="document.getElementById('editImza').click()">
                                                            <input type="file" class="form-control visually-hidden"
                                                                   id="editImza" name="Imza"
                                                                   accept=".jpg,.jpeg,.png,.gif,.webp"
                                                                   onchange="handleImzaSelect(event)">
                                                            <div class="upload-prompt">
                                                                <i class="fas fa-cloud-upload-alt fa-3x text-muted mb-3"></i>
                                                                <p class="mb-2">İmza dosyasını sürükleyip bırakın veya tıklayarak seçin</p>
                                                                <p class="small text-muted">JPG, PNG, GIF, WEBP (Max: 5MB)</p>
                                                            </div>
                                                            <div class="file-preview" id="imzaPreview"></div>
                                                            <div class="file-upload-progress" id="imzaProgress">
                                                                <div class="file-upload-progress-bar" id="imzaProgressBar"></div>
                                                            </div>
                                                        </div>
                                                        <div class="form-text">
                                                            <i class="fas fa-info-circle"></i> İmza yüklerseniz mevcut imza değişir.
                                                        </div>
                                                    </div>

                                                    <!-- İmza Bilgileri -->
                                                    <div class="alert alert-info mt-3" id="imzaBilgiAlert" style="display: none;">
                                                        <i class="fas fa-info-circle"></i>
                                                        <span id="imzaBilgiText"></span>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>

                                        <!-- DOSYA İSTATİSTİKLERİ -->
                                        <div class="col-12">
                                            <div class="card">
                                                <div class="card-header bg-secondary text-white">
                                                    <i class="fas fa-chart-bar"></i> Dosya İstatistikleri
                                                </div>
                                                <div class="card-body">
                                                    <div class="row">
                                                        <div class="col-md-6">
                                                            <div class="d-flex justify-content-between align-items-center mb-2">
                                                                <span>Logo Durumu:</span>
                                                                <span id="logoStat" class="badge bg-warning">Yükleniyor...</span>
                                                            </div>
                                                            <div class="d-flex justify-content-between align-items-center mb-2">
                                                                <span>İmza Durumu:</span>
                                                                <span id="imzaStat" class="badge bg-warning">Yükleniyor...</span>
                                                            </div>
                                                        </div>
                                                        <div class="col-md-6">
                                                            <div class="d-flex justify-content-between align-items-center mb-2">
                                                                <span>Toplam Dosya Boyutu:</span>
                                                                <span id="toplamBoyut" class="badge bg-info">0 KB</span>
                                                            </div>
                                                            <div class="d-flex justify-content-between align-items-center">
                                                                <span>Son Güncelleme:</span>
                                                                <span id="sonGuncelleme" class="badge bg-light text-dark">-</span>
                                                            </div>
                                                        </div>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                <!-- SÖZLEŞMELER TAB -->
                                <div class="tab-pane fade" id="editSozlesme" role="tabpanel">
                                    <div class="mt-3">
                                        <div class="table-responsive">
                                            <table class="table table-sm table-bordered table-hover" id="bayiSozlesmeTablosu">
                                                <thead class="table-light">
                                                    <tr>
                                                        <th>Döküman No</th>
                                                        <th>Rev.</th>
                                                        <th>Yayın</th>
                                                        <th>Bitiş</th>
                                                        <th>Durum</th>
                                                        <th>Kriter</th>
                                                        <th>Dosya</th>
                                                        <th>İşlem</th>
                                                    </tr>
                                                </thead>
                                                <tbody>
                                                    <!-- JS ile doldurulacak -->
                                                </tbody>
                                            </table>
                                        </div>
                                    </div>
                                </div>
                                <!-- YETKİLİ TAB -->
                                <div class="tab-pane fade" id="editYetkililer" role="tabpanel">
                                    <div class="d-flex justify-content-between align-items-center mb-3">
                                        <h6 class="mb-0">Bayi Yetkilileri</h6>
                                        <button type="button" class="btn btn-sm btn-primary" onclick="yeniYetkiliEkleModalDuzenleToplu()">
                                            <i class="fas fa-plus"></i> Yeni Yetkili Ekle
                                        </button>
                                    </div>

                                    <!-- Mevcut yetkililer tablosu -->
                                    <div class="table-responsive mb-4">
                                        <table class="table table-sm table-bordered table-hover" id="bayiYetkililerTablosu">
                                            <thead class="table-light">
                                                <tr>
                                                    <th>Kod</th>
                                                    <th>Adı</th>
                                                    <th>Soyadı</th>
                                                    <th>Görevi</th>
                                                    <th>Departman</th>
                                                    <th>Email</th>
                                                    <th>Cep</th>
                                                    <th>Durum</th>
                                                    <th>İşlem</th>
                                                </tr>
                                            </thead>
                                            <tbody>
                                                <!-- JS ile doldurulacak -->
                                            </tbody>
                                        </table>
                                    </div>

                                    <!-- Yeni eklenecek yetkililer listesi -->
                                    <div id="duzenleYetkiliListesiContainer">
                                        <div class="alert alert-info text-center">
                                            Yeni eklenecek yetkili yok. "Yeni Yetkili Ekle" butonuna tıklayarak ekleyebilirsiniz.
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">İptal</button>
                        <button type="submit" class="btn btn-primary" id="duzenleSubmitBtn">Güncelle</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- SİL ONAY MODAL -->
    <div class="modal fade" id="silModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <form method="post" action="@Url.Action("Sil", "AdminBayi")">
                    @Html.AntiForgeryToken()
                    <input type="hidden" id="silId" name="Id">
                    <div class="modal-header">
                        <h5 class="modal-title">Silme Onayı</h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                    </div>
                    <div class="modal-body">
                        <p><strong>"<span id="silAdi"></span>"</strong> adlı bayi silmek istediğinizden emin misiniz?</p>
                        <p class="text-danger"><small>Bu işlem geri alınamaz.</small></p>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">İptal</button>
                        <button type="submit" class="btn btn-danger">Sil</button>
                    </div>
                </form>
            </div>
        </div>
    </div>
}
else
{
    <!-- HİYERARŞİ SAYFASI -->
    <div class="row">
        <div class="col-md-12">
            <div class="card" style="margin-top: 70px;">
                <div class="card-header">
                    <div class="card-title d-flex justify-content-between align-items-center">
                        <span>@ViewBag.SemaBaslik</span>
                        <a href="@Url.Action("Index", "AdminBayi")" class="btn btn-secondary">
                            <i class="fas fa-arrow-left"></i> Listeye Dön
                        </a>
                    </div>
                </div>
                <div class="card-body">
                    <div class="tree-container">
                        <div id="tree-root"></div>
                    </div>
                </div>
            </div>
        </div>
    </div>
}

<!-- BÜYÜK GÖSTER MODAL -->
<div class="modal fade" id="buyukGosterModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="buyukGosterModalLabel"></h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body text-center">
                <img id="buyukGosterImg" src="" class="img-fluid rounded" alt="">
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Kapat</button>
                <button type="button" class="btn btn-primary" onclick="indirBuyukResim()">
                    <i class="fas fa-download"></i> İndir
                </button>
            </div>
        </div>
    </div>
</div>

<!-- DOSYA SİLME ONAY MODAL -->
<div class="modal fade" id="dosyaSilModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header bg-danger text-white">
                <h5 class="modal-title" id="dosyaSilModalLabel">Dosya Silme Onayı</h5>
                <button type="button" class="btn-close text-white" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <p><strong id="silinecekDosyaAdi"></strong> dosyasını silmek istediğinizden emin misiniz?</p>
                <p class="text-danger">
                    <i class="fas fa-exclamation-triangle"></i> Bu işlem geri alınamaz. Dosya hem veritabanından hem de sunucudan silinecektir.
                </p>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">İptal</button>
                <button type="button" class="btn btn-danger" id="dosyaSilOnayBtn">Sil</button>
            </div>
        </div>
    </div>
</div>

<!-- YETKİLİ DÜZENLEME MODAL -->
<div class="modal fade" id="yetkiliDuzenleModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <form onsubmit="return false;">
                <div class="modal-header bg-primary text-white">
                    <h5 class="modal-title">Yetkili Düzenle</h5>
                    <button type="button" class="btn-close text-white" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <div class="row g-3">
                        <div class="col-md-6">
                            <label class="form-label">Adı *</label>
                            <input type="text" class="form-control" id="yetkiliDuzenleAdi" required>
                        </div>
                        <div class="col-md-6">
                            <label class="form-label">Soyadı *</label>
                            <input type="text" class="form-control" id="yetkiliDuzenleSoyadi" required>
                        </div>
                        <div class="col-md-6">
                            <label class="form-label">Görevi</label>
                            <input type="text" class="form-control" id="yetkiliDuzenleGorevi">
                        </div>
                        <div class="col-md-6">
                            <label class="form-label">Departman</label>
                            <select class="form-select" id="yetkiliDuzenleDepartmanSelect">
                                <option value="">Seçiniz</option>
                            </select>
                        </div>
                        <div class="col-md-6">
                            <label class="form-label">Email</label>
                            <input type="email" class="form-control" id="yetkiliDuzenleEmail">
                        </div>
                        <div class="col-md-6">
                            <label class="form-label">Cep Telefonu</label>
                            <input type="text" class="form-control" id="yetkiliDuzenleCep">
                        </div>
                        <div class="col-md-6">
                            <label class="form-label">Dahili No</label>
                            <input type="text" class="form-control" id="yetkiliDuzenleDahiliNo">
                        </div>
                        <div class="col-md-6">
                            <label class="form-label">Yetkili Kodu</label>
                            <input type="text" class="form-control" id="yetkiliDuzenleKodu">
                        </div>
                        <div class="col-md-6">
                            <label class="form-label">Durum</label>
                            <div class="form-check form-switch">
                                <input class="form-check-input" type="checkbox" id="yetkiliDuzenleAktif" checked>
                                <label class="form-check-label" for="yetkiliDuzenleAktif">
                                    <span id="aktifText">Aktif</span>
                                </label>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <label class="form-label">Cinsiyet</label>
                            <select class="form-select" id="yetkiliDuzenleCinsiyet">
                                <option value="">Seçiniz</option>
                                <option value="Erkek">Erkek</option>
                                <option value="Kadın">Kadın</option>
                            </select>
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">İptal</button>
                    <button type="button" class="btn btn-success" onclick="kaydetYetkiliDuzenle()">
                        <i class="fas fa-save"></i> Güncelle
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- BAYİ MÜŞTERİ TEKLİFLERİ MODAL -->
<div class="modal fade" id="musteriTeklifleriModal" tabindex="-1" aria-labelledby="musteriTeklifleriModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-xl">
        <div class="modal-content">
            <div class="modal-header bg-success text-white">
                <h5 class="modal-title" id="musteriTeklifleriModalLabel">
                    <span id="musteriTeklifAdi">Bayisine Ait Müşterilerin</span> Teklifleri
                </h5>
                <button type="button" class="btn-close text-white" data-bs-dismiss="modal" aria-label="Kapat"></button>
            </div>
            <div class="modal-body">
                <div class="loading-spinner text-center py-4" id="tekliflerLoading">
                    <div class="spinner-border text-success" role="status">
                        <span class="visually-hidden">Yükleniyor...</span>
                    </div>
                    <p class="mt-2">Teklifler yükleniyor...</p>
                </div>
                <div id="tekliflerContent" style="display: none;">
                    <div class="table-responsive">
                        <table class="table table-bordered table-hover table-striped">
                            <thead class="table-success">
                                <tr>
                                    <th>#</th>
                                    <th>Teklif No</th>
                                    <th>Oluşturma Tarihi</th>
                                    <th>Geçerlilik Tarihi</th>
                                    <th>Lisans Tipi</th>
                                    <th>Durum</th>
                                    <th>Onay</th>
                                    <th>Net Toplam</th>
                                    <th>Müşteri</th>
                                    <th>PDF Rapor</th>
                                </tr>
                            </thead>
                            <tbody id="tekliflerTablosu">
                                <!-- JS ile doldurulacak -->
                            </tbody>
                        </table>
                    </div>
                    <div id="teklifYokMesaj" class="text-center text-muted py-5" style="display: none;">
                        <i class="fas fa-file-alt fa-3x mb-3"></i>
                        <p>Bu bayiye (veya alt bayilerine) ait müşterilerin teklifi bulunamadı.</p>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Kapat</button>
            </div>
        </div>
    </div>
</div>

<!-- BAYİ MÜŞTERİ SÖZLEŞMELERİ MODAL -->
<div class="modal fade" id="musteriSozlesmeleriModal" tabindex="-1" aria-labelledby="musteriSozlesmeleriModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-xl">
        <div class="modal-content">
            <div class="modal-header bg-info text-white">
                <h5 class="modal-title" id="musteriSozlesmeleriModalLabel">
                    <span id="musteriSozlesmeAdi">Bayisine Ait Müşterilerin</span> Sözleşmeleri
                </h5>
                <button type="button" class="btn-close text-white" data-bs-dismiss="modal" aria-label="Kapat"></button>
            </div>
            <div class="modal-body">
                <div class="loading-spinner text-center py-4" id="sozlesmelerLoading">
                    <div class="spinner-border text-info" role="status">
                        <span class="visually-hidden">Yükleniyor...</span>
                    </div>
                    <p class="mt-2">Sözleşmeler yükleniyor...</p>
                </div>
                <div id="sozlesmelerContent" style="display: none;">
                    <div class="table-responsive">
                        <table class="table table-bordered table-hover table-striped">
                            <thead class="table-info">
                                <tr>
                                    <th>#</th>
                                    <th>Lisans No</th>
                                    <th>Doküman No</th>
                                    <th>Sözleşme Tipi</th>
                                    <th>Oluşturma Tarihi</th>
                                    <th>Yıllık Bakım</th>
                                    <th>Entegratör</th>
                                    <th>Ödeme Durumu</th>
                                    <th>Müşteri</th>
                                    <th>PDF Rapor</th>
                                </tr>
                            </thead>
                            <tbody id="sozlesmelerTablosu">
                                <!-- JS ile doldurulacak -->
                            </tbody>
                        </table>
                    </div>
                    <div id="sozlesmeYokMesaj" class="text-center text-muted py-5" style="display: none;">
                        <i class="fas fa-file-contract fa-3x mb-3"></i>
                        <p>Bu bayiye (veya alt bayilerine) ait müşterilerin sözleşmesi bulunamadı.</p>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Kapat</button>
            </div>
        </div>
    </div>
</div>

@section Script {
    <script type="text/javascript">
        // ============= GLOBAL DEĞİŞKENLER =============
        let currentBayiId = 0;
        let ekleYetkiliListesi = [];
        let duzenleYetkiliListesi = [];
        let secilenYetkiliId = 0;
        let mevcutLogoAdi = '';
        let mevcutImzaAdi = '';
        let currentDosyaTipi = '';

        // ============= DOSYA YÖNETİMİ FONKSİYONLARI =============

        // Dosya bilgilerini yükle
        function yukleDosyaBilgileri(bayiId) {
            if (!bayiId) return;

            fetch(`/AdminBayi/GetDosyaBilgisi?id=${bayiId}`)
                .then(r => r.json())
                .then(res => {
                    if (res.success) {
                        // Logo bilgilerini güncelle
                        if (res.logoVar && res.logoUzanti) {
                            mevcutLogoAdi = res.logoUzanti;
                            document.getElementById('mevcutLogoContainer').style.display = 'block';
                            document.getElementById('mevcutLogoImg').src = `/AdminBayi/LogoGoster/${bayiId}?t=${Date.now()}`;
                            document.getElementById('logoDurumBadge').className = 'badge bg-success';
                            document.getElementById('logoDurumBadge').textContent = 'Var';
                            document.getElementById('logoStat').className = 'badge bg-success';
                            document.getElementById('logoStat').textContent = 'Mevcut';
                        } else {
                            document.getElementById('mevcutLogoContainer').style.display = 'none';
                            document.getElementById('logoDurumBadge').className = 'badge bg-secondary';
                            document.getElementById('logoDurumBadge').textContent = 'Yok';
                            document.getElementById('logoStat').className = 'badge bg-secondary';
                            document.getElementById('logoStat').textContent = 'Yok';
                        }

                        // İmza bilgilerini güncelle
                        if (res.imzaVar && res.imzaUzanti) {
                            mevcutImzaAdi = res.imzaUzanti;
                            document.getElementById('mevcutImzaContainer').style.display = 'block';
                            document.getElementById('mevcutImzaImg').src = `/AdminBayi/ImzaGoster/${bayiId}?t=${Date.now()}`;
                            document.getElementById('imzaDurumBadge').className = 'badge bg-success';
                            document.getElementById('imzaDurumBadge').textContent = 'Var';
                            document.getElementById('imzaStat').className = 'badge bg-success';
                            document.getElementById('imzaStat').textContent = 'Mevcut';
                        } else {
                            document.getElementById('mevcutImzaContainer').style.display = 'none';
                            document.getElementById('imzaDurumBadge').className = 'badge bg-secondary';
                            document.getElementById('imzaDurumBadge').textContent = 'Yok';
                            document.getElementById('imzaStat').className = 'badge bg-secondary';
                            document.getElementById('imzaStat').textContent = 'Yok';
                        }

                        // İstatistikleri güncelle
                        guncelleDosyaIstatistikleri(res);
                    }
                })
                .catch(err => {
                    console.error('Dosya bilgileri yüklenemedi:', err);
                });
        }

        // Dosya istatistiklerini güncelle
        function guncelleDosyaIstatistikleri(data) {
            const toplamBoyut = (data.toplamBoyut || 0);
            const logoBoyut = (data.logoBoyut || 0);
            const imzaBoyut = (data.imzaBoyut || 0);

            // Boyut formatı
            function formatBoyut(bytes) {
                if (bytes === 0) return '0 B';
                const k = 1024;
                const sizes = ['B', 'KB', 'MB', 'GB'];
                const i = Math.floor(Math.log(bytes) / Math.log(k));
                return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
            }

            document.getElementById('toplamBoyut').textContent = formatBoyut(toplamBoyut);
            document.getElementById('sonGuncelleme').textContent = new Date().toLocaleDateString('tr-TR');
        }

        // Logo seçimi
        function handleLogoSelect(event) {
            handleFileSelect(event, 'logo');
        }

        // İmza seçimi
        function handleImzaSelect(event) {
            handleFileSelect(event, 'imza');
        }

        // Ekle modal için dosya seçimi
        function handleFileSelectEkle(event, tip) {
            const file = event.target.files[0];
            if (!file) return;

            if (!validateFile(file, tip)) {
                return;
            }

            createPreviewEkle(file, tip);
        }

        // Dosya seçimi (genel)
        function handleFileSelect(event, tip) {
            const file = event.target.files[0];
            if (!file) return;

            if (!validateFile(file, tip)) {
                return;
            }

            createPreview(file, tip);
            showFileInfo(file, tip);
            showProgressBar(tip);
            simulateUpload(tip);
        }

        // Dosya validasyonu
        function validateFile(file, tip) {
            const maxSize = 5 * 1024 * 1024; // 5MB
            const allowedTypes = ['image/jpeg', 'image/png', 'image/gif', 'image/bmp', 'image/webp'];

            if (file.size > maxSize) {
                alert(`${tip === 'logo' ? 'Logo' : 'İmza'} boyutu 5MB'tan büyük olamaz. Seçilen dosya: ${(file.size / 1024 / 1024).toFixed(2)}MB`);
                return false;
            }

            if (!allowedTypes.includes(file.type)) {
                alert(`${tip === 'logo' ? 'Logo' : 'İmza'} için sadece JPG, PNG, GIF, BMP ve WEBP dosyaları yüklenebilir.`);
                return false;
            }

            return true;
        }

        // Önizleme oluştur (ekle modal)
        function createPreviewEkle(file, tip) {
            const reader = new FileReader();
            const previewDiv = document.getElementById(`${tip}PreviewEkle`);

            reader.onload = function(e) {
                previewDiv.innerHTML = `
                    <div class="position-relative">
                        <button type="button" class="remove-file-btn" onclick="removePreviewEkle('${tip}')">
                            <i class="fas fa-times"></i>
                        </button>
                        <img src="${e.target.result}" class="img-fluid rounded" alt="${file.name}">
                        <div class="file-info">
                            <div><strong>${escapeHtml(file.name)}</strong></div>
                            <div>${(file.size / 1024).toFixed(2)} KB</div>
                        </div>
                    </div>
                `;
            };

            reader.readAsDataURL(file);
        }

        // Önizleme oluştur (düzenle modal)
        function createPreview(file, tip) {
            const reader = new FileReader();
            const previewDiv = document.getElementById(`${tip}Preview`);

            reader.onload = function(e) {
                previewDiv.innerHTML = `
                    <div class="position-relative">
                        <button type="button" class="remove-file-btn" onclick="removePreview('${tip}')">
                            <i class="fas fa-times"></i>
                        </button>
                        <img src="${e.target.result}" class="img-fluid rounded" alt="${file.name}">
                        <div class="file-info">
                            <div><strong>${escapeHtml(file.name)}</strong></div>
                            <div>${(file.size / 1024).toFixed(2)} KB</div>
                        </div>
                    </div>
                `;
            };

            reader.readAsDataURL(file);
        }

        // Dosya bilgisi göster
        function showFileInfo(file, tip) {
            const infoDiv = document.getElementById(`${tip}BilgiAlert`);
            const infoText = document.getElementById(`${tip}BilgiText`);

            const fileInfo = `
                Yeni ${tip === 'logo' ? 'logo' : 'imza'} seçildi:<br>
                <strong>${escapeHtml(file.name)}</strong> (${(file.size / 1024).toFixed(2)} KB)<br>
                ${file.type} - ${new Date(file.lastModified).toLocaleDateString('tr-TR')}
            `;

            infoText.innerHTML = fileInfo;
            infoDiv.style.display = 'block';
        }

        // Progress bar göster
        function showProgressBar(tip) {
            const progress = document.getElementById(`${tip}Progress`);
            const progressBar = document.getElementById(`${tip}ProgressBar`);

            progress.style.display = 'block';
            progressBar.style.width = '0%';
        }

        // Yükleme simülasyonu
        function simulateUpload(tip) {
            const progressBar = document.getElementById(`${tip}ProgressBar`);
            let width = 0;

            const interval = setInterval(() => {
                if (width >= 100) {
                    clearInterval(interval);
                    setTimeout(() => {
                        document.getElementById(`${tip}Progress`).style.display = 'none';
                        showSuccessMessage(tip);
                    }, 300);
                } else {
                    width += 10;
                    progressBar.style.width = width + '%';
                }
            }, 50);
        }

        // Başarı mesajı göster
        function showSuccessMessage(tip) {
            const infoDiv = document.getElementById(`${tip}BilgiAlert`);
            const oldHtml = infoDiv.innerHTML;

            infoDiv.className = 'alert alert-success mt-3';
            infoDiv.innerHTML = `
                <i class="fas fa-check-circle"></i>
                <strong>Başarılı!</strong> ${tip === 'logo' ? 'Logo' : 'İmza'} yüklendi.
                Formu göndererek kaydedebilirsiniz.
            `;

            setTimeout(() => {
                infoDiv.className = 'alert alert-info mt-3';
                infoDiv.innerHTML = oldHtml;
            }, 3000);
        }

        // Önizleme kaldır (ekle modal)
        function removePreviewEkle(tip) {
            const previewDiv = document.getElementById(`${tip}PreviewEkle`);
            const fileInput = document.getElementById(tip.charAt(0).toUpperCase() + tip.slice(1));

            previewDiv.innerHTML = '';
            fileInput.value = '';
        }

        // Önizleme kaldır (düzenle modal)
        function removePreview(tip) {
            const previewDiv = document.getElementById(`${tip}Preview`);
            const fileInput = document.getElementById(`edit${tip.charAt(0).toUpperCase() + tip.slice(1)}`);
            const infoDiv = document.getElementById(`${tip}BilgiAlert`);

            previewDiv.innerHTML = '';
            fileInput.value = '';
            infoDiv.style.display = 'none';
            document.getElementById(`${tip}Progress`).style.display = 'none';
        }

        // Drag & Drop desteği
        function handleDragOver(e) {
            e.preventDefault();
            e.stopPropagation();
            e.currentTarget.classList.add('dragover');
        }

        function handleDragLeave(e) {
            e.preventDefault();
            e.stopPropagation();
            e.currentTarget.classList.remove('dragover');
        }

        function handleDrop(e, tip) {
            e.preventDefault();
            e.stopPropagation();
            e.currentTarget.classList.remove('dragover');

            const files = e.dataTransfer.files;
            if (files.length > 0) {
                const fileInput = document.getElementById(`edit${tip.charAt(0).toUpperCase() + tip.slice(1)}`);
                const dataTransfer = new DataTransfer();
                dataTransfer.items.add(files[0]);
                fileInput.files = dataTransfer.files;

                // Trigger change event
                const event = new Event('change', { bubbles: true });
                fileInput.dispatchEvent(event);
            }
        }

        // Büyük göster
        function buyukGoster(tip) {
            const modal = new bootstrap.Modal(document.getElementById('buyukGosterModal'));
            const modalTitle = document.getElementById('buyukGosterModalLabel');
            const modalImg = document.getElementById('buyukGosterImg');

            if (tip === 'logo') {
                modalTitle.textContent = 'Logo Görüntüle';
                modalImg.src = document.getElementById('mevcutLogoImg').src;
                currentDosyaTipi = 'logo';
            } else {
                modalTitle.textContent = 'İmza Görüntüle';
                modalImg.src = document.getElementById('mevcutImzaImg').src;
                currentDosyaTipi = 'imza';
            }

            modal.show();
        }

        // İndir
        function indirBuyukResim() {
            if (currentDosyaTipi === 'logo') {
                indirLogo();
            } else {
                indirImza();
            }
            bootstrap.Modal.getInstance(document.getElementById('buyukGosterModal')).hide();
        }

        // Logo indir
        function indirLogo() {
            if (currentBayiId) {
                window.open(`/AdminBayi/LogoIndir/${currentBayiId}`, '_blank');
            }
        }

        // İmza indir
        function indirImza() {
            if (currentBayiId) {
                window.open(`/AdminBayi/ImzaIndir/${currentBayiId}`, '_blank');
            }
        }

        // Logo silme onay
        function silLogoOnay() {
            document.getElementById('silinecekDosyaAdi').textContent = 'Logo';
            currentDosyaTipi = 'logo';

            const modal = new bootstrap.Modal(document.getElementById('dosyaSilModal'));
            modal.show();

            // Silme butonuna event listener ekle
            const silBtn = document.getElementById('dosyaSilOnayBtn');
            silBtn.onclick = function() {
                silLogo();
                modal.hide();
            };
        }

        // İmza silme onay
        function silImzaOnay() {
            document.getElementById('silinecekDosyaAdi').textContent = 'İmza';
            currentDosyaTipi = 'imza';

            const modal = new bootstrap.Modal(document.getElementById('dosyaSilModal'));
            modal.show();

            // Silme butonuna event listener ekle
            const silBtn = document.getElementById('dosyaSilOnayBtn');
            silBtn.onclick = function() {
                silImza();
                modal.hide();
            };
        }

        // Logo sil
        function silLogo() {
            if (!currentBayiId) return;

            const formData = new FormData();
            formData.append('Id', currentBayiId);

            fetch('@Url.Action("SilLogo", "AdminBayi")', {
                method: 'POST',
                body: formData,
                headers: {
                    'RequestVerificationToken': document.querySelector('input[name="__RequestVerificationToken"]').value
                }
            })
            .then(response => {
                if (response.redirected) {
                    window.location.href = response.url;
                }
            })
            .catch(error => {
                console.error('Error:', error);
                alert('Logo silinirken bir hata oluştu.');
            });
        }

        // İmza sil
        function silImza() {
            if (!currentBayiId) return;

            const formData = new FormData();
            formData.append('Id', currentBayiId);

            fetch('@Url.Action("SilImza", "AdminBayi")', {
                method: 'POST',
                body: formData,
                headers: {
                    'RequestVerificationToken': document.querySelector('input[name="__RequestVerificationToken"]').value
                }
            })
            .then(response => {
                if (response.redirected) {
                    window.location.href = response.url;
                }
            })
            .catch(error => {
                console.error('Error:', error);
                alert('İmza silinirken bir hata oluştu.');
            });
        }

        // HTML Escape (XSS önlemi)
        function escapeHtml(text) {
            if (text === null || text === undefined) return '';
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        // ============= DETAY GETİR =============
        async function detayGetir(id) {
            try {
                const detayModal = document.getElementById('detayModal');
                const detayLoading = document.getElementById('detayLoading');
                const detayContent = document.getElementById('detayContent');

                if (!detayModal || !detayLoading || !detayContent) {
                    console.error('Modal elementleri bulunamadı');
                    alert('Sayfa yüklenirken bir hata oluştu. Lütfen sayfayı yenileyin.');
                    return;
                }

                detayLoading.style.display = 'block';
                detayContent.style.display = 'none';

                const res = await fetch('@Url.Action("DetayGetir", "AdminBayi")?id=' + id);
                const data = await res.json();

                if (!data.success) {
                    throw new Error(data.message || 'Bayi bulunamadı');
                }

       

                // Temel Bilgiler
                const detayTemelContent = document.getElementById('detayTemelContent');
                if (detayTemelContent) {
            let temelHtml = `
                <div class="col-md-6 detail-row">
                    <div class="detail-label">Ünvan</div>
                    <div class="detail-value">${escapeHtml(data.unvan)}</div>
                </div>
                <div class="col-md-6 detail-row">
                    <div class="detail-label">Kullanıcı Adı</div>
                    <div class="detail-value">${escapeHtml(data.kullaniciAdi)}</div>
                </div>
                <div class="col-md-6 detail-row">
                    <div class="detail-label">Bayi Kodu</div>
                    <div class="detail-value">${escapeHtml(data.kodu)}</div>
                </div>
                <div class="col-md-6 detail-row">
                    <div class="detail-label">Seviye</div>
                    <div class="detail-value">${data.seviye}</div>
                </div>
                <div class="col-md-6 detail-row">
                    <div class="detail-label">Üst Bayi</div>
                    <div class="detail-value">${escapeHtml(data.ustBayiAd)}</div>
                </div>
                <div class="col-md-6 detail-row">
                    <div class="detail-label">Distribütör</div>
                    <div class="detail-value">
                        <span class="badge ${data.distributor ? 'bg-success' : 'bg-secondary'}">
                            ${data.distributor ? 'Evet' : 'Hayır'}
                        </span>
                    </div>
                </div>
                <div class="col-md-6 detail-row">
                    <div class="detail-label">Eklenme Tarihi</div>
                    <div class="detail-value">${escapeHtml(data.eklenmeTarihi)}</div>
                </div>
                <div class="col-md-6 detail-row">
                    <div class="detail-label">Son Güncelleme</div>
                    <div class="detail-value">${escapeHtml(data.guncellenmeTarihi)}</div>
                </div>`;
            detayTemelContent.innerHTML = temelHtml;
        }

                // İletişim & Adres
                const detayIletisimContent = document.getElementById('detayIletisimContent');
                if (detayIletisimContent) {
                    let iletisimHtml = `
                        <div class="col-md-6 detail-row">
                            <div class="detail-label">Email</div>
                            <div class="detail-value">${escapeHtml(data.email) || '-'}</div>
                        </div>
                        <div class="col-md-6 detail-row">
                            <div class="detail-label">Telefon</div>
                            <div class="detail-value">${escapeHtml(data.telefon) || '-'}</div>
                        </div>
                        <div class="col-md-6 detail-row">
                            <div class="detail-label">Bölge</div>
                            <div class="detail-value">${escapeHtml(data.bolge) || '-'}</div>
                        </div>
                        <div class="col-md-6 detail-row">
                            <div class="detail-label">İl</div>
                            <div class="detail-value">${escapeHtml(data.il) || '-'}</div>
                        </div>
                        <div class="col-md-6 detail-row">
                            <div class="detail-label">İlçe</div>
                            <div class="detail-value">${escapeHtml(data.ilce) || '-'}</div>
                        </div>
                        <div class="col-md-6 detail-row">
                            <div class="detail-label">Belde</div>
                            <div class="detail-value">${escapeHtml(data.belde) || '-'}</div>
                        </div>
                        <div class="col-12 detail-row">
                            <div class="detail-label">Adres</div>
                            <div class="detail-value">${escapeHtml(data.adres) || '-'}</div>
                        </div>`;
                    detayIletisimContent.innerHTML = iletisimHtml;
                }

                // Vergi & Resmi
                const detayVergiContent = document.getElementById('detayVergiContent');
                if (detayVergiContent) {
                    let vergiHtml = `
                        <div class="col-md-6 detail-row">
                            <div class="detail-label">TC/Vergi No</div>
                            <div class="detail-value">${escapeHtml(data.tcvNo) || '-'}</div>
                        </div>
                        <div class="col-md-6 detail-row">
                            <div class="detail-label">Vergi Dairesi</div>
                            <div class="detail-value">${escapeHtml(data.vergiDairesi) || '-'}</div>
                        </div>
                        <div class="col-md-6 detail-row">
                            <div class="detail-label">KEP Adresi</div>
                            <div class="detail-value">${escapeHtml(data.kepAdresi) || '-'}</div>
                        </div>
                        <div class="col-md-6 detail-row">
                            <div class="detail-label">Web Adresi</div>
                            <div class="detail-value">${escapeHtml(data.webAdresi) || '-'}</div>
                        </div>
                        <div class="col-12 detail-row">
                            <div class="detail-label">Açıklama</div>
                            <div class="detail-value">${escapeHtml(data.aciklama) || '-'}</div>
                        </div>`;
                    detayVergiContent.innerHTML = vergiHtml;
                }

                // Alpemix
                const detayAlpemixContent = document.getElementById('detayAlpemixContent');
                if (detayAlpemixContent) {
                    let alpemixHtml = `
                        <div class="col-md-6 detail-row">
                            <div class="detail-label">Alpemix Firma Adı</div>
                            <div class="detail-value">${escapeHtml(data.alpemixFirmaAdi) || '-'}</div>
                        </div>
                        <div class="col-md-6 detail-row">
                            <div class="detail-label">Alpemix Grup Adı</div>
                            <div class="detail-value">${escapeHtml(data.alpemixGrupAdi) || '-'}</div>
                        </div>
                        <div class="col-12 detail-row">
                            <div class="detail-label">Alpemix Şifre</div>
                            <div class="detail-value">${escapeHtml(data.alpemixSifre) || '-'}</div>
                        </div>`;
                    detayAlpemixContent.innerHTML = alpemixHtml;
                }

                // Dosyalar
                const detayDosyalarContent = document.getElementById('detayDosyalarContent');
                if (detayDosyalarContent) {
                    let dosyalarHtml = `
                        <div class="row">
                            <div class="col-md-6">
                                <div class="card">
                                    <div class="card-header bg-primary text-white">
                                        <i class="fas fa-image"></i> Logo
                                    </div>
                                    <div class="card-body text-center">
                                        ${data.logoUzanti ?
                                            `<img src="/AdminBayi/LogoGoster/${data.id}" class="img-fluid rounded border"
                                                 style="max-height: 200px; object-fit: contain;">
                                            <div class="mt-3">
                                                <button type="button" class="btn btn-sm btn-info" onclick="window.open('/AdminBayi/LogoIndir/${data.id}', '_blank')">
                                                    <i class="fas fa-download"></i> İndir
                                                </button>
                                            </div>` :
                                            '<div class="text-muted py-4"><i class="fas fa-ban fa-2x"></i><br>Logo yok</div>'}
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="card">
                                    <div class="card-header bg-success text-white">
                                        <i class="fas fa-signature"></i> İmza
                                    </div>
                                    <div class="card-body text-center">
                                        ${data.imzaUzanti ?
                                            `<img src="/AdminBayi/ImzaGoster/${data.id}" class="img-fluid rounded border"
                                                 style="max-height: 200px; object-fit: contain;">
                                            <div class="mt-3">
                                                <button type="button" class="btn btn-sm btn-info" onclick="window.open('/AdminBayi/ImzaIndir/${data.id}', '_blank')">
                                                    <i class="fas fa-download"></i> İndir
                                                </button>
                                            </div>` :
                                            '<div class="text-muted py-4"><i class="fas fa-ban fa-2x"></i><br>İmza yok</div>'}
                                    </div>
                                </div>
                            </div>
                        </div>`;
                    detayDosyalarContent.innerHTML = dosyalarHtml;
                }

                // Sözleşme dokümanlarını yükle
                yukleBayiSozlesmeDokumanlari(id);

                // Müşterileri yükle
                yukleBayiMusterileri(id);

                // Yetkilileri yükle
                yukleDetayBayiYetkilileri(id);

                detayLoading.style.display = 'none';
                detayContent.style.display = 'block';

                const modal = new bootstrap.Modal(detayModal);
                modal.show();

            } catch (err) {
                console.error('Detay yüklenirken hata:', err);
                alert('Bayi detayları yüklenirken bir hata oluştu: ' + err.message);

                const detayLoading = document.getElementById('detayLoading');
                if (detayLoading) {
                    detayLoading.style.display = 'none';
                }
            }
        }

        // Bayiye ait müşterileri yükle (detay modalı için)
        function yukleBayiMusterileri(bayiId) {
            if (!bayiId) return;

            fetch(`/AdminBayi/GetBayiMusterileri?bayiId=${bayiId}`)
                .then(r => r.json())
                .then(res => {
                    const tbody = document.querySelector('#detayMusterilerTablosu tbody');
                    if (!tbody) return;

                    if (!res.success || !res.data || res.data.length === 0) {
                        tbody.innerHTML = '<tr><td colspan="10" class="text-center text-muted py-4">Bu bayiye ait müşteri bulunamadı.</td></tr>';
                        return;
                    }

                    let rows = '';
                    res.data.forEach((m, index) => {
                        rows += `
                            <tr>
                                <td>${index + 1}</td>
                                <td>${escapeHtml(m.adSoyad)}</td>
                                <td>${escapeHtml(m.ticariUnvan || '-')}</td>
                                <td>${escapeHtml(m.kullaniciAdi)}</td>
                                <td>${escapeHtml(m.email || '-')}</td>
                                <td>${escapeHtml(m.telefon || '-')}</td>
                                <td>${escapeHtml(m.tcvNo || '-')}</td>
                                <td>${escapeHtml(m.musteriTipAdi)}</td>
                                <td>${escapeHtml(m.bayiAd)}</td>
                                <td>${escapeHtml(m.eklenmeTarihi)}</td>
                            </tr>`;
                    });
                    tbody.innerHTML = rows;
                })
                .catch(err => {
                    console.error('Müşteriler yüklenirken hata:', err);
                    const tbody = document.querySelector('#detayMusterilerTablosu tbody');
                    if (tbody) tbody.innerHTML = '<tr><td colspan="10" class="text-danger text-center">Müşteriler yüklenirken hata oluştu.</td></tr>';
                });
        }

        // Detay modalı için bayi yetkililerini yükle
        function yukleDetayBayiYetkilileri(bayiId) {
            if (!bayiId) return;

            fetch(`/AdminBayi/GetBayiYetkililer?bayiId=${bayiId}`)
                .then(r => r.json())
                .then(res => {
                    const tbody = document.querySelector('#detayYetkililerTablosu tbody');
                    if (!tbody) return;

                    if (!res.success || !res.data || res.data.length === 0) {
                        tbody.innerHTML = '<tr><td colspan="8" class="text-center text-muted">Yetkili yok</td></tr>';
                        return;
                    }

                    let rows = '';
                    res.data.forEach(y => {
                        rows += `
                            <tr>
                                <td>${escapeHtml(y.kodu || '-')}</td>
                                <td>${escapeHtml(y.adi)}</td>
                                <td>${escapeHtml(y.soyadi)}</td>
                                <td>${escapeHtml(y.gorevi || '-')}</td>
                                <td>${escapeHtml(y.departmanAdi || '-')}</td>
                                <td>${escapeHtml(y.email || '-')}</td>
                                <td>${escapeHtml(y.cep || '-')}</td>
                                <td><span class="aktif-badge aktif-${y.aktif}">${y.aktif === 1 ? 'Aktif' : 'Pasif'}</span></td>
                            </tr>`;
                    });
                    tbody.innerHTML = rows;
                })
                .catch(err => {
                    console.error("Yetkili yükleme hatası:", err);
                    const tbody = document.querySelector('#detayYetkililerTablosu tbody');
                    if (tbody) tbody.innerHTML = '<tr><td colspan="8" class="text-danger text-center">Yetkililer yüklenirken hata oluştu.</td></tr>';
                });
        }

         // Bayi sözleşme dokümanlarını yükle (detay modalı için) - GÜNCELLENMİŞ VERSİYON
        function yukleBayiSozlesmeDokumanlari(bayiId) {
            if (!bayiId) return;
            fetch(`/AdminBayi/GetBayiSozlesmeDokumanlari?bayiId=${bayiId}`)
                .then(r => r.json())
                .then(res => {
                    const container = document.getElementById('detaySozlesmelerContent');
                    if (!container) return;

                    if (!res.success || !res.data || res.data.length === 0) {
                        container.innerHTML = `
                            <div class="col-12">
                                <div class="alert alert-info text-center py-5">
                                    <i class="fas fa-file-contract fa-3x mb-3 text-info"></i>
                                    <h5>Henüz Sözleşme Dokümanı Yok</h5>
                                    <p class="mb-0">Bu bayi ve alt bayilerine ait müşterilerin sözleşme dokümanı bulunmamaktadır.</p>
                                </div>
                            </div>`;
                        return;
                    }

                    let html = '<div class="col-12"><h5 class="mb-4">Bayi ve Alt Bayilerine Ait Müşterilerin Sözleşme Dokümanları</h5><div class="row">';

                    res.data.forEach(dokuman => {
                        const dosyaSayisi =
                            (dokuman.vergiKimlikLevhasiVar ? 1 : 0) +
                            (dokuman.ticariSicilGazetesiVar ? 1 : 0) +
                            (dokuman.kimlikOnYuzuVar ? 1 : 0) +
                            (dokuman.imzaSirkusuVar ? 1 : 0);

                        html += `
                            <div class="col-md-6 col-lg-4 mb-4">
                                <div class="card h-100 shadow-sm border-0 hover-lift">
                                    <div class="card-header bg-gradient-primary text-white">
                                        <div class="d-flex justify-content-between align-items-center">
                                            <strong class="text-truncate" title="${escapeHtml(dokuman.dokumanNo)}">
                                                ${escapeHtml(dokuman.dokumanNo)}
                                            </strong>
                                            <span class="badge bg-light text-dark">${dosyaSayisi} Dosya</span>
                                        </div>
                                    </div>
                                    <div class="card-body">
                                        <div class="small text-muted mb-2">Müşteri:</div>
                                        <div class="fw-bold mb-2">${escapeHtml(dokuman.musteriAdi)}</div>
                                        <div class="small text-muted mb-1">Lisans No:</div>
                                        <div class="mb-2">${escapeHtml(dokuman.lisansNo || '-')}</div>
                                        <div class="small text-muted mb-1">Tip:</div>
                                        <div class="mb-3">${escapeHtml(dokuman.sozlesmeTipi || '-')}</div>

                                        <div class="d-flex flex-wrap gap-2">
                                            ${dokuman.vergiKimlikLevhasiVar ?
                                                `<a href="/AdminBayi/SozlesmeDosyaGoster?sozlesmeId=${dokuman.id}&tip=vergi" target="_blank" class="btn btn-sm btn-outline-primary" title="Vergi Kimlik Levhası Görüntüle">
                                                    <i class="fas fa-eye"></i>
                                                </a>
                                                <a href="/AdminBayi/SozlesmeDosyaIndir?sozlesmeId=${dokuman.id}&tip=vergi" class="btn btn-sm btn-outline-success" title="Vergi Kimlik Levhası İndir">
                                                    <i class="fas fa-download"></i>
                                                </a>` : ''}

                                            ${dokuman.ticariSicilGazetesiVar ?
                                                `<a href="/AdminBayi/SozlesmeDosyaGoster?sozlesmeId=${dokuman.id}&tip=sicil" target="_blank" class="btn btn-sm btn-outline-primary" title="Ticari Sicil Gazetesi Görüntüle">
                                                    <i class="fas fa-newspaper"></i>
                                                </a>
                                                <a href="/AdminBayi/SozlesmeDosyaIndir?sozlesmeId=${dokuman.id}&tip=sicil" class="btn btn-sm btn-outline-success" title="Ticari Sicil Gazetesi İndir">
                                                    <i class="fas fa-download"></i>
                                                </a>` : ''}

                                            ${dokuman.kimlikOnYuzuVar ?
                                                `<a href="/AdminBayi/SozlesmeDosyaGoster?sozlesmeId=${dokuman.id}&tip=kimlik" target="_blank" class="btn btn-sm btn-outline-primary" title="Kimlik Ön Yüzü Görüntüle">
                                                    <i class="fas fa-id-card"></i>
                                                </a>
                                                <a href="/AdminBayi/SozlesmeDosyaIndir?sozlesmeId=${dokuman.id}&tip=kimlik" class="btn btn-sm btn-outline-success" title="Kimlik Ön Yüzü İndir">
                                                    <i class="fas fa-download"></i>
                                                </a>` : ''}

                                            ${dokuman.imzaSirkusuVar ?
                                                `<a href="/AdminBayi/SozlesmeDosyaGoster?sozlesmeId=${dokuman.id}&tip=imza" target="_blank" class="btn btn-sm btn-outline-primary" title="İmza Sirküsü Görüntüle">
                                                    <i class="fas fa-signature"></i>
                                                </a>
                                                <a href="/AdminBayi/SozlesmeDosyaIndir?sozlesmeId=${dokuman.id}&tip=imza" class="btn btn-sm btn-outline-success" title="İmza Sirküsü İndir">
                                                    <i class="fas fa-download"></i>
                                                </a>` : ''}
                                        </div>
                                    </div>
                                    <div class="card-footer bg-light text-muted small">
                                        <div class="d-flex justify-content-between">
                                            <span>${escapeHtml(dokuman.eklenmeTarihi)}</span>
                                            <span title="Oluşturma: ${escapeHtml(dokuman.olusturmaTarihi)}">
                                                ${escapeHtml(dokuman.musteriTicariUnvan || '')}
                                            </span>
                                        </div>
                                    </div>
                                </div>
                            </div>`;
                    });

                    html += '</div></div>';
                    container.innerHTML = html;
                })
                .catch(err => {
                    console.error('Bayi sözleşme dokümanları yüklenirken hata:', err);
                    const container = document.getElementById('detaySozlesmelerContent');
                    if (container) {
                        container.innerHTML = `
                            <div class="col-12">
                                <div class="alert alert-danger text-center py-4">
                                    <i class="fas fa-exclamation-triangle fa-2x mb-3"></i>
                                    <h5>Yüklenirken Hata Oluştu</h5>
                                    <p class="mb-0">Sözleşme dokümanları yüklenirken bir hata oluştu.</p>
                                </div>
                            </div>`;
                    }
                });
        }

        // Sözleşme doküman detay modalı
        function sozlesmeDokumanDetay(dokumanId) {
            fetch(`/AdminBayi/GetSozlesmeDokumanDetay?id=${dokumanId}`)
                .then(r => r.json())
                .then(res => {
                    if (!res.success || !res.data) {
                        alert('Doküman detayları yüklenemedi.');
                        return;
                    }

                    const dokuman = res.data;

                    // Detay modalı oluştur
                    const modalHtml = `
                        <div class="modal fade" id="sozlesmeDokumanModal" tabindex="-1">
                            <div class="modal-dialog modal-lg">
                                <div class="modal-content">
                                    <div class="modal-header bg-primary text-white">
                                        <h5 class="modal-title">Sözleşme Doküman Detayı</h5>
                                        <button type="button" class="btn-close text-white" data-bs-dismiss="modal"></button>
                                    </div>
                                    <div class="modal-body">
                                        <div class="row">
                                            <div class="col-md-6">
                                                <div class="mb-3">
                                                    <label class="form-label fw-bold">Doküman No</label>
                                                    <p class="form-control-plaintext">${escapeHtml(dokuman.dokumanNo)}</p>
                                                </div>
                                                <div class="mb-3">
                                                    <label class="form-label fw-bold">Lisans No</label>
                                                    <p class="form-control-plaintext">${escapeHtml(dokuman.lisansNo)}</p>
                                                </div>
                                                <div class="mb-3">
                                                    <label class="form-label fw-bold">Sözleşme Tipi</label>
                                                    <p class="form-control-plaintext">${escapeHtml(dokuman.sozlesmeTipi)}</p>
                                                </div>
                                                <div class="mb-3">
                                                    <label class="form-label fw-bold">Müşteri</label>
                                                    <p class="form-control-plaintext">${escapeHtml(dokuman.musteriAdi)}</p>
                                                </div>
                                                <div class="mb-3">
                                                    <label class="form-label fw-bold">Entegratör</label>
                                                    <p class="form-control-plaintext">${escapeHtml(dokuman.entegratorAdi || '-')}</p>
                                                </div>
                                            </div>
                                            <div class="col-md-6">
                                                <div class="mb-3">
                                                    <label class="form-label fw-bold">Yayın Tarihi</label>
                                                    <p class="form-control-plaintext">${escapeHtml(dokuman.yayinTarihi)}</p>
                                                </div>
                                                <div class="mb-3">
                                                    <label class="form-label fw-bold">Revizyon Tarihi</label>
                                                    <p class="form-control-plaintext">${escapeHtml(dokuman.revizeTarihi)}</p>
                                                </div>
                                                <div class="mb-3">
                                                    <label class="form-label fw-bold">Revizyon No</label>
                                                    <p class="form-control-plaintext">${escapeHtml(dokuman.revizyonNo || '0')}</p>
                                                </div>
                                                <div class="mb-3">
                                                    <label class="form-label fw-bold">Durum</label>
                                                    <p class="form-control-plaintext">
                                                        <span class="badge ${dokuman.sozlesmeDurumu === 'Aktif' ? 'bg-success' : 'bg-secondary'}">
                                                            ${escapeHtml(dokuman.sozlesmeDurumu)}
                                                        </span>
                                                    </p>
                                                </div>
                                                <div class="mb-3">
                                                    <label class="form-label fw-bold">Yıllık Bakım</label>
                                                    <p class="form-control-plaintext">${parseFloat(dokuman.yillikBakim).toLocaleString('tr-TR', { minimumFractionDigits: 2, maximumFractionDigits: 2 })} TL</p>
                                                </div>
                                            </div>
                                        </div>

                                        <hr>

                                        <div class="row">
                                            <div class="col-12">
                                                <h6 class="fw-bold mb-3">Doküman Dosyaları</h6>
                                                <div class="row">
                                                    ${dokuman.vergiKimlikLevhasıDosyaAdi ?
                                                        `<div class="col-md-6 mb-3">
                                                            <div class="card">
                                                                <div class="card-header bg-success text-white">
                                                                    <i class="fas fa-file-alt me-2"></i> Vergi Kimlik Levhası
                                                                </div>
                                                                <div class="card-body">
                                                                    <p class="mb-2"><strong>Dosya:</strong> ${escapeHtml(dokuman.vergiKimlikLevhasıDosyaAdi)}</p>
                                                                    <div class="d-flex gap-2">
                                                                        <button class="btn btn-sm btn-outline-primary" onclick="goruntuleSozlesmeDokumanDosya('${dokuman.dokumanNo}', 'vergiKimlik')">
                                                                            <i class="fas fa-eye"></i> Görüntüle
                                                                        </button>
                                                                        <button class="btn btn-sm btn-outline-success" onclick="indirSozlesmeDokumanDosya('${dokuman.dokumanNo}', 'vergiKimlik')">
                                                                            <i class="fas fa-download"></i> İndir
                                                                        </button>
                                                                    </div>
                                                                </div>
                                                            </div>
                                                        </div>` : ''}

                                                    ${dokuman.ticariSicilGazetesiDosyaAdi ?
                                                        `<div class="col-md-6 mb-3">
                                                            <div class="card">
                                                                <div class="card-header bg-info text-white">
                                                                    <i class="fas fa-file-contract me-2"></i> Ticari Sicil Gazetesi
                                                                </div>
                                                                <div class="card-body">
                                                                    <p class="mb-2"><strong>Dosya:</strong> ${escapeHtml(dokuman.ticariSicilGazetesiDosyaAdi)}</p>
                                                                    <div class="d-flex gap-2">
                                                                        <button class="btn btn-sm btn-outline-primary" onclick="goruntuleSozlesmeDokumanDosya('${dokuman.dokumanNo}', 'ticariSicil')">
                                                                            <i class="fas fa-eye"></i> Görüntüle
                                                                        </button>
                                                                        <button class="btn btn-sm btn-outline-success" onclick="indirSozlesmeDokumanDosya('${dokuman.dokumanNo}', 'ticariSicil')">
                                                                            <i class="fas fa-download"></i> İndir
                                                                        </button>
                                                                    </div>
                                                                </div>
                                                            </div>
                                                        </div>` : ''}

                                                    ${dokuman.kimlikOnYuzuDosyaAdi ?
                                                        `<div class="col-md-6 mb-3">
                                                            <div class="card">
                                                                <div class="card-header bg-warning text-dark">
                                                                    <i class="fas fa-id-card me-2"></i> Kimlik Ön Yüzü
                                                                </div>
                                                                <div class="card-body">
                                                                    <p class="mb-2"><strong>Dosya:</strong> ${escapeHtml(dokuman.kimlikOnYuzuDosyaAdi)}</p>
                                                                    <div class="d-flex gap-2">
                                                                        <button class="btn btn-sm btn-outline-primary" onclick="goruntuleSozlesmeDokumanDosya('${dokuman.dokumanNo}', 'kimlik')">
                                                                            <i class="fas fa-eye"></i> Görüntüle
                                                                        </button>
                                                                        <button class="btn btn-sm btn-outline-success" onclick="indirSozlesmeDokumanDosya('${dokuman.dokumanNo}', 'kimlik')">
                                                                            <i class="fas fa-download"></i> İndir
                                                                        </button>
                                                                    </div>
                                                                </div>
                                                            </div>
                                                        </div>` : ''}

                                                    ${dokuman.imzaSirkusuDosyaAdi ?
                                                        `<div class="col-md-6 mb-3">
                                                            <div class="card">
                                                                <div class="card-header bg-danger text-white">
                                                                    <i class="fas fa-signature me-2"></i> İmza Sirküsü
                                                                </div>
                                                                <div class="card-body">
                                                                    <p class="mb-2"><strong>Dosya:</strong> ${escapeHtml(dokuman.imzaSirkusuDosyaAdi)}</p>
                                                                    <div class="d-flex gap-2">
                                                                        <button class="btn btn-sm btn-outline-primary" onclick="goruntuleSozlesmeDokumanDosya('${dokuman.dokumanNo}', 'imza')">
                                                                            <i class="fas fa-eye"></i> Görüntüle
                                                                        </button>
                                                                        <button class="btn btn-sm btn-outline-success" onclick="indirSozlesmeDokumanDosya('${dokuman.dokumanNo}', 'imza')">
                                                                            <i class="fas fa-download"></i> İndir
                                                                        </button>
                                                                    </div>
                                                                </div>
                                                            </div>
                                                        </div>` : ''}

                                                    ${dokuman.dosyaAdi ?
                                                        `<div class="col-md-6 mb-3">
                                                            <div class="card">
                                                                <div class="card-header bg-primary text-white">
                                                                    <i class="fas fa-file-pdf me-2"></i> Sözleşme PDF
                                                                </div>
                                                                <div class="card-body">
                                                                    <p class="mb-2"><strong>Dosya:</strong> ${escapeHtml(dokuman.dosyaAdi)}</p>
                                                                    <div class="d-flex gap-2">
                                                                        <button class="btn btn-sm btn-outline-primary" onclick="goruntuleSozlesmeDokumanDosya('${dokuman.dokumanNo}', 'pdf')">
                                                                            <i class="fas fa-eye"></i> Görüntüle
                                                                        </button>
                                                                        <button class="btn btn-sm btn-outline-success" onclick="indirSozlesmeDokumanDosya('${dokuman.dokumanNo}', 'pdf')">
                                                                            <i class="fas fa-download"></i> İndir
                                                                        </button>
                                                                    </div>
                                                                </div>
                                                            </div>
                                                        </div>` : ''}

                                                    ${!dokuman.vergiKimlikLevhasıDosyaAdi && !dokuman.ticariSicilGazetesiDosyaAdi &&
                                                      !dokuman.kimlikOnYuzuDosyaAdi && !dokuman.imzaSirkusuDosyaAdi &&
                                                      !dokuman.dosyaAdi ?
                                                        `<div class="col-12">
                                                            <div class="alert alert-info text-center py-3">
                                                                <i class="fas fa-info-circle me-2"></i>
                                                                Bu sözleşme için dosya yüklenmemiş.
                                                            </div>
                                                        </div>` : ''}
                                                </div>
                                            </div>
                                        </div>

                                        <hr>

                                        <div class="row">
                                            <div class="col-12">
                                                <h6 class="fw-bold mb-3">Bilgilendirme Tercihleri</h6>
                                                <div class="row">
                                                    <div class="col-md-3">
                                                        <div class="form-check">
                                                            <input class="form-check-input" type="checkbox" ${dokuman.smsBilgilendirme ? 'checked' : ''} disabled>
                                                            <label class="form-check-label">SMS</label>
                                                        </div>
                                                    </div>
                                                    <div class="col-md-3">
                                                        <div class="form-check">
                                                            <input class="form-check-input" type="checkbox" ${dokuman.emailBilgilendirme ? 'checked' : ''} disabled>
                                                            <label class="form-check-label">E-posta</label>
                                                        </div>
                                                    </div>
                                                    <div class="col-md-3">
                                                        <div class="form-check">
                                                            <input class="form-check-input" type="checkbox" ${dokuman.telefonBilgilendirme ? 'checked' : ''} disabled>
                                                            <label class="form-check-label">Telefon</label>
                                                        </div>
                                                    </div>
                                                    <div class="col-md-3">
                                                        <div class="form-check">
                                                            <input class="form-check-input" type="checkbox" ${dokuman.haberPaylasimi ? 'checked' : ''} disabled>
                                                            <label class="form-check-label">Haber Paylaşımı</label>
                                                        </div>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="modal-footer">
                                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Kapat</button>
                                        <button type="button" class="btn btn-primary" onclick="window.print()">
                                            <i class="fas fa-print"></i> Yazdır
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>`;

                    // Modal'ı DOM'a ekle ve göster
                    const existingModal = document.getElementById('sozlesmeDokumanModal');
                    if (existingModal) {
                        existingModal.remove();
                    }

                    document.body.insertAdjacentHTML('beforeend', modalHtml);
                    const modal = new bootstrap.Modal(document.getElementById('sozlesmeDokumanModal'));
                    modal.show();
                })
                .catch(err => {
                    console.error('Doküman detay yüklenirken hata:', err);
                    alert('Doküman detayları yüklenirken bir hata oluştu.');
                });
        }

        // Sözleşme doküman dosyasını görüntüle
        function goruntuleSozlesmeDokumanDosya(dokumanNo, tip) {
            let url = '';
            let baslik = '';

            switch(tip) {
                case 'vergiKimlik':
                    url = `/AdminBayi/GoruntuleVergiKimlikDosya?dokumanNo=${encodeURIComponent(dokumanNo)}`;
                    baslik = 'Vergi Kimlik Levhası';
                    break;
                case 'ticariSicil':
                    url = `/AdminBayi/GoruntuleTicariSicilDosya?dokumanNo=${encodeURIComponent(dokumanNo)}`;
                    baslik = 'Ticari Sicil Gazetesi';
                    break;
                case 'kimlik':
                    url = `/AdminBayi/GoruntuleKimlikDosya?dokumanNo=${encodeURIComponent(dokumanNo)}`;
                    baslik = 'Kimlik Ön Yüzü';
                    break;
                case 'imza':
                    url = `/AdminBayi/GoruntuleImzaSirkusuDosya?dokumanNo=${encodeURIComponent(dokumanNo)}`;
                    baslik = 'İmza Sirküsü';
                    break;
                case 'pdf':
                    url = `/AdminBayi/GoruntuleSozlesmePdf?dokumanNo=${encodeURIComponent(dokumanNo)}`;
                    baslik = 'Sözleşme PDF';
                    break;
            }

            if (url) {
                window.open(url, '_blank', 'width=800,height=600');
            }
        }

        // Sözleşme doküman dosyasını indir
        function indirSozlesmeDokumanDosya(dokumanNo, tip) {
            let url = '';

            switch(tip) {
                case 'vergiKimlik':
                    url = `/AdminBayi/IndirVergiKimlikDosya?dokumanNo=${encodeURIComponent(dokumanNo)}`;
                    break;
                case 'ticariSicil':
                    url = `/AdminBayi/IndirTicariSicilDosya?dokumanNo=${encodeURIComponent(dokumanNo)}`;
                    break;
                case 'kimlik':
                    url = `/AdminBayi/IndirKimlikDosya?dokumanNo=${encodeURIComponent(dokumanNo)}`;
                    break;
                case 'imza':
                    url = `/AdminBayi/IndirImzaSirkusuDosya?dokumanNo=${encodeURIComponent(dokumanNo)}`;
                    break;
                case 'pdf':
                    url = `/AdminBayi/IndirSozlesmePdf?dokumanNo=${encodeURIComponent(dokumanNo)}`;
                    break;
            }

            if (url) {
                window.open(url, '_blank');
            }
        }

        // ============= DÜZENLE GETİR =============
        async function duzenleGetir(id) {
            try {
                currentBayiId = id;

                const duzenleModal = document.getElementById('duzenleModal');
                const duzenleLoading = document.getElementById('duzenleLoading');
                const duzenleContent = document.getElementById('duzenleContent');

                if (!duzenleModal || !duzenleLoading || !duzenleContent) {
                    console.error('Modal elementleri bulunamadı');
                    alert('Sayfa yüklenirken bir hata oluştu. Lütfen sayfayı yenileyin.');
                    return;
                }

                duzenleLoading.style.display = 'block';
                duzenleContent.style.display = 'none';

                const res = await fetch('@Url.Action("DetayGetir", "AdminBayi")?id=' + id);
                const data = await res.json();

                if (!data.success) {
                    throw new Error(data.message || 'Bayi bulunamadı');
                }

                // Form alanlarını doldur
                document.getElementById('editId').value = data.id;
                document.getElementById('editUnvan').value = escapeHtml(data.unvan);
                document.getElementById('editKullaniciAdi').value = escapeHtml(data.kullaniciAdi);
                document.getElementById('editKodu').value = escapeHtml(data.kodu);
                document.getElementById('editUstBayiId').value = data.ustBayiId;
                        document.getElementById('editDistributor').checked = data.distributor; // YENİ ALAN


                document.getElementById('editEmail').value = escapeHtml(data.email);
                document.getElementById('editTelefon').value = escapeHtml(data.telefon);
                document.getElementById('editBolge').value = escapeHtml(data.bolge);
                document.getElementById('editIl').value = escapeHtml(data.il);
                document.getElementById('editIlce').value = escapeHtml(data.ilce);
                document.getElementById('editBelde').value = escapeHtml(data.belde);
                document.getElementById('editAdres').value = escapeHtml(data.adres);

                document.getElementById('editTCVNo').value = escapeHtml(data.tcvNo);
                document.getElementById('editVergiDairesi').value = escapeHtml(data.vergiDairesi);
                document.getElementById('editKepAdresi').value = escapeHtml(data.kepAdresi);
                document.getElementById('editWebAdresi').value = escapeHtml(data.webAdresi);
                document.getElementById('editAciklama').value = escapeHtml(data.aciklama);

                document.getElementById('editAlpemixFirmaAdi').value = escapeHtml(data.alpemixFirmaAdi);
                document.getElementById('editAlpemixGrupAdi').value = escapeHtml(data.alpemixGrupAdi);
                document.getElementById('editAlpemixSifre').value = escapeHtml(data.alpemixSifre);

                // Dosya bilgilerini yükle
                yukleDosyaBilgileri(id);

                // Yetkilileri yükle
                yukleBayiYetkilileri(id);

                // İçerik göster
                duzenleLoading.style.display = 'none';
                duzenleContent.style.display = 'block';

                const modal = new bootstrap.Modal(duzenleModal);
                modal.show();

            } catch (err) {
                console.error('Düzenleme verisi yüklenirken hata:', err);
                alert('Bayi bilgileri yüklenirken bir hata oluştu: ' + err.message);

                if (duzenleLoading) {
                    duzenleLoading.style.display = 'none';
                }
            }
        }

        // Bayi yetkililerini yükle (düzenle modalı için)
        function yukleBayiYetkilileri(bayiId) {
            if (!bayiId) return;

            fetch(`/AdminBayi/GetBayiYetkililer?bayiId=${bayiId}`)
                .then(r => r.json())
                .then(res => {
                    const tbody = document.querySelector('#bayiYetkililerTablosu tbody');
                    if (!tbody) return;

                    if (!res.success || !res.data || res.data.length === 0) {
                        tbody.innerHTML = '<tr><td colspan="9" class="text-center text-muted py-4">Yetkili bulunamadı.</td></tr>';
                        return;
                    }

                    let rows = '';
                    res.data.forEach(y => {
                        rows += `
                            <tr data-yetkili-id="${y.id}">
                                <td>${escapeHtml(y.kodu || '-')}</td>
                                <td>${escapeHtml(y.adi)}</td>
                                <td>${escapeHtml(y.soyadi)}</td>
                                <td>${escapeHtml(y.gorevi || '-')}</td>
                                <td>${escapeHtml(y.departmanAdi || '-')}</td>
                                <td>${escapeHtml(y.email || '-')}</td>
                                <td>${escapeHtml(y.cep || '-')}</td>
                                <td>
                                    <span class="aktif-badge aktif-${y.aktif}">
                                        ${y.aktif === 1 ? 'Aktif' : 'Pasif'}
                                    </span>
                                </td>
                                <td>
                                    <button class="btn btn-sm btn-outline-warning" onclick="duzenleYetkili(${y.id})" title="Düzenle">
                                        <i class="fas fa-edit"></i>
                                    </button>
                                    <button class="btn btn-sm btn-outline-danger" onclick="silYetkiliOnay(${y.id})" title="Sil">
                                        <i class="fas fa-trash"></i>
                                    </button>
                                </td>
                            </tr>`;
                    });
                    tbody.innerHTML = rows;
                })
                .catch(err => {
                    console.error('Yetkililer yüklenirken hata:', err);
                    const tbody = document.querySelector('#bayiYetkililerTablosu tbody');
                    if (tbody) tbody.innerHTML = '<tr><td colspan="9" class="text-danger text-center">Yetkililer yüklenirken hata oluştu.</td></tr>';
                });
        }

        // ============= YETKİLİ YÖNETİMİ =============

        // Yeni yetkili ekle (ekle modal)
        function yeniYetkiliEkleModal() {
            // Departmanları yükle
            fetch('/AdminBayi/GetDepartmanlar')
                .then(r => r.json())
                .then(res => {
                    if (res.success) {
                        const select = document.getElementById('yetkiliDuzenleDepartmanSelect');
                        select.innerHTML = '<option value="">Seçiniz</option>';
                        res.data.forEach(dept => {
                            select.innerHTML += `<option value="${dept.id}">${escapeHtml(dept.ad)}</option>`;
                        });
                    }
                });

            // Formu temizle
            document.getElementById('yetkiliDuzenleAdi').value = '';
            document.getElementById('yetkiliDuzenleSoyadi').value = '';
            document.getElementById('yetkiliDuzenleGorevi').value = '';
            document.getElementById('yetkiliDuzenleEmail').value = '';
            document.getElementById('yetkiliDuzenleCep').value = '';
            document.getElementById('yetkiliDuzenleDahiliNo').value = '';
            document.getElementById('yetkiliDuzenleKodu').value = '';
            document.getElementById('yetkiliDuzenleAktif').checked = true;
            document.getElementById('yetkiliDuzenleCinsiyet').value = '';

            // Modal başlığını değiştir
            document.querySelector('#yetkiliDuzenleModal .modal-title').textContent = 'Yeni Yetkili Ekle';
            document.querySelector('#yetkiliDuzenleModal .btn-success').textContent = 'Ekle';
            document.querySelector('#yetkiliDuzenleModal .btn-success').onclick = kaydetYeniYetkiliEkle;

            const modal = new bootstrap.Modal(document.getElementById('yetkiliDuzenleModal'));
            modal.show();
        }

        // Yeni yetkili ekle (ekle modal için)
        function kaydetYeniYetkiliEkle() {
            const adi = document.getElementById('yetkiliDuzenleAdi').value.trim();
            const soyadi = document.getElementById('yetkiliDuzenleSoyadi').value.trim();

            if (!adi || !soyadi) {
                alert('Adı ve soyadı alanları zorunludur.');
                return;
            }

            const yetkili = {
                adi: adi,
                soyadi: soyadi,
                gorevi: document.getElementById('yetkiliDuzenleGorevi').value.trim(),
                departmanId: document.getElementById('yetkiliDuzenleDepartmanSelect').value,
                email: document.getElementById('yetkiliDuzenleEmail').value.trim(),
                cep: document.getElementById('yetkiliDuzenleCep').value.trim(),
                dahiliNo: document.getElementById('yetkiliDuzenleDahiliNo').value.trim(),
                kodu: document.getElementById('yetkiliDuzenleKodu').value.trim(),
                aktif: document.getElementById('yetkiliDuzenleAktif').checked ? 1 : 0,
                cinsiyet: document.getElementById('yetkiliDuzenleCinsiyet').value
            };

            // Liste kontrolü
            if (!Array.isArray(ekleYetkiliListesi)) {
                ekleYetkiliListesi = [];
            }

            // ID ata
            const tempId = Date.now();
            yetkili.tempId = tempId;

            // Listeye ekle
            ekleYetkiliListesi.push(yetkili);

            // Listeyi güncelle
            guncelleEkleYetkiliListesi();

            // Modal'ı kapat
            bootstrap.Modal.getInstance(document.getElementById('yetkiliDuzenleModal')).hide();

            // Bilgilendirme
            showToast('success', 'Yetkili eklendi', 'Yeni yetkili listeye eklendi. Formu göndererek kaydedebilirsiniz.');
        }

        // Ekle modal için yetkili listesini güncelle
        function guncelleEkleYetkiliListesi() {
            const container = document.getElementById('ekleYetkiliListesi');
            if (!container) return;

            if (!ekleYetkiliListesi || ekleYetkiliListesi.length === 0) {
                container.innerHTML = '<div class="alert alert-info text-center">Henüz yetkili eklenmedi. Yeni yetkili eklemek için butona tıklayın.</div>';
                return;
            }

            let html = '<div class="table-responsive"><table class="table table-sm table-bordered table-hover"><thead><tr>';
            html += '<th>Adı Soyadı</th><th>Görevi</th><th>Departman</th><th>Email</th><th>Cep</th><th>Durum</th><th>İşlem</th></tr></thead><tbody>';

            ekleYetkiliListesi.forEach((y, index) => {
                html += `<tr data-temp-id="${y.tempId}">
                    <td>${escapeHtml(y.adi)} ${escapeHtml(y.soyadi)}</td>
                    <td>${escapeHtml(y.gorevi || '-')}</td>
                    <td>${escapeHtml(y.departmanId ? 'Seçildi' : '-')}</td>
                    <td>${escapeHtml(y.email || '-')}</td>
                    <td>${escapeHtml(y.cep || '-')}</td>
                    <td><span class="aktif-badge aktif-${y.aktif}">${y.aktif === 1 ? 'Aktif' : 'Pasif'}</span></td>
                    <td>
                        <button class="btn btn-sm btn-outline-danger" onclick="silEkleYetkili(${y.tempId})" title="Sil">
                            <i class="fas fa-trash"></i>
                        </button>
                    </td>
                </tr>`;
            });

            html += '</tbody></table></div>';
            container.innerHTML = html;

            // Hidden input olarak form'a ekle
            const existingInputs = document.querySelectorAll('input[name="YetkililerJson"]');
            existingInputs.forEach(input => input.remove());

            const hiddenInput = document.createElement('input');
            hiddenInput.type = 'hidden';
            hiddenInput.name = 'YetkililerJson';
            hiddenInput.value = JSON.stringify(ekleYetkiliListesi);
            document.getElementById('ekleForm').appendChild(hiddenInput);
        }

        // Ekle modal için yetkili sil
        function silEkleYetkili(tempId) {
            if (confirm('Bu yetkiliyi silmek istediğinizden emin misiniz?')) {
                ekleYetkiliListesi = ekleYetkiliListesi.filter(y => y.tempId !== tempId);
                guncelleEkleYetkiliListesi();
                showToast('success', 'Silindi', 'Yetkili listeden silindi.');
            }
        }

        // Düzenle modal için yeni yetkili ekleme
        function yeniYetkiliEkleModalDuzenleToplu() {
            // Departmanları yükle
            fetch('/AdminBayi/GetDepartmanlar')
                .then(r => r.json())
                .then(res => {
                    if (res.success) {
                        const select = document.getElementById('yetkiliDuzenleDepartmanSelect');
                        select.innerHTML = '<option value="">Seçiniz</option>';
                        res.data.forEach(dept => {
                            select.innerHTML += `<option value="${dept.id}">${escapeHtml(dept.ad)}</option>`;
                        });
                    }
                });

            // Formu temizle
            document.getElementById('yetkiliDuzenleAdi').value = '';
            document.getElementById('yetkiliDuzenleSoyadi').value = '';
            document.getElementById('yetkiliDuzenleGorevi').value = '';
            document.getElementById('yetkiliDuzenleEmail').value = '';
            document.getElementById('yetkiliDuzenleCep').value = '';
            document.getElementById('yetkiliDuzenleDahiliNo').value = '';
            document.getElementById('yetkiliDuzenleKodu').value = '';
            document.getElementById('yetkiliDuzenleAktif').checked = true;
            document.getElementById('yetkiliDuzenleCinsiyet').value = '';

            // Modal başlığını değiştir
            document.querySelector('#yetkiliDuzenleModal .modal-title').textContent = 'Yeni Yetkili Ekle';
            document.querySelector('#yetkiliDuzenleModal .btn-success').textContent = 'Ekle';
            document.querySelector('#yetkiliDuzenleModal .btn-success').onclick = kaydetYeniYetkiliDuzenleToplu;

            const modal = new bootstrap.Modal(document.getElementById('yetkiliDuzenleModal'));
            modal.show();
        }

        // Düzenle modal için yeni yetkili kaydet
        function kaydetYeniYetkiliDuzenleToplu() {
            const adi = document.getElementById('yetkiliDuzenleAdi').value.trim();
            const soyadi = document.getElementById('yetkiliDuzenleSoyadi').value.trim();

            if (!adi || !soyadi) {
                alert('Adı ve soyadı alanları zorunludur.');
                return;
            }

            const yetkili = {
                adi: adi,
                soyadi: soyadi,
                gorevi: document.getElementById('yetkiliDuzenleGorevi').value.trim(),
                departmanId: document.getElementById('yetkiliDuzenleDepartmanSelect').value,
                email: document.getElementById('yetkiliDuzenleEmail').value.trim(),
                cep: document.getElementById('yetkiliDuzenleCep').value.trim(),
                dahiliNo: document.getElementById('yetkiliDuzenleDahiliNo').value.trim(),
                kodu: document.getElementById('yetkiliDuzenleKodu').value.trim(),
                aktif: document.getElementById('yetkiliDuzenleAktif').checked ? 1 : 0,
                cinsiyet: document.getElementById('yetkiliDuzenleCinsiyet').value,
                bayiId: currentBayiId
            };

            // Veritabanına kaydet
            fetch('@Url.Action("EkleYetkili", "AdminBayi")', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'RequestVerificationToken': document.querySelector('input[name="__RequestVerificationToken"]').value
                },
                body: JSON.stringify(yetkili)
            })
            .then(r => r.json())
            .then(res => {
                if (res.success) {
                    // Yetkilileri yeniden yükle
                    yukleBayiYetkilileri(currentBayiId);

                    // Modal'ı kapat
                    bootstrap.Modal.getInstance(document.getElementById('yetkiliDuzenleModal')).hide();

                    showToast('success', 'Başarılı', 'Yeni yetkili eklendi.');
                } else {
                    alert('Hata: ' + (res.message || 'Yetkili eklenemedi.'));
                }
            })
            .catch(err => {
                console.error('Yetkili ekleme hatası:', err);
                alert('Yetkili eklenirken bir hata oluştu.');
            });
        }

        // Mevcut yetkiliyi düzenle
        function duzenleYetkili(yetkiliId) {
            secilenYetkiliId = yetkiliId;

            // Yetkili bilgilerini getir
            fetch(`/AdminBayi/GetYetkiliDetay?id=${yetkiliId}`)
                .then(r => r.json())
                .then(res => {
                    if (res.success) {
                        const data = res.data;

                        // Formu doldur
                        document.getElementById('yetkiliDuzenleAdi').value = escapeHtml(data.adi);
                        document.getElementById('yetkiliDuzenleSoyadi').value = escapeHtml(data.soyadi);
                        document.getElementById('yetkiliDuzenleGorevi').value = escapeHtml(data.gorevi || '');
                        document.getElementById('yetkiliDuzenleEmail').value = escapeHtml(data.email || '');
                        document.getElementById('yetkiliDuzenleCep').value = escapeHtml(data.cep || '');
                        document.getElementById('yetkiliDuzenleDahiliNo').value = escapeHtml(data.dahiliNo || '');
                        document.getElementById('yetkiliDuzenleKodu').value = escapeHtml(data.kodu || '');
                        document.getElementById('yetkiliDuzenleAktif').checked = data.aktif === 1;
                        document.getElementById('yetkiliDuzenleCinsiyet').value = escapeHtml(data.cinsiyet || '');

                        // Departmanları yükle ve seçili yap
                        return fetch('/AdminBayi/GetDepartmanlar');
                    } else {
                        throw new Error('Yetkili bulunamadı');
                    }
                })
                .then(r => r.json())
                .then(res => {
                    if (res.success) {
                        const select = document.getElementById('yetkiliDuzenleDepartmanSelect');
                        select.innerHTML = '<option value="">Seçiniz</option>';
                        res.data.forEach(dept => {
                            select.innerHTML += `<option value="${dept.id}">${escapeHtml(dept.ad)}</option>`;
                        });

                        // Departman ID'sini ayarla (API'den alınan veriye göre)
                        // Örnek: select.value = data.departmanId;
                    }
                })
                .then(() => {
                    // Modal başlığını değiştir
                    document.querySelector('#yetkiliDuzenleModal .modal-title').textContent = 'Yetkili Düzenle';
                    document.querySelector('#yetkiliDuzenleModal .btn-success').textContent = 'Güncelle';
                    document.querySelector('#yetkiliDuzenleModal .btn-success').onclick = kaydetYetkiliDuzenle;

                    const modal = new bootstrap.Modal(document.getElementById('yetkiliDuzenleModal'));
                    modal.show();
                })
                .catch(err => {
                    console.error('Yetkili yükleme hatası:', err);
                    alert('Yetkili bilgileri yüklenirken bir hata oluştu.');
                });
        }

        // Yetkili düzenlemeyi kaydet
        function kaydetYetkiliDuzenle() {
            const adi = document.getElementById('yetkiliDuzenleAdi').value.trim();
            const soyadi = document.getElementById('yetkiliDuzenleSoyadi').value.trim();

            if (!adi || !soyadi) {
                alert('Adı ve soyadı alanları zorunludur.');
                return;
            }

            const yetkiliData = {
                id: secilenYetkiliId,
                adi: adi,
                soyadi: soyadi,
                gorevi: document.getElementById('yetkiliDuzenleGorevi').value.trim(),
                departmanId: document.getElementById('yetkiliDuzenleDepartmanSelect').value,
                email: document.getElementById('yetkiliDuzenleEmail').value.trim(),
                cep: document.getElementById('yetkiliDuzenleCep').value.trim(),
                dahiliNo: document.getElementById('yetkiliDuzenleDahiliNo').value.trim(),
                kodu: document.getElementById('yetkiliDuzenleKodu').value.trim(),
                aktif: document.getElementById('yetkiliDuzenleAktif').checked ? 1 : 0,
                cinsiyet: document.getElementById('yetkiliDuzenleCinsiyet').value
            };

            fetch('@Url.Action("GuncelleYetkili", "AdminBayi")', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'RequestVerificationToken': document.querySelector('input[name="__RequestVerificationToken"]').value
                },
                body: JSON.stringify(yetkiliData)
            })
            .then(r => r.json())
            .then(res => {
                if (res.success) {
                    // Yetkilileri yeniden yükle
                    yukleBayiYetkilileri(currentBayiId);

                    // Modal'ı kapat
                    bootstrap.Modal.getInstance(document.getElementById('yetkiliDuzenleModal')).hide();

                    showToast('success', 'Başarılı', 'Yetkili bilgileri güncellendi.');
                } else {
                    alert('Hata: ' + (res.message || 'Yetkili güncellenemedi.'));
                }
            })
            .catch(err => {
                console.error('Yetkili güncelleme hatası:', err);
                alert('Yetkili güncellenirken bir hata oluştu.');
            });
        }

        // Yetkili silme onayı
        function silYetkiliOnay(yetkiliId) {
            if (confirm('Bu yetkiliyi silmek istediğinizden emin misiniz?\n\nBu işlem geri alınamaz.')) {
                silYetkili(yetkiliId);
            }
        }

        // Yetkili sil
        function silYetkili(yetkiliId) {
            fetch('@Url.Action("SilYetkili", "AdminBayi")', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'RequestVerificationToken': document.querySelector('input[name="__RequestVerificationToken"]').value
                },
                body: JSON.stringify({ id: yetkiliId })
            })
            .then(r => r.json())
            .then(res => {
                if (res.success) {
                    // Tabloyu yeniden yükle
                    yukleBayiYetkilileri(currentBayiId);
                    showToast('success', 'Silindi', 'Yetkili başarıyla silindi.');
                } else {
                    alert('Hata: ' + (res.message || 'Yetkili silinemedi.'));
                }
            })
            .catch(err => {
                console.error('Yetkili silme hatası:', err);
                alert('Yetkili silinirken bir hata oluştu.');
            });
        }

        // ============= TEKLİF VE SÖZLEŞME İŞLEMLERİ =============

        // Bayi tekliflerini getir
        function bayiTeklifleriGetir(bayiId) {
            currentBayiId = bayiId;

            const modal = new bootstrap.Modal(document.getElementById('musteriTeklifleriModal'));
            const loading = document.getElementById('tekliflerLoading');
            const content = document.getElementById('tekliflerContent');
            const tablo = document.getElementById('tekliflerTablosu');
            const yokMesaj = document.getElementById('teklifYokMesaj');

            // Yükleme durumunu ayarla
            loading.style.display = 'block';
            content.style.display = 'none';
            yokMesaj.style.display = 'none';
            tablo.innerHTML = '';

            // Modal başlığını güncelle
            fetch(`/AdminBayi/GetBayiAdi?id=${bayiId}`)
                .then(r => r.json())
                .then(res => {
                    if (res.success) {
                        document.getElementById('musteriTeklifAdi').textContent =
                            `"${escapeHtml(res.ad)}" Bayisine Ait Müşterilerin`;
                    }
                });

            // Teklifleri getir
            fetch(`/AdminBayi/GetBayiMusteriTeklifleri?bayiId=${bayiId}`)
                .then(r => r.json())
                .then(res => {
                    loading.style.display = 'none';

                    if (res.success && res.data && res.data.length > 0) {
                        content.style.display = 'block';

                        let rows = '';
                        res.data.forEach((t, index) => {
                            rows += `
                                <tr>
                                    <td>${index + 1}</td>
                                    <td><strong>${escapeHtml(t.teklifNo)}</strong></td>
                                    <td>${escapeHtml(t.olusturmaTarihi)}</td>
                                    <td>${escapeHtml(t.gecerlilikTarihi)}</td>
                                    <td>${escapeHtml(t.lisansTipi)}</td>
                                    <td>
                                        <span class="badge ${t.durum === 'Onaylandı' ? 'bg-success' : t.durum === 'Beklemede' ? 'bg-warning' : 'bg-secondary'}">
                                            ${escapeHtml(t.durum)}
                                        </span>
                                    </td>
                                    <td>
                                        <span class="badge ${t.onayDurumu === 'Evet' ? 'bg-success' : 'bg-danger'}">
                                            ${escapeHtml(t.onayDurumu)}
                                        </span>
                                    </td>
                                    <td class="text-end">${parseFloat(t.netToplam).toLocaleString('tr-TR', { minimumFractionDigits: 2, maximumFractionDigits: 2 })} TL</td>
                                    <td>${escapeHtml(t.musteriAdi)}</td>
                                    <td>
                                        <button class="btn btn-sm btn-outline-primary" onclick="window.open('/AdminBayi/TeklifPdfIndir/${t.id}', '_blank')">
                                            <i class="fas fa-file-pdf"></i> PDF
                                        </button>
                                    </td>
                                </tr>`;
                        });
                        tablo.innerHTML = rows;
                    } else {
                        yokMesaj.style.display = 'block';
                    }
                })
                .catch(err => {
                    console.error('Teklifler yüklenirken hata:', err);
                    loading.style.display = 'none';
                    yokMesaj.style.display = 'block';
                    yokMesaj.innerHTML = `
                        <i class="fas fa-exclamation-triangle fa-3x mb-3 text-danger"></i>
                        <p class="text-danger">Teklifler yüklenirken bir hata oluştu.</p>
                        <p class="small">${err.message}</p>
                    `;
                });

            modal.show();
        }

        // Bayi sözleşmelerini getir
        function bayiSozlesmeleriGetir(bayiId) {
            currentBayiId = bayiId;

            const modal = new bootstrap.Modal(document.getElementById('musteriSozlesmeleriModal'));
            const loading = document.getElementById('sozlesmelerLoading');
            const content = document.getElementById('sozlesmelerContent');
            const tablo = document.getElementById('sozlesmelerTablosu');
            const yokMesaj = document.getElementById('sozlesmeYokMesaj');

            // Yükleme durumunu ayarla
            loading.style.display = 'block';
            content.style.display = 'none';
            yokMesaj.style.display = 'none';
            tablo.innerHTML = '';

            // Modal başlığını güncelle
            fetch(`/AdminBayi/GetBayiAdi?id=${bayiId}`)
                .then(r => r.json())
                .then(res => {
                    if (res.success) {
                        document.getElementById('musteriSozlesmeAdi').textContent =
                            `"${escapeHtml(res.ad)}" Bayisine Ait Müşterilerin`;
                    }
                });

            // Sözleşmeleri getir
            fetch(`/AdminBayi/GetBayiMusteriSozlesmeleri?bayiId=${bayiId}`)
                .then(r => r.json())
                .then(res => {
                    loading.style.display = 'none';

                    if (res.success && res.data && res.data.length > 0) {
                        content.style.display = 'block';

                        let rows = '';
                        res.data.forEach((s, index) => {
                            rows += `
                                <tr>
                                    <td>${index + 1}</td>
                                    <td><strong>${escapeHtml(s.lisansNo)}</strong></td>
                                    <td>${escapeHtml(s.dokumanNo)}</td>
                                    <td>${escapeHtml(s.sozlesmeTipi)}</td>
                                    <td>${escapeHtml(s.olusturmaTarihi)}</td>
                                    <td>
                                        <span class="badge ${s.yillikBakim ? 'bg-success' : 'bg-secondary'}">
                                            ${s.yillikBakim ? 'Var' : 'Yok'}
                                        </span>
                                    </td>
                                    <td>${escapeHtml(s.entegrator || '-')}</td>
                                    <td>
                                        <span class="badge ${s.odemeDurumu === 'Ödendi' ? 'bg-success' : s.odemeDurumu === 'Kısmen Ödendi' ? 'bg-warning' : 'bg-danger'}">
                                            ${escapeHtml(s.odemeDurumu)}
                                        </span>
                                    </td>
                                    <td>${escapeHtml(s.musteriAdi)}</td>
                                    <td>
                                        <button class="btn btn-sm btn-outline-primary" onclick="window.open('/AdminBayi/SozlesmePdfIndir/${s.id}', '_blank')">
                                            <i class="fas fa-file-pdf"></i> PDF
                                        </button>
                                    </td>
                                </tr>`;
                        });
                        tablo.innerHTML = rows;
                    } else {
                        yokMesaj.style.display = 'block';
                    }
                })
                .catch(err => {
                    console.error('Sözleşmeler yüklenirken hata:', err);
                    loading.style.display = 'none';
                    yokMesaj.style.display = 'block';
                    yokMesaj.innerHTML = `
                        <i class="fas fa-exclamation-triangle fa-3x mb-3 text-danger"></i>
                        <p class="text-danger">Sözleşmeler yüklenirken bir hata oluştu.</p>
                        <p class="small">${err.message}</p>
                    `;
                });

            modal.show();
        }

        // ============= DİĞER İŞLEMLER =============

        // Silme onayı
        function silOnay(id, ad) {
            document.getElementById('silId').value = id;
            document.getElementById('silAdi').textContent = ad;

            const modal = new bootstrap.Modal(document.getElementById('silModal'));
            modal.show();
        }

        // Toast mesajı göster
        function showToast(type, title, message) {
            // Basit bir alert yerine daha güzel bir bildirim gösterebilirsiniz
            // Bu örnek için basit alert kullanıyoruz
            alert(`${title}: ${message}`);
        }

        // Sayfa yüklendiğinde çalışacak kodlar
        document.addEventListener('DOMContentLoaded', function() {
            // Arama işlevselliği
            const aramaInput = document.getElementById('bayiAramaInput');
            const aramaTemizle = document.getElementById('bayiAramaTemizle');
            const bayiTablosu = document.getElementById('bayiTablosu');

            if (aramaInput && bayiTablosu) {
                aramaInput.addEventListener('keyup', function() {
                    const filter = this.value.toLowerCase();
                    const rows = bayiTablosu.getElementsByTagName('tr');
                    let anyVisible = false;

                    for (let i = 1; i < rows.length; i++) { // 0 = başlık satırı
                        const row = rows[i];
                        const text = row.textContent.toLowerCase();
                        if (text.includes(filter)) {
                            row.style.display = '';
                            anyVisible = true;
                        } else {
                            row.style.display = 'none';
                        }
                    }

                    // Temizle butonunu göster/gizle
                    if (aramaTemizle) {
                        aramaTemizle.style.display = filter ? 'block' : 'none';
                    }

                    // Arama sonuçları yoksa mesaj göster
                    if (!anyVisible && rows.length > 1) {
                        const tbody = bayiTablosu.getElementsByTagName('tbody')[0];
                        if (!tbody.querySelector('.arama-bos-mesaj')) {
                            const tr = document.createElement('tr');
                            tr.className = 'arama-bos-mesaj';
                            tr.innerHTML = `<td colspan="12" class="text-center py-4">
                                <i class="fas fa-search fa-2x mb-2 text-muted"></i>
                                <p class="mb-1">"${escapeHtml(filter)}" ile eşleşen bayi bulunamadı.</p>
                                <p class="small text-muted">Farklı bir anahtar kelime deneyin.</p>
                            </td>`;
                            tbody.appendChild(tr);
                        }
                    } else {
                        const bosMesaj = bayiTablosu.querySelector('.arama-bos-mesaj');
                        if (bosMesaj) {
                            bosMesaj.remove();
                        }
                    }
                });

                // Temizle butonu
                if (aramaTemizle) {
                    aramaTemizle.addEventListener('click', function() {
                        aramaInput.value = '';
                        aramaInput.dispatchEvent(new Event('keyup'));
                        aramaTemizle.style.display = 'none';
                        aramaInput.focus();
                    });
                }
            }

            // Form doğrulama
            const ekleForm = document.getElementById('ekleForm');
            const duzenleForm = document.getElementById('duzenleForm');

            if (ekleForm) {
                ekleForm.addEventListener('submit', function(e) {
                    const kullaniciAdi = document.getElementById('KullaniciAdi').value.trim();
                    const sifre = document.getElementById('Sifre').value.trim();

                    if (!kullaniciAdi || !sifre) {
                        e.preventDefault();
                        alert('Kullanıcı adı ve şifre alanları zorunludur.');
                        return;
                    }

                    // Şifre güvenlik kontrolü (isteğe bağlı)
                    if (sifre.length < 6) {
                        e.preventDefault();
                        alert('Şifre en az 6 karakter olmalıdır.');
                        return;
                    }

                    // Yetkili listesi kontrolü
                    if (ekleYetkiliListesi && ekleYetkiliListesi.length > 0) {
                        const jsonInput = document.createElement('input');
                        jsonInput.type = 'hidden';
                        jsonInput.name = 'YetkililerJson';
                        jsonInput.value = JSON.stringify(ekleYetkiliListesi);
                        this.appendChild(jsonInput);
                    }
                });
            }

            if (duzenleForm) {
                duzenleForm.addEventListener('submit', function(e) {
                    const kullaniciAdi = document.getElementById('editKullaniciAdi').value.trim();

                    if (!kullaniciAdi) {
                        e.preventDefault();
                        alert('Kullanıcı adı alanı zorunludur.');
                        return;
                    }
                });
            }

            // Aktif/pasif switch için event listener
            const aktifSwitch = document.getElementById('yetkiliDuzenleAktif');
            if (aktifSwitch) {
                aktifSwitch.addEventListener('change', function() {
                    document.getElementById('aktifText').textContent = this.checked ? 'Aktif' : 'Pasif';
                });
            }

            // Hiyerarşi sayfası için ağaç yapısını oluştur
            if (typeof bayiSemasiData !== 'undefined') {
                renderTree(bayiSemasiData);
            }
        });

        // Hiyerarşi ağacı render
        function renderTree(data) {
            const treeRoot = document.getElementById('tree-root');
            if (!treeRoot || !data) return;

            treeRoot.innerHTML = buildTreeHtml(data);
        }

        function buildTreeHtml(node) {
            if (!node) return '';

            const seviyeClass = `seviye-${Math.min(node.seviye || 0, 4)}`;
            const seviyeBadge = node.seviye > 0 ? `<span class="seviye-badge">${node.seviye}</span>` : '';

            let html = `
                <div class="tree-item">
                    <div class="tree-node ${seviyeClass}" onclick="detayGetir(${node.id})">
                        ${seviyeBadge}
                        <div class="fw-bold">${escapeHtml(node.unvan)}</div>
                        <div class="small mt-1">${escapeHtml(node.kodu || '')}</div>
                        <div class="small text-muted">${escapeHtml(node.telefon || '')}</div>
                        ${node.altBayiSayisi > 0 ?
                            `<div class="small mt-1">
                                <span class="badge bg-info">${node.altBayiSayisi} Alt Bayi</span>
                            </div>` : ''}
                    </div>`;

            if (node.children && node.children.length > 0) {
                html += `<div class="tree-children">`;
                node.children.forEach(child => {
                    html += buildTreeHtml(child);
                });
                html += `</div>`;
            }

            html += `</div>`;
            return html;
        }
    </script>
}
